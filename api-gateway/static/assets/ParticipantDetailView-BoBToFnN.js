import{N as H,m as g,O as Q,p as te,r as m,c as R,o as s,d as t,x as V,P as _t,w as e,u as C,Q as vt,K as yt,z as gt,B as b,F as K,H as Ce,v as y,f as _,C as Z,a as p,E as A,q as Be,e as qe,R as Ge,I as Re,J as pe,S as wt,T as Ne,k as Ie,U as Te,g as Le,V as bt,W as Ue,X as Fe,h as Oe,Y as he,Z as Pe,M as ht,_ as kt,$ as Ct,n as ze,a0 as Rt,t as Dt,a1 as Et,G as $t}from"./index-kxVL1b-K.js";import{A as Mt}from"./AppLayout-jSRVv2Cn.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as St,m as ce,g as xt,p as At}from"./metricNames-DIZIUuuZ.js";import{p as ke,u as Vt}from"./participants-CArk9PWJ.js";const ve={async upload(r,k){const l=new FormData;return l.append("file",k),(await H.post(`/participants/${r}/reports`,l,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(r){return await H.get(`/reports/${r}/download`,{responseType:"blob"})},async getById(r){return(await H.get(`/reports/${r}`)).data},async delete(r){return(await H.delete(`/reports/${r}`)).data},async extract(r){return(await H.post(`/reports/${r}/extract`)).data},async getMetrics(r){return(await H.get(`/reports/${r}/metrics`)).data},async getList(r){return(await H.get(`/participants/${r}/reports`)).data}},be={async calculate(r,k){return(await H.post(`/scoring/participants/${r}/calculate`,null,{params:{activity_code:k}})).data},async getHistory(r,k=10){return(await H.get(`/scoring/participants/${r}/scores`,{params:{limit:k}})).data},async getById(r){return(await H.get(`/scoring-results/${r}`)).data},async generateRecommendations(r){return(await H.post(`/reports/${r}/recommendations`)).data},async getFinalReport(r,k,l="json"){const E={params:{activity_code:k,format:l}};l==="html"&&(E.responseType="text");const I=await H.get(`/participants/${r}/final-report`,E);return I.data},async downloadFinalReportPdf(r,k){return await H.get(`/participants/${r}/final-report`,{params:{activity_code:k,format:"pdf"},responseType:"blob"})}};function ye(r,k=1){if(r==null||r==="")return"";const l=typeof r=="string"?parseFloat(r):r;return isNaN(l)?"":l.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function oe(r){if(r==null||r==="")return null;const l=String(r).trim().replace(",","."),E=parseFloat(l);return isNaN(E)?null:E}function Nt(r){return oe(r)}function de(r,k=1){return ye(r,k)}const It={key:0,class:"error-message"},Tt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(r,{emit:k}){const l=r,E=k,I=g(null),x=g(""),L=g(!1),$=g(!1),M=g(""),D=Q(()=>oe(x.value)),S=Q(()=>{const u=D.value;return u===null||u<=l.min}),q=Q(()=>{const u=D.value;return u===null||u>=l.max}),P=u=>{if(u==null||u===""){x.value="";return}L.value?x.value=String(u).replace(".",","):x.value=ye(u,l.precision)},G=u=>{if(u==null||u==="")return $.value=!1,M.value="",!0;const o=oe(u);return o===null?($.value=!0,M.value="Некорректное число",!1):o<l.min?($.value=!0,M.value=`Значение должно быть не меньше ${ye(l.min,l.precision)}`,!1):o>l.max?($.value=!0,M.value=`Значение должно быть не больше ${ye(l.max,l.precision)}`,!1):($.value=!1,M.value="",!0)},h=u=>{const o=u.replace(/[^\d,.-]/g,"");let w=!1;const c=o.split("").filter(v=>v===","||v==="."?w?!1:(w=!0,!0):!0).join("").replace(".",",");x.value=c;const i=oe(c);i!==null?E("update:modelValue",i):(c===""||c==="-")&&E("update:modelValue",null)},U=()=>{L.value=!1;const u=oe(x.value);if(G(x.value)){if(u!==null){const o=Math.round(u*Math.pow(10,l.precision))/Math.pow(10,l.precision),w=Math.max(l.min,Math.min(l.max,o));E("update:modelValue",w),P(w),E("change",w)}}else if(u!==null&&(u<l.min||u>l.max)){const o=Math.max(l.min,Math.min(l.max,u));E("update:modelValue",o),P(o),E("change",o),$.value=!1,M.value=""}E("blur")},j=()=>{L.value=!0,D.value!==null&&(x.value=String(D.value).replace(".",","))},B=()=>{const u=D.value||0,o=Math.min(l.max,u+l.step),w=Math.round(o*Math.pow(10,l.precision))/Math.pow(10,l.precision);E("update:modelValue",w),E("change",w),P(w)},N=()=>{const u=D.value||0,o=Math.max(l.min,u-l.step),w=Math.round(o*Math.pow(10,l.precision))/Math.pow(10,l.precision);E("update:modelValue",w),E("change",w),P(w)};return te(()=>l.modelValue,u=>{P(u)},{immediate:!0}),P(l.modelValue),(u,o)=>{const w=m("el-button"),c=m("el-button-group"),i=m("el-input");return s(),R(K,null,[t(i,{ref_key:"inputRef",ref:I,modelValue:x.value,"onUpdate:modelValue":o[0]||(o[0]=v=>x.value=v),placeholder:r.placeholder,disabled:r.disabled,class:gt({"is-invalid":$.value}),onInput:h,onBlur:U,onFocus:j},_t({_:2},[r.showControls?{name:"append",fn:e(()=>[t(c,null,{default:e(()=>[t(w,{icon:C(vt),disabled:r.disabled||S.value,onClick:N},null,8,["icon","disabled"]),t(w,{icon:C(yt),disabled:r.disabled||q.value,onClick:B},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),$.value?(s(),R("div",It,b(M.value),1)):V("",!0)],64)}}},Lt=me(Tt,[["__scopeId","data-v-74ef628d"]]),Ut={class:"card-header"},Ft={key:1},Ot={key:0,class:"metric-description"},Pt={key:2,class:"metrics-info"},zt={class:"info-row"},Bt={key:0,class:"info-row"},qt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(r,{emit:k}){const l=r,E=k,I=g(!1),x=g(!1),L=g(!1),$=g(null),M=g([]),D=g([]),S=g({metrics:{}}),q=g({}),P=Q(()=>!D.value||D.value.length===0?[]:[...new Set(D.value.map(c=>c.source))]),G=Q(()=>!D.value||D.value.length===0?null:new Date),h=async()=>{try{const c=await ce.listMetricDefs(!0);M.value=c.items||[]}catch(c){console.error("Failed to load metric definitions:",c),$.value="Не удалось загрузить определения метрик"}},U=async()=>{I.value=!0,$.value=null;try{const c=await ce.listExtractedMetrics(l.reportId);D.value=c.items||[],S.value.metrics={},D.value.forEach(i=>{S.value.metrics[i.metric_def_id]=oe(i.value)}),q.value=JSON.parse(JSON.stringify(S.value.metrics))}catch(c){console.error("Failed to load metrics:",c),$.value="Не удалось загрузить метрики"}finally{I.value=!1}},j=()=>{L.value=!0,q.value=JSON.parse(JSON.stringify(S.value.metrics))},B=()=>{S.value.metrics=JSON.parse(JSON.stringify(q.value)),L.value=!1,$.value=null},N=async()=>{x.value=!0,$.value=null;try{const c=[];for(const[i,v]of Object.entries(S.value.metrics))if(v!=null&&v!==""){const X=Nt(v);X!==null&&c.push({metric_def_id:i,value:X,source:"MANUAL",notes:null})}if(c.length===0){A.warning("Не введено ни одного значения метрики"),x.value=!1;return}await ce.bulkCreateExtractedMetrics(l.reportId,c),A.success(`Успешно сохранено ${c.length} метрик`),L.value=!1,await U(),E("metrics-updated")}catch(c){console.error("Failed to save metrics:",c);let i="Не удалось сохранить метрики";c.response?.data?.detail&&(typeof c.response.data.detail=="string"?i=c.response.data.detail:Array.isArray(c.response.data.detail)&&(i=c.response.data.detail.map(v=>v.msg||v.message).join(", "))),$.value=i,A.error(i)}finally{x.value=!1}},u=c=>{switch(c){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},o=c=>{switch(c){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return c}},w=c=>new Date(c).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Ce(async()=>{await h(),await U()}),te(()=>l.reportId,async c=>{c&&await U()}),(c,i)=>{const v=m("el-button"),X=m("el-alert"),ee=m("el-form-item"),J=m("el-col"),le=m("el-row"),W=m("el-form"),ae=m("el-divider"),re=m("el-tag"),ne=m("el-card");return s(),y(ne,{class:"metrics-editor"},{header:e(()=>[p("div",Ut,[i[4]||(i[4]=p("span",null,"Ручной ввод метрик",-1)),L.value?(s(),R("div",Ft,[t(v,{size:"small",onClick:B},{default:e(()=>[...i[2]||(i[2]=[_(" Отмена ",-1)])]),_:1}),t(v,{type:"primary",size:"small",loading:x.value,onClick:N},{default:e(()=>[...i[3]||(i[3]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])])):(s(),y(v,{key:0,type:"primary",size:"small",onClick:j},{default:e(()=>[...i[1]||(i[1]=[_(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[$.value?(s(),y(X,{key:0,type:"error",title:$.value,closable:"",style:{"margin-bottom":"16px"},onClose:i[0]||(i[0]=F=>$.value=null)},null,8,["title"])):V("",!0),!D.value||D.value.length===0?(s(),y(X,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...i[5]||(i[5]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):V("",!0),t(W,{ref:"formRef",model:S.value,"label-position":"top",disabled:!L.value},{default:e(()=>[t(le,{gutter:20},{default:e(()=>[(s(!0),R(K,null,Z(M.value,F=>(s(),y(J,{key:F.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ee,{label:C(St)(F),prop:`metrics.${F.id}`},{default:e(()=>[t(Lt,{modelValue:S.value.metrics[F.id],"onUpdate:modelValue":d=>S.value.metrics[F.id]=d,min:F.min_value||1,max:F.max_value||10,precision:1,step:.1,disabled:!L.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),F.description?(s(),R("div",Ot,b(F.description),1)):V("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),D.value&&D.value.length>0?(s(),R("div",Pt,[t(ae),p("div",zt,[i[6]||(i[6]=p("span",{class:"info-label"},"Источник данных:",-1)),(s(!0),R(K,null,Z(P.value,F=>(s(),y(re,{key:F,type:u(F),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(b(o(F)),1)]),_:2},1032,["type"]))),128))]),G.value?(s(),R("div",Bt,[i[7]||(i[7]=p("span",{class:"info-label"},"Последнее обновление:",-1)),p("span",null,b(w(G.value)),1)])):V("",!0)])):V("",!0)]),_:1})}}},Gt=me(qt,[["__scopeId","data-v-1e3d866a"]]),Xt={class:"report-list"},jt={class:"report-list__controls"},Jt={class:"controls-left"},Ht={class:"controls-right"},Wt={class:"filename"},Kt={class:"status-cell"},Qt={key:1,class:"report-list__cards"},Yt={class:"report-card__header"},Zt={class:"report-card__status"},ea={class:"report-card__body"},ta={class:"report-card__field"},aa={class:"field-value"},na={class:"report-card__field"},sa={class:"field-value"},oa={class:"report-card__actions"},la={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(r,{emit:k}){const l=r,E=k,I=Be(),x=qe(),L=g(window.innerWidth<=768),$=()=>{L.value=window.innerWidth<=768};Ce(()=>{window.addEventListener("resize",$),I.query.status&&(M.value=I.query.status),I.query.sort&&(D.value=I.query.sort)}),Ge(()=>{window.removeEventListener("resize",$)});const M=g(""),D=g("desc"),S=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];te([M,D],([u,o])=>{const w={...I.query};u?w.status=u:delete w.status,o?w.sort=o:delete w.sort,x.replace({query:w})});const q=()=>{},P=()=>{D.value=D.value==="desc"?"asc":"desc"},G=Q(()=>{let u=[...l.reports];return M.value&&(u=u.filter(o=>o.status===M.value)),u.sort((o,w)=>{const c=new Date(o.uploaded_at),i=new Date(w.uploaded_at);return D.value==="desc"?i-c:c-i}),u}),h=Q(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),U=u=>{if(!u)return"—";const o=new Date(u);return Number.isNaN(o.getTime())?"—":o.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},j=u=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[u]||u,B=u=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[u]||"info",N=async({action:u,report:o})=>{switch(u){case"view":E("view",o.id);break;case"edit":E("edit",o.id);break;case"extract":E("extract",o.id);break;case"download":E("download",o.id);break;case"delete":try{await ht.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",o.id)}catch{}break}};return(u,o)=>{const w=m("el-option"),c=m("el-select"),i=m("el-icon"),v=m("el-button"),X=m("el-table-column"),ee=m("el-tag"),J=m("el-dropdown-item"),le=m("el-dropdown-menu"),W=m("el-dropdown"),ae=m("el-table"),re=m("el-card"),ne=m("el-empty"),F=Re("loading");return s(),R("div",Xt,[p("div",jt,[p("div",Jt,[t(c,{modelValue:M.value,"onUpdate:modelValue":o[0]||(o[0]=d=>M.value=d),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:q},{default:e(()=>[t(w,{label:"Все статусы",value:""}),(s(),R(K,null,Z(S,d=>t(w,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),p("div",Ht,[t(v,{type:D.value==="desc"?"primary":"default",size:"small",onClick:P},{default:e(()=>[t(i,null,{default:e(()=>[t(C(wt))]),_:1}),_(" "+b(D.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),L.value?pe((s(),R("div",Qt,[(s(!0),R(K,null,Z(G.value,d=>(s(),y(re,{key:d.id,class:"report-card",shadow:"hover"},{header:e(()=>[p("div",Yt,[p("div",Zt,[d.status==="PROCESSING"?(s(),y(i,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(C(Ne))]),_:1})):d.status==="EXTRACTED"?(s(),y(i,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(C(Ie))]),_:1})):d.status==="FAILED"?(s(),y(i,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(C(Te))]),_:1})):(s(),y(i,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(C(Le))]),_:1})),t(ee,{type:B(d.status),size:"small"},{default:e(()=>[_(b(j(d.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[p("div",oa,[d.status==="EXTRACTED"?(s(),y(v,{key:0,type:"success",size:"small",onClick:Y=>N({action:"edit",report:d})},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Ue))]),_:1}),o[10]||(o[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):V("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(s(),y(v,{key:1,type:"info",size:"small",onClick:Y=>N({action:"view",report:d})},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Fe))]),_:1}),o[11]||(o[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):V("",!0),t(v,{type:"primary",size:"small",onClick:Y=>N({action:"extract",report:d})},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Oe))]),_:1}),_(" "+b(d.status==="FAILED"?"Повторить":d.status==="PROCESSING"?"Перезапустить":d.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(v,{size:"small",onClick:Y=>N({action:"download",report:d})},{default:e(()=>[t(i,null,{default:e(()=>[t(C(he))]),_:1}),o[12]||(o[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(v,{type:"danger",size:"small",onClick:Y=>N({action:"delete",report:d})},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Pe))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[p("div",ea,[p("div",ta,[o[8]||(o[8]=p("span",{class:"field-label"},"Файл:",-1)),p("span",aa,b(d.file_ref?.filename||"Без названия"),1)]),p("div",na,[o[9]||(o[9]=p("span",{class:"field-label"},"Дата загрузки:",-1)),p("span",sa,b(U(d.uploaded_at)),1)])])]),_:2},1024))),128)),!G.value.length&&!r.loading?(s(),y(ne,{key:0,description:h.value,"image-size":120},{default:e(()=>[M.value?V("",!0):(s(),y(v,{key:0,type:"primary",onClick:o[1]||(o[1]=d=>u.$emit("upload"))},{default:e(()=>[...o[13]||(o[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):V("",!0)])),[[F,r.loading]]):pe((s(),y(ae,{key:0,data:G.value,class:"report-list__table",stripe:"","empty-text":h.value},{default:e(()=>[t(X,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:d})=>[p("span",Wt,b(d.file_ref?.filename||"Без названия"),1)]),_:1}),t(X,{prop:"status",label:"Статус",width:"200"},{default:e(({row:d})=>[p("div",Kt,[d.status==="PROCESSING"?(s(),y(i,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(C(Ne))]),_:1})):d.status==="EXTRACTED"?(s(),y(i,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(C(Ie))]),_:1})):d.status==="FAILED"?(s(),y(i,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(C(Te))]),_:1})):(s(),y(i,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(C(Le))]),_:1})),t(ee,{type:B(d.status),size:"default"},{default:e(()=>[_(b(j(d.status)),1)]),_:2},1032,["type"])])]),_:1}),t(X,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:d})=>[_(b(U(d.uploaded_at)),1)]),_:1}),t(X,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:d})=>[t(W,{trigger:"click",onCommand:N},{dropdown:e(()=>[t(le,null,{default:e(()=>[d.status==="EXTRACTED"?(s(),y(J,{key:0,command:{action:"edit",report:d}},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Ue))]),_:1}),o[4]||(o[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):V("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(s(),y(J,{key:1,command:{action:"view",report:d}},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Fe))]),_:1}),o[5]||(o[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):V("",!0),t(J,{command:{action:"extract",report:d}},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Oe))]),_:1}),_(" "+b(d.status==="FAILED"?"Повторить извлечение":d.status==="PROCESSING"?"Перезапустить извлечение":d.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(J,{divided:"",command:{action:"download",report:d}},{default:e(()=>[t(i,null,{default:e(()=>[t(C(he))]),_:1}),o[6]||(o[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(J,{command:{action:"delete",report:d},class:"dropdown-item--danger"},{default:e(()=>[t(i,null,{default:e(()=>[t(C(Pe))]),_:1}),o[7]||(o[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(v,{type:"primary",size:"small"},{default:e(()=>[o[3]||(o[3]=_(" Действия ",-1)),t(i,{class:"el-icon--right"},{default:e(()=>[t(C(bt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[F,r.loading]]),!G.value.length&&!r.loading&&!L.value?(s(),y(ne,{key:2,description:h.value,"image-size":120},{default:e(()=>[M.value?V("",!0):(s(),y(v,{key:0,type:"primary",onClick:o[2]||(o[2]=d=>u.$emit("upload"))},{default:e(()=>[...o[14]||(o[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):V("",!0)])}}},ra=me(la,[["__scopeId","data-v-c9651b50"]]),ia={class:"metrics-drawer"},ua={class:"drawer-actions"},da={key:1},ca={key:1},pa={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(r,{emit:k}){const l=r,E=k,I=g(!1),x=g([]),L=g([]),$=Q(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),M=h=>{E("update:modelValue",h)},D=async()=>{try{const h=await ce.listMetricDefs(!0);L.value=h.items||[]}catch(h){console.error("Error loading metric definitions:",h)}},S=async()=>{I.value=!0;try{const h=await ke.getMetrics(l.participantId);x.value=h.metrics||[]}catch(h){console.error("Error loading participant metrics:",h),A.error("Ошибка загрузки метрик участника")}finally{I.value=!1}},q=h=>{if(!h)return"—";const U=L.value.find(B=>B.code===h);return xt(U,h,{warn:()=>{}})},P=h=>h>=.8?"var(--color-success)":h>=.6?"var(--color-warning)":"var(--color-danger)",G=h=>{if(!h)return"—";const U=new Date(h);return Number.isNaN(U.getTime())?"—":U.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return te(()=>l.participantId,async h=>{h&&l.modelValue&&(await D(),await S())}),te(()=>l.modelValue,async h=>{h&&l.participantId&&(await D(),await S())}),(h,U)=>{const j=m("el-icon"),B=m("el-button"),N=m("el-table-column"),u=m("el-tag"),o=m("el-table"),w=m("el-empty"),c=m("el-drawer"),i=Re("loading");return s(),y(c,{"model-value":r.modelValue,title:`Метрики участника: ${r.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":M},{default:e(()=>[pe((s(),R("div",ia,[p("div",ua,[t(B,{type:"primary",size:"small",onClick:S},{default:e(()=>[t(j,null,{default:e(()=>[t(C(kt))]),_:1}),U[0]||(U[0]=_(" Обновить ",-1))]),_:1})]),t(o,{data:x.value,stripe:"","empty-text":$.value},{default:e(()=>[t(N,{prop:"metric_code",label:"Код метрики",width:"200"}),t(N,{label:"Название метрики","min-width":"250"},{default:e(({row:v})=>[_(b(q(v.metric_code)),1)]),_:1}),t(N,{prop:"value",label:"Значение",width:"120"},{default:e(({row:v})=>[t(u,{type:"success"},{default:e(()=>[_(b(C(de)(v.value)),1)]),_:2},1024)]),_:1}),t(N,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:v})=>[v.confidence!==null?(s(),R("span",{key:0,style:Ct({color:P(v.confidence)})},b((v.confidence*100).toFixed(0))+"% ",5)):(s(),R("span",da,"—"))]),_:1}),t(N,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:v})=>[_(b(G(v.updated_at)),1)]),_:1}),t(N,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:v})=>[v.last_source_report_id?(s(),y(u,{key:0,size:"small"},{default:e(()=>[...U[1]||(U[1]=[_(" Из отчёта ",-1)])]),_:1})):(s(),R("span",ca,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!x.value.length&&!I.value?(s(),y(w,{key:0,description:$.value},null,8,["description"])):V("",!0)])),[[i,I.value]])]),_:1},8,["model-value","title"])}}},ma=me(pa,[["__scopeId","data-v-f380b518"]]),fa={class:"participant-detail"},_a={class:"card-header"},va={class:"header-actions"},ya={class:"section-header"},ga={class:"scoring-result"},wa={class:"score-value"},ba={class:"score-number"},ha={class:"score-details"},ka={class:"score-section"},Ca={key:0},Ra={class:"score-section"},Da={key:0},Ea={class:"score-section"},$a={key:0},Ma={key:0,class:"recommendation-skill-focus"},Sa={key:1,class:"recommendation-advice"},xa={key:2,class:"recommendation-formats"},Aa={class:"formats-list"},Va={key:0,class:"final-report-actions"},Na={class:"activity-code-hint"},Ia={__name:"ParticipantDetailView",setup(r){const k=qe(),l=Be(),E=Vt(),I=g(!1),x=g(!1),L=g(!1),$=g(!1),M=g(!1),D=g(!1),S=Q(()=>E.currentParticipant),q=g([]),P=g([]),G=g([]),h=g([]),U=g([]);g([]);const j=g(null),B=g(null),N=g(null),u=Q(()=>q.value.some(n=>n.status==="PROCESSING")),o=Q(()=>P.value.some(n=>n.recommendations_status==="pending")),w=g(!1),c=g(!1),i=g(!1),v=g(!1),X=g(null),ee=g([]),J=ze({file:null}),le={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},W=ze({activityCode:""}),ae=n=>{if(!n)return"—";const a=new Date(n);return Number.isNaN(a.getTime())?"—":a.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},re=n=>n>=80?"success":n>=60?"":"warning",ne=n=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[n]||n,F=n=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[n]||"info",d=async()=>{I.value=!0;try{await E.getParticipant(l.params.id)}catch{A.error("Участник не найден"),k.push("/participants")}finally{I.value=!1}},Y=async({silent:n=!1}={})=>{n||(x.value=!0);try{const a=await ke.getReports(l.params.id);q.value=a.items||[]}catch(a){console.error("Error loading reports:",a),A.error("Ошибка загрузки списка отчётов")}finally{n||(x.value=!1)}},De=n=>{if(!n)return n;const a=Array.isArray(n.recommendations)?n.recommendations:[];let T=n.recommendations_status||n.recommendationsStatus||null;T||(T=a.length>0?"ready":"pending");const O=Number(n.score_pct),se=Number.isNaN(O)?n.score_pct:O;return{...n,score_pct:se,recommendations:a,recommendations_status:T,recommendations_error:n.recommendations_error||n.recommendationsError||null}},Ee=async()=>{try{const n=await be.getHistory(l.params.id),a=Array.isArray(n.items)?n.items:[];P.value=a.map(De)}catch(n){console.error("Error loading scoring results:",n)}},Xe=async()=>{L.value=!0;try{const n=await At.list();G.value=n||[]}catch{A.error("Ошибка загрузки профессиональных областей")}finally{L.value=!1}},je=async()=>{try{const n=await ce.listMetricDefs(!0);U.value=n.items||[]}catch(n){console.error("Error loading metric definitions:",n)}},fe=async({silent:n=!1}={})=>{n||($.value=!0);try{const a=await ke.getMetrics(l.params.id);console.log("[DEBUG] loadParticipantMetrics response:",a),console.log("[DEBUG] response.metrics length:",a.metrics?.length||0),h.value=a.metrics||[],console.log("[DEBUG] participantMetrics.value length:",h.value.length)}catch(a){console.error("Error loading participant metrics:",a),A.error("Ошибка загрузки метрик участника")}finally{n||($.value=!1)}},Je=n=>{J.file=n.raw,ee.value=[n]},He=async()=>{X.value&&await X.value.validate(async n=>{if(n){if(!J.file){A.error("Выберите файл");return}M.value=!0;try{await ve.upload(l.params.id,J.file),A.success("Отчёт загружен успешно"),w.value=!1,J.file=null,ee.value=[],await Y(),await fe()}catch{A.error("Ошибка загрузки отчёта")}finally{M.value=!1}}})},We=async n=>{try{const a=await ve.download(n),T=window.URL.createObjectURL(new Blob([a.data])),O=document.createElement("a");O.href=T,O.setAttribute("download",`report_${n}.docx`),document.body.appendChild(O),O.click(),O.remove(),window.URL.revokeObjectURL(T),A.success("Отчёт скачан")}catch{A.error("Ошибка скачивания отчёта")}},Ke=async n=>{try{await ve.extract(n),A.success("Извлечение метрик запущено"),await Y()}catch{A.error("Ошибка запуска извлечения метрик")}},Qe=()=>{B.value||(B.value=setInterval(async()=>{try{await Y({silent:!0}),await fe({silent:!0})}catch(n){console.error("Auto-refresh error:",n)}},3e3))},$e=()=>{B.value&&(clearInterval(B.value),B.value=null)},Ye=()=>{N.value||(N.value=setInterval(async()=>{try{await Ee()}catch(n){console.error("Recommendations auto-refresh error:",n)}},15e3))},Me=()=>{N.value&&(clearInterval(N.value),N.value=null)};te(u,n=>{n?Qe():$e()}),te(o,n=>{n?Ye():Me()});const Se=async n=>{j.value=n,await $t(),i.value=!0},Ze=async()=>{A.success("Метрики обновлены"),await fe()},et=async n=>{try{await ve.delete(n),A.success("Отчёт удалён"),await Y()}catch{A.error("Ошибка удаления отчёта")}},tt=async()=>{if(!W.activityCode){A.warning("Выберите профессиональную область");return}D.value=!0;try{const n=await be.calculate(l.params.id,W.activityCode),a=De({id:n.scoring_result_id,participant_id:l.params.id,prof_activity_code:n.prof_activity_code||W.activityCode,prof_activity_name:n.prof_activity_name,score_pct:parseFloat(n.score_pct),strengths:n.strengths||[],dev_areas:n.dev_areas||[],recommendations:n.recommendations||[],recommendations_status:n.recommendations_status||((n.recommendations||[]).length>0?"ready":"pending"),recommendations_error:n.recommendations_error||null,created_at:new Date().toISOString()});P.value.unshift(a),A.success("Расчёт пригодности выполнен"),c.value=!1,W.activityCode=""}catch(n){console.error("Scoring calculation error:",n);const a=n.response?.data?.detail||"Ошибка расчёта пригодности";A.error(a)}finally{D.value=!1}},at=async n=>{if(!n.prof_activity_code){A.warning("Код профессиональной деятельности не найден");return}try{const a=await be.downloadFinalReportPdf(l.params.id,n.prof_activity_code),T=window.URL.createObjectURL(new Blob([a.data])),O=document.createElement("a");O.href=T,O.setAttribute("download",`final_report_${n.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(O),O.click(),O.remove(),window.URL.revokeObjectURL(T),A.success("Отчёт PDF скачан")}catch(a){const T=a.response?.data?.detail||"Ошибка загрузки PDF отчёта";A.error(T)}},nt=n=>n?.recommendations_status==="ready"&&Array.isArray(n?.recommendations)&&n.recommendations.length>0,st=n=>n?.recommendations_error?`Ошибка генерации: ${n.recommendations_error}`:"Не удалось получить рекомендации";return Ce(async()=>{await d(),await Y(),await Ee(),await Xe(),await je(),await fe()}),Ge(()=>{$e(),Me()}),(n,a)=>{const T=m("el-button"),O=m("el-icon"),se=m("el-descriptions-item"),ot=m("el-descriptions"),_e=m("el-card"),lt=m("el-progress"),ge=m("el-empty"),rt=m("el-tag"),ie=m("el-alert"),it=m("el-timeline-item"),ut=m("el-timeline"),dt=m("el-upload"),xe=m("el-form-item"),Ae=m("el-form"),we=m("el-dialog"),ct=m("el-option"),pt=m("el-select"),Ve=Re("loading");return s(),y(Mt,null,{default:e(()=>[pe((s(),R("div",fa,[S.value?(s(),y(_e,{key:0,class:"detail-card"},{header:e(()=>[p("div",_a,[p("h2",null,b(S.value.full_name),1),p("div",va,[t(T,{onClick:a[0]||(a[0]=f=>C(k).back())},{default:e(()=>[...a[12]||(a[12]=[_(" Назад ",-1)])]),_:1}),t(T,{type:"info",onClick:a[1]||(a[1]=f=>v.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(C(Rt))]),_:1}),a[13]||(a[13]=_(" Метрики ",-1))]),_:1}),t(T,{type:"primary",onClick:a[2]||(a[2]=f=>c.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(C(Dt))]),_:1}),a[14]||(a[14]=_(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(ot,{column:2,border:""},{default:e(()=>[t(se,{label:"ФИО"},{default:e(()=>[_(b(S.value.full_name),1)]),_:1}),t(se,{label:"Дата рождения"},{default:e(()=>[_(b(S.value.birth_date||"Не указана"),1)]),_:1}),t(se,{label:"Внешний ID"},{default:e(()=>[_(b(S.value.external_id||"Не указан"),1)]),_:1}),t(se,{label:"Дата создания"},{default:e(()=>[_(b(ae(S.value.created_at)),1)]),_:1})]),_:1})]),_:1})):V("",!0),t(_e,{class:"section-card"},{header:e(()=>[p("div",ya,[a[16]||(a[16]=p("h3",null,"Отчёты",-1)),t(T,{type:"primary",onClick:a[3]||(a[3]=f=>w.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(C(Et))]),_:1}),a[15]||(a[15]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(ra,{reports:q.value,loading:x.value,onView:Se,onEdit:Se,onExtract:Ke,onDownload:We,onDelete:et,onUpload:a[4]||(a[4]=f=>w.value=!0)},null,8,["reports","loading"])]),_:1}),P.value.length>0?(s(),y(_e,{key:1,class:"section-card"},{header:e(()=>[...a[17]||(a[17]=[p("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(ut,null,{default:e(()=>[(s(!0),R(K,null,Z(P.value,f=>(s(),y(it,{key:f.id,timestamp:ae(f.created_at),placement:"top"},{default:e(()=>[t(_e,null,{default:e(()=>[p("h4",null,b(f.prof_activity_name),1),p("div",ga,[p("div",wa,[p("span",ba,b(f.score_pct)+"%",1),t(lt,{percentage:f.score_pct,status:re(f.score_pct)},null,8,["percentage","status"])]),p("div",ha,[p("div",ka,[a[18]||(a[18]=p("h5",null,"Сильные стороны:",-1)),f.strengths&&f.strengths.length?(s(),R("ul",Ca,[(s(!0),R(K,null,Z(f.strengths,(z,ue)=>(s(),R("li",{key:ue},[p("strong",null,b(z.metric_name),1),_(" — "+b(C(de)(z.value))+" (вес "+b(C(de)(z.weight,2))+") ",1)]))),128))])):(s(),y(ge,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ra,[a[19]||(a[19]=p("h5",null,"Зоны развития:",-1)),f.dev_areas&&f.dev_areas.length?(s(),R("ul",Da,[(s(!0),R(K,null,Z(f.dev_areas,(z,ue)=>(s(),R("li",{key:ue},[p("strong",null,b(z.metric_name),1),_(" — "+b(C(de)(z.value))+" (вес "+b(C(de)(z.weight,2))+") ",1)]))),128))])):(s(),y(ge,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ea,[p("h5",null,[a[20]||(a[20]=_(" Рекомендации: ",-1)),f.recommendations_status?(s(),y(rt,{key:0,type:F(f.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[_(b(ne(f.recommendations_status)),1)]),_:2},1032,["type"])):V("",!0)]),nt(f)?(s(),R("ul",$a,[(s(!0),R(K,null,Z(f.recommendations,(z,ue)=>(s(),R("li",{key:ue,class:"recommendation-item"},[p("strong",null,b(z.title),1),z.skill_focus?(s(),R("div",Ma,[a[21]||(a[21]=p("strong",null,"Навык:",-1)),_(" "+b(z.skill_focus),1)])):V("",!0),z.development_advice?(s(),R("div",Sa,b(z.development_advice),1)):V("",!0),z.recommended_formats&&z.recommended_formats.length>0?(s(),R("div",xa,[a[22]||(a[22]=p("strong",null,"Рекомендуемые форматы:",-1)),p("ul",Aa,[(s(!0),R(K,null,Z(z.recommended_formats,(mt,ft)=>(s(),R("li",{key:ft},b(mt),1))),128))])])):V("",!0)]))),128))])):f.recommendations_status==="pending"?(s(),y(ie,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):f.recommendations_status==="error"?(s(),y(ie,{key:2,title:st(f),type:"error",closable:!1,"show-icon":""},null,8,["title"])):f.recommendations_status==="disabled"?(s(),y(ie,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(s(),y(ge,{key:4,description:"Нет данных","image-size":60}))])]),f.prof_activity_code?(s(),R("div",Va,[t(T,{type:"primary",size:"small",onClick:z=>at(f)},{default:e(()=>[t(O,null,{default:e(()=>[t(C(he))]),_:1}),a[23]||(a[23]=_(" Скачать PDF ",-1))]),_:1},8,["onClick"])])):V("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):V("",!0),t(we,{modelValue:w.value,"onUpdate:modelValue":a[6]||(a[6]=f=>w.value=f),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(T,{onClick:a[5]||(a[5]=f=>w.value=!1)},{default:e(()=>[...a[26]||(a[26]=[_(" Отмена ",-1)])]),_:1}),t(T,{type:"primary",loading:M.value,onClick:He},{default:e(()=>[...a[27]||(a[27]=[_(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Ae,{ref_key:"uploadFormRef",ref:X,model:J,rules:le,"label-position":"top"},{default:e(()=>[t(xe,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(dt,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Je,"file-list":ee.value},{tip:e(()=>[...a[25]||(a[25]=[p("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(T,{type:"primary"},{default:e(()=>[...a[24]||(a[24]=[_(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(we,{modelValue:c.value,"onUpdate:modelValue":a[9]||(a[9]=f=>c.value=f),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(T,{onClick:a[8]||(a[8]=f=>c.value=!1)},{default:e(()=>[...a[28]||(a[28]=[_(" Отмена ",-1)])]),_:1}),t(T,{type:"primary",loading:D.value,disabled:!W.activityCode||q.value.length===0,onClick:tt},{default:e(()=>[...a[29]||(a[29]=[_(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Ae,{model:W,"label-position":"top"},{default:e(()=>[t(xe,{label:"Профессиональная область",required:""},{default:e(()=>[pe((s(),y(pt,{modelValue:W.activityCode,"onUpdate:modelValue":a[7]||(a[7]=f=>W.activityCode=f),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(s(!0),R(K,null,Z(G.value,f=>(s(),y(ct,{key:f.code,label:f.name,value:f.code},{default:e(()=>[p("span",null,b(f.name),1),p("span",Na,b(f.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Ve,L.value]])]),_:1}),t(ie,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),q.value.length===0?(s(),y(ie,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):V("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(we,{modelValue:i.value,"onUpdate:modelValue":a[10]||(a[10]=f=>i.value=f),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[j.value?(s(),y(Gt,{key:0,"report-id":j.value,onMetricsUpdated:Ze},null,8,["report-id"])):V("",!0)]),_:1},8,["modelValue"]),t(ma,{modelValue:v.value,"onUpdate:modelValue":a[11]||(a[11]=f=>v.value=f),"participant-id":S.value?.id,"participant-name":S.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Ve,I.value]])]),_:1})}}},Pa=me(Ia,[["__scopeId","data-v-7b3a34a2"]]);export{Pa as default};
