import{m as s,n as q,H as Me,v as V,w as a,q as Ye,E as d,d as Te,r as i,I as Ne,o as u,J as re,c as F,x as U,f as l,u as w,e as o,B as f,a as v,F as se,C as de,K as ue,N as pe}from"./index-DkBW6kl5.js";import{A as Oe}from"./AppLayout-SXmHkj5y.js";import{p as me}from"./participants-Bekp8jEs.js";import{o as k}from"./organizations-BvO8ewAK.js";import{a as qe}from"./dateFormat-Bky3s5gS.js";import{u as Le}from"./useResponsive-BIJ3kAHe.js";import{_ as He}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Je={class:"org-detail"},Ke={class:"card-header"},Se={class:"header-actions"},je={class:"section-header"},Ge={key:1,class:"departments-list"},Ie={class:"dept-header"},Qe={class:"dept-title"},We={class:"dept-name"},Xe={class:"dept-actions"},Ze={key:0,class:"dept-description"},ea={key:1,class:"dept-participants"},aa={key:0,style:{float:"right",color:"var(--color-text-secondary)","font-size":"12px"}},la={__name:"OrganizationDetailView",setup(ta){const L=Te(),b=Ye(),{isMobile:R}=Le(),H=s(!1),p=s(!1),m=s(null),P=s({}),J=s({}),K=s({}),B=s(!1),S=s(null),D=q({name:"",description:""}),ce={name:[{required:!0,message:"Введите название",trigger:"blur"}]},A=s(!1),j=s(null),x=q({name:"",description:""}),ae={name:[{required:!0,message:"Введите название отдела",trigger:"blur"}]},E=s(!1),G=s(null),_=q({id:null,name:"",description:""}),M=s(!1),I=s("existing"),y=s(null),$=s([]),T=s([]),Q=s(!1),W=s(null),c=q({full_name:"",birth_date:"",external_id:""}),fe={full_name:[{required:!0,message:"Введите ФИО",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},C=async()=>{H.value=!0;try{const n=await k.getById(b.params.id);m.value=n}catch{d.error("Организация не найдена"),L.push("/organizations")}finally{H.value=!1}},ve=async()=>{S.value&&await S.value.validate(async n=>{if(n){p.value=!0;try{await k.update(b.params.id,D),d.success("Организация обновлена"),B.value=!1,await C()}catch(e){d.error(e.response?.data?.detail||"Ошибка обновления")}finally{p.value=!1}}})},_e=async()=>{j.value&&await j.value.validate(async n=>{if(n){p.value=!0;try{await k.createDepartment(b.params.id,x),d.success("Отдел создан"),A.value=!1,x.name="",x.description="",await C()}catch(e){d.error(e.response?.data?.detail||"Ошибка создания отдела")}finally{p.value=!1}}})},ye=n=>{_.id=n.id,_.name=n.name,_.description=n.description||"",E.value=!0},ge=async()=>{G.value&&await G.value.validate(async n=>{if(n){p.value=!0;try{await k.updateDepartment(b.params.id,_.id,{name:_.name,description:_.description}),d.success("Отдел обновлён"),E.value=!1,await C()}catch(e){d.error(e.response?.data?.detail||"Ошибка обновления отдела")}finally{p.value=!1}}})},we=n=>{pe.confirm(`Удалить отдел "${n.name}"? Участники будут отвязаны, но не удалены.`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await k.deleteDepartment(b.params.id,n.id),d.success("Отдел удалён"),await C()}catch{d.error("Ошибка удаления отдела")}}).catch(()=>{})},be=async n=>{if(P.value[n]){P.value[n]=!1;return}P.value[n]=!0,await N(n)},N=async n=>{K.value[n]=!0;try{const e=await k.listDepartmentParticipants(b.params.id,n);J.value[n]=e}catch{d.error("Ошибка загрузки участников отдела")}finally{K.value[n]=!1}},Ve=async n=>{y.value=n,$.value=[],T.value=[],I.value="existing",c.full_name="",c.birth_date="",c.external_id="",M.value=!0,await le("")},le=async n=>{Q.value=!0;try{const e={size:20};n&&n.length>=2&&(e.query=n);const r=await me.search(e);T.value=r.items||[]}catch{T.value=[]}finally{Q.value=!1}},ke=async()=>{if(!(!$.value.length||!y.value)){p.value=!0;try{await k.attachParticipants(b.params.id,y.value.id,$.value),d.success("Участники привязаны"),M.value=!1,await C(),P.value[y.value.id]&&await N(y.value.id)}catch(n){d.error(n.response?.data?.detail||"Ошибка привязки участников")}finally{p.value=!1}}},De=async()=>{!W.value||!y.value||await W.value.validate(async n=>{if(n){p.value=!0;try{const e=await me.create({full_name:c.full_name,birth_date:c.birth_date||null,external_id:c.external_id||null});await k.attachParticipants(b.params.id,y.value.id,[e.id]),d.success(`Участник "${e.full_name}" создан и привязан`),M.value=!1,await C(),P.value[y.value.id]&&await N(y.value.id)}catch(e){d.error(e.response?.data?.detail||"Ошибка создания участника")}finally{p.value=!1}}})},xe=(n,e)=>{pe.confirm(`Отвязать "${e.full_name}" от отдела "${n.name}"?`,"Подтверждение",{confirmButtonText:"Отвязать",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await k.detachParticipant(b.params.id,n.id,e.id),d.success("Участник отвязан"),await C(),await N(n.id)}catch{d.error("Ошибка отвязки участника")}}).catch(()=>{})};return Me(async()=>{await C(),m.value&&(D.name=m.value.name,D.description=m.value.description||"")}),(n,e)=>{const r=i("el-button"),O=i("el-descriptions-item"),Ce=i("el-descriptions"),X=i("el-card"),te=i("el-icon"),ne=i("el-empty"),he=i("el-tag"),ze=i("el-divider"),Pe=i("el-link"),Z=i("el-table-column"),$e=i("el-table"),h=i("el-input"),g=i("el-form-item"),Y=i("el-form"),ee=i("el-dialog"),Fe=i("el-option"),Ue=i("el-select"),oe=i("el-tab-pane"),Re=i("el-date-picker"),Be=i("el-tabs"),Ae=i("el-drawer"),ie=Ne("loading");return u(),V(Oe,null,{default:a(()=>[re((u(),F("div",Je,[m.value?(u(),V(X,{key:0,class:"detail-card"},{header:a(()=>[v("div",Ke,[v("h2",null,f(m.value.name),1),v("div",Se,[l(r,{onClick:e[0]||(e[0]=t=>w(L).push("/organizations"))},{default:a(()=>[...e[21]||(e[21]=[o(" Назад ",-1)])]),_:1}),l(r,{type:"primary",onClick:e[1]||(e[1]=t=>B.value=!0)},{default:a(()=>[...e[22]||(e[22]=[o(" Редактировать ",-1)])]),_:1})])])]),default:a(()=>[l(Ce,{column:w(R)?1:2,border:""},{default:a(()=>[l(O,{label:"Название"},{default:a(()=>[o(f(m.value.name),1)]),_:1}),l(O,{label:"Описание"},{default:a(()=>[o(f(m.value.description||"Не указано"),1)]),_:1}),l(O,{label:"Дата создания"},{default:a(()=>[o(f(w(qe)(m.value.created_at)),1)]),_:1}),l(O,{label:"Кол-во отделов"},{default:a(()=>[o(f(m.value.departments?.length||0),1)]),_:1})]),_:1},8,["column"])]),_:1})):U("",!0),m.value?(u(),V(X,{key:1,class:"section-card"},{header:a(()=>[v("div",je,[e[24]||(e[24]=v("h3",null,"Отделы",-1)),l(r,{type:"primary",onClick:e[2]||(e[2]=t=>A.value=!0)},{default:a(()=>[l(te,null,{default:a(()=>[l(w(ue))]),_:1}),e[23]||(e[23]=o(" Добавить отдел ",-1))]),_:1})])]),default:a(()=>[m.value.departments?.length?(u(),F("div",Ge,[(u(!0),F(se,null,de(m.value.departments,t=>(u(),V(X,{key:t.id,class:"dept-card",shadow:"hover"},{header:a(()=>[v("div",Ie,[v("div",Qe,[v("span",We,f(t.name),1),l(he,{size:"small"},{default:a(()=>[o(f(t.participants_count)+" уч. ",1)]),_:2},1024)]),v("div",Xe,[l(r,{size:"small",onClick:z=>be(t.id)},{default:a(()=>[o(f(P.value[t.id]?"Свернуть":"Участники"),1)]),_:2},1032,["onClick"]),l(r,{size:"small",type:"primary",plain:"",onClick:z=>Ve(t)},{default:a(()=>[l(te,null,{default:a(()=>[l(w(ue))]),_:1}),e[25]||(e[25]=o(" Добавить ",-1))]),_:1},8,["onClick"]),l(r,{size:"small",onClick:z=>ye(t)},{default:a(()=>[...e[26]||(e[26]=[o(" Изменить ",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",type:"danger",plain:"",onClick:z=>we(t)},{default:a(()=>[...e[27]||(e[27]=[o(" Удалить ",-1)])]),_:1},8,["onClick"])])])]),default:a(()=>[t.description?(u(),F("div",Ze,f(t.description),1)):U("",!0),P.value[t.id]?re((u(),F("div",ea,[t.description?(u(),V(ze,{key:0})):U("",!0),e[29]||(e[29]=v("div",{class:"dept-participants-header"},[v("span",null,"Участники отдела")],-1)),J.value[t.id]?.length?(u(),V($e,{key:2,data:J.value[t.id],size:"small",stripe:""},{default:a(()=>[l(Z,{label:"ФИО"},{default:a(({row:z})=>[l(Pe,{type:"primary",underline:!1,onClick:Ee=>w(L).push(`/participants/${z.id}`)},{default:a(()=>[o(f(z.full_name),1)]),_:2},1032,["onClick"])]),_:1}),l(Z,{prop:"external_id",label:"Внешний ID",width:"150"}),l(Z,{label:"",width:"120",align:"center"},{default:a(({row:z})=>[l(r,{type:"warning",size:"small",plain:"",onClick:Ee=>xe(t,z)},{default:a(()=>[...e[28]||(e[28]=[o(" Отвязать ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])):(u(),V(ne,{key:1,description:"Нет участников","image-size":60}))])),[[ie,K.value[t.id]]]):U("",!0)]),_:2},1024))),128))])):(u(),V(ne,{key:0,description:"Нет отделов","image-size":80}))]),_:1})):U("",!0),l(ee,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=t=>B.value=t),title:"Редактировать организацию",width:w(R)?"95%":"500px"},{footer:a(()=>[l(r,{onClick:e[5]||(e[5]=t=>B.value=!1)},{default:a(()=>[...e[30]||(e[30]=[o(" Отмена ",-1)])]),_:1}),l(r,{type:"primary",loading:p.value,onClick:ve},{default:a(()=>[...e[31]||(e[31]=[o(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(Y,{ref_key:"editFormRef",ref:S,model:D,rules:ce,"label-position":"top"},{default:a(()=>[l(g,{label:"Название",prop:"name"},{default:a(()=>[l(h,{modelValue:D.name,"onUpdate:modelValue":e[3]||(e[3]=t=>D.name=t)},null,8,["modelValue"])]),_:1}),l(g,{label:"Описание",prop:"description"},{default:a(()=>[l(h,{modelValue:D.description,"onUpdate:modelValue":e[4]||(e[4]=t=>D.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(ee,{modelValue:A.value,"onUpdate:modelValue":e[10]||(e[10]=t=>A.value=t),title:"Добавить отдел",width:w(R)?"95%":"500px"},{footer:a(()=>[l(r,{onClick:e[9]||(e[9]=t=>A.value=!1)},{default:a(()=>[...e[32]||(e[32]=[o(" Отмена ",-1)])]),_:1}),l(r,{type:"primary",loading:p.value,onClick:_e},{default:a(()=>[...e[33]||(e[33]=[o(" Создать ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(Y,{ref_key:"deptFormRef",ref:j,model:x,rules:ae,"label-position":"top"},{default:a(()=>[l(g,{label:"Название",prop:"name"},{default:a(()=>[l(h,{modelValue:x.name,"onUpdate:modelValue":e[7]||(e[7]=t=>x.name=t),placeholder:"Введите название отдела"},null,8,["modelValue"])]),_:1}),l(g,{label:"Описание",prop:"description"},{default:a(()=>[l(h,{modelValue:x.description,"onUpdate:modelValue":e[8]||(e[8]=t=>x.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(ee,{modelValue:E.value,"onUpdate:modelValue":e[14]||(e[14]=t=>E.value=t),title:"Редактировать отдел",width:w(R)?"95%":"500px"},{footer:a(()=>[l(r,{onClick:e[13]||(e[13]=t=>E.value=!1)},{default:a(()=>[...e[34]||(e[34]=[o(" Отмена ",-1)])]),_:1}),l(r,{type:"primary",loading:p.value,onClick:ge},{default:a(()=>[...e[35]||(e[35]=[o(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(Y,{ref_key:"editDeptFormRef",ref:G,model:_,rules:ae,"label-position":"top"},{default:a(()=>[l(g,{label:"Название",prop:"name"},{default:a(()=>[l(h,{modelValue:_.name,"onUpdate:modelValue":e[11]||(e[11]=t=>_.name=t)},null,8,["modelValue"])]),_:1}),l(g,{label:"Описание",prop:"description"},{default:a(()=>[l(h,{modelValue:_.description,"onUpdate:modelValue":e[12]||(e[12]=t=>_.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(Ae,{modelValue:M.value,"onUpdate:modelValue":e[20]||(e[20]=t=>M.value=t),title:"Добавить участника — "+(y.value?.name||""),size:w(R)?"100%":"480px",direction:"rtl","destroy-on-close":""},{default:a(()=>[l(Be,{modelValue:I.value,"onUpdate:modelValue":e[19]||(e[19]=t=>I.value=t)},{default:a(()=>[l(oe,{label:"Найти существующего",name:"existing"},{default:a(()=>[l(Y,{"label-position":"top"},{default:a(()=>[l(g,{label:"Поиск участника"},{default:a(()=>[l(Ue,{modelValue:$.value,"onUpdate:modelValue":e[15]||(e[15]=t=>$.value=t),multiple:"",filterable:"",remote:"","reserve-keyword":"",placeholder:"Введите имя для поиска","remote-method":le,loading:Q.value,style:{width:"100%"}},{default:a(()=>[(u(!0),F(se,null,de(T.value,t=>(u(),V(Fe,{key:t.id,label:t.full_name,value:t.id},{default:a(()=>[v("span",null,f(t.full_name),1),t.external_id?(u(),F("span",aa,f(t.external_id),1)):U("",!0)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),l(r,{type:"primary",loading:p.value,disabled:!$.value.length,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:ke},{default:a(()=>[o(" Привязать ("+f($.value.length)+") ",1)]),_:1},8,["loading","disabled"])]),_:1}),l(oe,{label:"Создать нового",name:"create"},{default:a(()=>[l(Y,{ref_key:"newParticipantFormRef",ref:W,model:c,rules:fe,"label-position":"top"},{default:a(()=>[l(g,{label:"ФИО",prop:"full_name"},{default:a(()=>[l(h,{modelValue:c.full_name,"onUpdate:modelValue":e[16]||(e[16]=t=>c.full_name=t),placeholder:"Введите полное имя"},null,8,["modelValue"])]),_:1}),l(g,{label:"Дата рождения",prop:"birth_date"},{default:a(()=>[l(Re,{modelValue:c.birth_date,"onUpdate:modelValue":e[17]||(e[17]=t=>c.birth_date=t),type:"date",placeholder:"Выберите дату",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(g,{label:"Внешний ID",prop:"external_id"},{default:a(()=>[l(h,{modelValue:c.external_id,"onUpdate:modelValue":e[18]||(e[18]=t=>c.external_id=t),placeholder:"Внешний идентификатор (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),l(r,{type:"primary",loading:p.value,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:De},{default:a(()=>[...e[36]||(e[36]=[o(" Создать и привязать ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title","size"])])),[[ie,H.value]])]),_:1})}}},pa=He(la,[["__scopeId","data-v-9b5e8567"]]);export{pa as default};
