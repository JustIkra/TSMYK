import{N as B,m as w,O as Y,p as _e,r as _,c as b,o as n,d as t,x as M,P as wt,w as e,u as h,Q as bt,K as ht,z as kt,B as g,F as H,H as De,v,f,C as Q,a as m,E as x,q as Xe,e as qe,R as je,I as Je,J as fe,S as Ct,T as Ie,k as Te,U as Le,g as Fe,V as Rt,W as Ue,X as Oe,h as Pe,Y as Ee,Z as ze,M as Et,n as Be,t as Dt,_ as St,$ as $t,a0 as Mt,G as At}from"./index-BeObjHVo.js";import{A as xt}from"./AppLayout-Df1MjJk7.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as Nt,m as ge,p as Vt,g as It}from"./metricNames-BXBkv-n2.js";import{u as Tt,p as Ge}from"./participants-Bfk0LrYv.js";const ye={async upload(r,k){const i=new FormData;return i.append("file",k),(await B.post(`/participants/${r}/reports`,i,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(r){return await B.get(`/reports/${r}/download`,{responseType:"blob"})},async getById(r){return(await B.get(`/reports/${r}`)).data},async delete(r){return(await B.delete(`/reports/${r}`)).data},async extract(r){return(await B.post(`/reports/${r}/extract`)).data},async getMetrics(r){return(await B.get(`/reports/${r}/metrics`)).data},async getList(r){return(await B.get(`/participants/${r}/reports`)).data}},Re={async calculate(r,k){return(await B.post(`/scoring/participants/${r}/calculate`,null,{params:{activity_code:k}})).data},async getHistory(r,k=10){return(await B.get(`/scoring/participants/${r}/scores`,{params:{limit:k}})).data},async getById(r){return(await B.get(`/scoring-results/${r}`)).data},async generateRecommendations(r){return(await B.post(`/reports/${r}/recommendations`)).data},async getFinalReport(r,k,i="json"){const E={params:{activity_code:k,format:i}};i==="html"&&(E.responseType="text");const L=await B.get(`/participants/${r}/final-report`,E);return L.data},async downloadFinalReportPdf(r,k){return await B.get(`/participants/${r}/final-report`,{params:{activity_code:k,format:"pdf"},responseType:"blob"})}};function we(r,k=1){if(r==null||r==="")return"";const i=typeof r=="string"?parseFloat(r):r;return isNaN(i)?"":i.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function le(r){if(r==null||r==="")return null;const i=String(r).trim().replace(",","."),E=parseFloat(i);return isNaN(E)?null:E}function Lt(r){return le(r)}function me(r,k=1){return we(r,k)}const Ft={key:0,class:"error-message"},Ut={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(r,{emit:k}){const i=r,E=k,L=w(null),N=w(""),T=w(!1),D=w(!1),S=w(""),C=Y(()=>le(N.value)),V=Y(()=>{const u=C.value;return u===null||u<=i.min}),z=Y(()=>{const u=C.value;return u===null||u>=i.max}),U=u=>{if(u==null||u===""){N.value="";return}T.value?N.value=String(u).replace(".",","):N.value=we(u,i.precision)},G=u=>{if(u==null||u==="")return D.value=!1,S.value="",!0;const l=le(u);return l===null?(D.value=!0,S.value="Некорректное число",!1):l<i.min?(D.value=!0,S.value=`Значение должно быть не меньше ${we(i.min,i.precision)}`,!1):l>i.max?(D.value=!0,S.value=`Значение должно быть не больше ${we(i.max,i.precision)}`,!1):(D.value=!1,S.value="",!0)},X=u=>{const l=u.replace(/[^\d,.-]/g,"");let y=!1;const p=l.split("").filter(R=>R===","||R==="."?y?!1:(y=!0,!0):!0).join("").replace(".",",");N.value=p;const o=le(p);o!==null?E("update:modelValue",o):(p===""||p==="-")&&E("update:modelValue",null)},J=()=>{T.value=!1;const u=le(N.value);if(G(N.value)){if(u!==null){const l=Math.round(u*Math.pow(10,i.precision))/Math.pow(10,i.precision),y=Math.max(i.min,Math.min(i.max,l));E("update:modelValue",y),U(y),E("change",y)}}else if(u!==null&&(u<i.min||u>i.max)){const l=Math.max(i.min,Math.min(i.max,u));E("update:modelValue",l),U(l),E("change",l),D.value=!1,S.value=""}E("blur")},W=()=>{T.value=!0,C.value!==null&&(N.value=String(C.value).replace(".",","))},q=()=>{const u=C.value||0,l=Math.min(i.max,u+i.step),y=Math.round(l*Math.pow(10,i.precision))/Math.pow(10,i.precision);E("update:modelValue",y),E("change",y),U(y)},O=()=>{const u=C.value||0,l=Math.max(i.min,u-i.step),y=Math.round(l*Math.pow(10,i.precision))/Math.pow(10,i.precision);E("update:modelValue",y),E("change",y),U(y)};return _e(()=>i.modelValue,u=>{U(u)},{immediate:!0}),U(i.modelValue),(u,l)=>{const y=_("el-button"),p=_("el-button-group"),o=_("el-input");return n(),b(H,null,[t(o,{ref_key:"inputRef",ref:L,modelValue:N.value,"onUpdate:modelValue":l[0]||(l[0]=R=>N.value=R),placeholder:r.placeholder,disabled:r.disabled,class:kt({"is-invalid":D.value}),onInput:X,onBlur:J,onFocus:W},wt({_:2},[r.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(y,{icon:h(bt),disabled:r.disabled||V.value,onClick:O},null,8,["icon","disabled"]),t(y,{icon:h(ht),disabled:r.disabled||z.value,onClick:q},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),D.value?(n(),b("div",Ft,g(S.value),1)):M("",!0)],64)}}},Ot=be(Ut,[["__scopeId","data-v-74ef628d"]]),Pt={class:"card-header"},zt={key:1},Bt={key:0,class:"metric-description"},Gt={key:2,class:"metrics-info"},Xt={class:"info-row"},qt={key:0,class:"info-row"},jt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(r,{emit:k}){const i=r,E=k,L=w(!1),N=w(!1),T=w(!1),D=w(null),S=w([]),C=w([]),V=w({metrics:{}}),z=w({}),U=Y(()=>!C.value||C.value.length===0?[]:[...new Set(C.value.map(p=>p.source))]),G=Y(()=>!C.value||C.value.length===0?null:new Date),X=async()=>{try{const p=await ge.listMetricDefs(!0);S.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),D.value="Не удалось загрузить определения метрик"}},J=async()=>{L.value=!0,D.value=null;try{const p=await ge.listExtractedMetrics(i.reportId);C.value=p.items||[],V.value.metrics={},C.value.forEach(o=>{V.value.metrics[o.metric_def_id]=le(o.value)}),z.value=JSON.parse(JSON.stringify(V.value.metrics))}catch(p){console.error("Failed to load metrics:",p),D.value="Не удалось загрузить метрики"}finally{L.value=!1}},W=()=>{T.value=!0,z.value=JSON.parse(JSON.stringify(V.value.metrics))},q=()=>{V.value.metrics=JSON.parse(JSON.stringify(z.value)),T.value=!1,D.value=null},O=async()=>{N.value=!0,D.value=null;try{const p=[];for(const[o,R]of Object.entries(V.value.metrics))if(R!=null&&R!==""){const P=Lt(R);P!==null&&p.push({metric_def_id:o,value:P,source:"MANUAL",notes:null})}if(p.length===0){x.warning("Не введено ни одного значения метрики"),N.value=!1;return}await ge.bulkCreateExtractedMetrics(i.reportId,p),x.success(`Успешно сохранено ${p.length} метрик`),T.value=!1,await J(),E("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let o="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?o=p.response.data.detail:Array.isArray(p.response.data.detail)&&(o=p.response.data.detail.map(R=>R.msg||R.message).join(", "))),D.value=o,x.error(o)}finally{N.value=!1}},u=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},l=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},y=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return De(async()=>{await X(),await J()}),_e(()=>i.reportId,async p=>{p&&await J()}),(p,o)=>{const R=_("el-button"),P=_("el-alert"),K=_("el-form-item"),Z=_("el-col"),j=_("el-row"),ee=_("el-form"),oe=_("el-divider"),re=_("el-tag"),te=_("el-card");return n(),v(te,{class:"metrics-editor"},{header:e(()=>[m("div",Pt,[o[4]||(o[4]=m("span",null,"Ручной ввод метрик",-1)),T.value?(n(),b("div",zt,[t(R,{size:"small",onClick:q},{default:e(()=>[...o[2]||(o[2]=[f(" Отмена ",-1)])]),_:1}),t(R,{type:"primary",size:"small",loading:N.value,onClick:O},{default:e(()=>[...o[3]||(o[3]=[f(" Сохранить ",-1)])]),_:1},8,["loading"])])):(n(),v(R,{key:0,type:"primary",size:"small",onClick:W},{default:e(()=>[...o[1]||(o[1]=[f(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[D.value?(n(),v(P,{key:0,type:"error",title:D.value,closable:"",style:{"margin-bottom":"16px"},onClose:o[0]||(o[0]=I=>D.value=null)},null,8,["title"])):M("",!0),!C.value||C.value.length===0?(n(),v(P,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...o[5]||(o[5]=[f(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):M("",!0),t(ee,{ref:"formRef",model:V.value,"label-position":"top",disabled:!T.value},{default:e(()=>[t(j,{gutter:20},{default:e(()=>[(n(!0),b(H,null,Q(S.value,I=>(n(),v(Z,{key:I.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(K,{label:h(Nt)(I),prop:`metrics.${I.id}`},{default:e(()=>[t(Ot,{modelValue:V.value.metrics[I.id],"onUpdate:modelValue":c=>V.value.metrics[I.id]=c,min:I.min_value||1,max:I.max_value||10,precision:1,step:.1,disabled:!T.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),I.description?(n(),b("div",Bt,g(I.description),1)):M("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),C.value&&C.value.length>0?(n(),b("div",Gt,[t(oe),m("div",Xt,[o[6]||(o[6]=m("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),b(H,null,Q(U.value,I=>(n(),v(re,{key:I,type:u(I),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[f(g(l(I)),1)]),_:2},1032,["type"]))),128))]),G.value?(n(),b("div",qt,[o[7]||(o[7]=m("span",{class:"info-label"},"Последнее обновление:",-1)),m("span",null,g(y(G.value)),1)])):M("",!0)])):M("",!0)]),_:1})}}},Jt=be(jt,[["__scopeId","data-v-1e3d866a"]]),Ht={class:"report-list"},Wt={class:"report-list__controls"},Kt={class:"controls-left"},Qt={class:"controls-right"},Yt={class:"filename"},Zt={class:"status-cell"},ea={key:1,class:"report-list__cards"},ta={class:"report-card__header"},aa={class:"report-card__status"},sa={class:"report-card__body"},na={class:"report-card__field"},la={class:"field-value"},oa={class:"report-card__field"},ra={class:"field-value"},ia={class:"report-card__actions"},ua={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(r,{emit:k}){const i=r,E=k,L=Xe(),N=qe(),T=w(window.innerWidth<=768),D=()=>{T.value=window.innerWidth<=768};De(()=>{window.addEventListener("resize",D),L.query.status&&(S.value=L.query.status),L.query.sort&&(C.value=L.query.sort)}),je(()=>{window.removeEventListener("resize",D)});const S=w(""),C=w("desc"),V=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];_e([S,C],([u,l])=>{const y={...L.query};u?y.status=u:delete y.status,l?y.sort=l:delete y.sort,N.replace({query:y})});const z=()=>{},U=()=>{C.value=C.value==="desc"?"asc":"desc"},G=Y(()=>{let u=[...i.reports];return S.value&&(u=u.filter(l=>l.status===S.value)),u.sort((l,y)=>{const p=new Date(l.uploaded_at),o=new Date(y.uploaded_at);return C.value==="desc"?o-p:p-o}),u}),X=Y(()=>S.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),J=u=>{if(!u)return"—";const l=new Date(u);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},W=u=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[u]||u,q=u=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[u]||"info",O=async({action:u,report:l})=>{switch(u){case"view":E("view",l.id);break;case"edit":E("edit",l.id);break;case"extract":E("extract",l.id);break;case"download":E("download",l.id);break;case"delete":try{await Et.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",l.id)}catch{}break}};return(u,l)=>{const y=_("el-option"),p=_("el-select"),o=_("el-icon"),R=_("el-button"),P=_("el-table-column"),K=_("el-tag"),Z=_("el-dropdown-item"),j=_("el-dropdown-menu"),ee=_("el-dropdown"),oe=_("el-table"),re=_("el-card"),te=_("el-empty"),I=Je("loading");return n(),b("div",Ht,[m("div",Wt,[m("div",Kt,[t(p,{modelValue:S.value,"onUpdate:modelValue":l[0]||(l[0]=c=>S.value=c),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:z},{default:e(()=>[t(y,{label:"Все статусы",value:""}),(n(),b(H,null,Q(V,c=>t(y,{key:c.value,label:c.label,value:c.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",Qt,[t(R,{type:C.value==="desc"?"primary":"default",size:"small",onClick:U},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Ct))]),_:1}),f(" "+g(C.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),T.value?fe((n(),b("div",ea,[(n(!0),b(H,null,Q(G.value,c=>(n(),v(re,{key:c.id,class:"report-card",shadow:"hover"},{header:e(()=>[m("div",ta,[m("div",aa,[c.status==="PROCESSING"?(n(),v(o,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(h(Ie))]),_:1})):c.status==="EXTRACTED"?(n(),v(o,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(h(Te))]),_:1})):c.status==="FAILED"?(n(),v(o,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(h(Le))]),_:1})):(n(),v(o,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(h(Fe))]),_:1})),t(K,{type:q(c.status),size:"small"},{default:e(()=>[f(g(W(c.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[m("div",ia,[c.status==="EXTRACTED"?(n(),v(R,{key:0,type:"success",size:"small",onClick:ae=>O({action:"edit",report:c})},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Ue))]),_:1}),l[10]||(l[10]=f(" Редактировать ",-1))]),_:1},8,["onClick"])):M("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(n(),v(R,{key:1,type:"info",size:"small",onClick:ae=>O({action:"view",report:c})},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Oe))]),_:1}),l[11]||(l[11]=f(" Просмотр ",-1))]),_:1},8,["onClick"])):M("",!0),t(R,{type:"primary",size:"small",onClick:ae=>O({action:"extract",report:c})},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Pe))]),_:1}),f(" "+g(c.status==="FAILED"?"Повторить":c.status==="PROCESSING"?"Перезапустить":c.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(R,{size:"small",onClick:ae=>O({action:"download",report:c})},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Ee))]),_:1}),l[12]||(l[12]=f(" Скачать ",-1))]),_:1},8,["onClick"]),t(R,{type:"danger",size:"small",onClick:ae=>O({action:"delete",report:c})},{default:e(()=>[t(o,null,{default:e(()=>[t(h(ze))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[m("div",sa,[m("div",na,[l[8]||(l[8]=m("span",{class:"field-label"},"Файл:",-1)),m("span",la,g(c.file_ref?.filename||"Без названия"),1)]),m("div",oa,[l[9]||(l[9]=m("span",{class:"field-label"},"Дата загрузки:",-1)),m("span",ra,g(J(c.uploaded_at)),1)])])]),_:2},1024))),128)),!G.value.length&&!r.loading?(n(),v(te,{key:0,description:X.value,"image-size":120},{default:e(()=>[S.value?M("",!0):(n(),v(R,{key:0,type:"primary",onClick:l[1]||(l[1]=c=>u.$emit("upload"))},{default:e(()=>[...l[13]||(l[13]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):M("",!0)])),[[I,r.loading]]):fe((n(),v(oe,{key:0,data:G.value,class:"report-list__table",stripe:"","empty-text":X.value},{default:e(()=>[t(P,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:c})=>[m("span",Yt,g(c.file_ref?.filename||"Без названия"),1)]),_:1}),t(P,{prop:"status",label:"Статус",width:"200"},{default:e(({row:c})=>[m("div",Zt,[c.status==="PROCESSING"?(n(),v(o,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(h(Ie))]),_:1})):c.status==="EXTRACTED"?(n(),v(o,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(h(Te))]),_:1})):c.status==="FAILED"?(n(),v(o,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(h(Le))]),_:1})):(n(),v(o,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(h(Fe))]),_:1})),t(K,{type:q(c.status),size:"default"},{default:e(()=>[f(g(W(c.status)),1)]),_:2},1032,["type"])])]),_:1}),t(P,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:c})=>[f(g(J(c.uploaded_at)),1)]),_:1}),t(P,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:c})=>[t(ee,{trigger:"click",onCommand:O},{dropdown:e(()=>[t(j,null,{default:e(()=>[c.status==="EXTRACTED"?(n(),v(Z,{key:0,command:{action:"edit",report:c}},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Ue))]),_:1}),l[4]||(l[4]=f(" Редактировать метрики ",-1))]),_:1},8,["command"])):M("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(n(),v(Z,{key:1,command:{action:"view",report:c}},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Oe))]),_:1}),l[5]||(l[5]=f(" Просмотр метрик ",-1))]),_:1},8,["command"])):M("",!0),t(Z,{command:{action:"extract",report:c}},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Pe))]),_:1}),f(" "+g(c.status==="FAILED"?"Повторить извлечение":c.status==="PROCESSING"?"Перезапустить извлечение":c.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(Z,{divided:"",command:{action:"download",report:c}},{default:e(()=>[t(o,null,{default:e(()=>[t(h(Ee))]),_:1}),l[6]||(l[6]=f(" Скачать ",-1))]),_:1},8,["command"]),t(Z,{command:{action:"delete",report:c},class:"dropdown-item--danger"},{default:e(()=>[t(o,null,{default:e(()=>[t(h(ze))]),_:1}),l[7]||(l[7]=f(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(R,{type:"primary",size:"small"},{default:e(()=>[l[3]||(l[3]=f(" Действия ",-1)),t(o,{class:"el-icon--right"},{default:e(()=>[t(h(Rt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[I,r.loading]]),!G.value.length&&!r.loading&&!T.value?(n(),v(te,{key:2,description:X.value,"image-size":120},{default:e(()=>[S.value?M("",!0):(n(),v(R,{key:0,type:"primary",onClick:l[2]||(l[2]=c=>u.$emit("upload"))},{default:e(()=>[...l[14]||(l[14]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):M("",!0)])}}},da=be(ua,[["__scopeId","data-v-c9651b50"]]),ca={class:"participant-detail"},pa={class:"card-header"},ma={class:"header-actions"},fa={class:"section-header"},_a={class:"section-header"},va={key:1},ya={key:1},ga={class:"scoring-result"},wa={class:"score-value"},ba={class:"score-number"},ha={class:"score-details"},ka={class:"score-section"},Ca={key:0},Ra={class:"score-section"},Ea={key:0},Da={class:"score-section"},Sa={key:0},$a={key:0,class:"recommendation-skill-focus"},Ma={key:1,class:"recommendation-advice"},Aa={key:2,class:"recommendation-formats"},xa={class:"formats-list"},Na={key:0,class:"final-report-actions"},Va={class:"activity-code-hint"},Ia={__name:"ParticipantDetailView",setup(r){const k=qe(),i=Xe(),E=Tt(),L=w(!1),N=w(!1),T=w(!1),D=w(!1),S=w(!1),C=w(!1),V=Y(()=>E.currentParticipant),z=w([]),U=w([]),G=w([]),X=w([]),J=w([]);w([]);const W=w(null),q=w(null),O=w(null),u=Y(()=>z.value.some(a=>a.status==="PROCESSING")),l=Y(()=>U.value.some(a=>a.recommendations_status==="pending")),y=w(!1),p=w(!1),o=w(!1),R=w(null),P=w([]),K=Be({file:null}),Z={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},j=Be({activityCode:""}),ee=a=>{if(!a)return"—";const s=new Date(a);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},oe=a=>a>=80?"success":a>=60?"":"warning",re=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,te=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",I=a=>a>=.8?"var(--color-success)":a>=.6?"var(--color-warning)":"var(--color-danger)",c=new Set,ae=a=>{if(!a)return"—";const s=J.value.find(A=>A.code===a),$=c.has(a)?{warn:()=>{}}:{warn:A=>{c.add(a),console.warn(A)}};return It(s,a,$)},He=async()=>{L.value=!0;try{await E.getParticipant(i.params.id)}catch{x.error("Участник не найден"),k.push("/participants")}finally{L.value=!1}},ie=async({silent:a=!1}={})=>{a||(N.value=!0);try{const s=await Ge.getReports(i.params.id);z.value=s.items||[]}catch(s){console.error("Error loading reports:",s),x.error("Ошибка загрузки списка отчётов")}finally{a||(N.value=!1)}},Se=a=>{if(!a)return a;const s=Array.isArray(a.recommendations)?a.recommendations:[];let $=a.recommendations_status||a.recommendationsStatus||null;$||($=s.length>0?"ready":"pending");const A=Number(a.score_pct),se=Number.isNaN(A)?a.score_pct:A;return{...a,score_pct:se,recommendations:s,recommendations_status:$,recommendations_error:a.recommendations_error||a.recommendationsError||null}},$e=async()=>{try{const a=await Re.getHistory(i.params.id),s=Array.isArray(a.items)?a.items:[];U.value=s.map(Se)}catch(a){console.error("Error loading scoring results:",a)}},We=async()=>{T.value=!0;try{const a=await Vt.list();G.value=a||[]}catch{x.error("Ошибка загрузки профессиональных областей")}finally{T.value=!1}},Ke=async()=>{try{const a=await ge.listMetricDefs(!0);J.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},ue=async({silent:a=!1}={})=>{a||(D.value=!0);try{const s=await Ge.getMetrics(i.params.id);console.log("[DEBUG] loadParticipantMetrics response:",s),console.log("[DEBUG] response.metrics length:",s.metrics?.length||0),X.value=s.metrics||[],console.log("[DEBUG] participantMetrics.value length:",X.value.length)}catch(s){console.error("Error loading participant metrics:",s),x.error("Ошибка загрузки метрик участника")}finally{a||(D.value=!1)}},Qe=a=>{K.file=a.raw,P.value=[a]},Ye=async()=>{R.value&&await R.value.validate(async a=>{if(a){if(!K.file){x.error("Выберите файл");return}S.value=!0;try{await ye.upload(i.params.id,K.file),x.success("Отчёт загружен успешно"),y.value=!1,K.file=null,P.value=[],await ie(),await ue()}catch{x.error("Ошибка загрузки отчёта")}finally{S.value=!1}}})},Ze=async a=>{try{const s=await ye.download(a),$=window.URL.createObjectURL(new Blob([s.data])),A=document.createElement("a");A.href=$,A.setAttribute("download",`report_${a}.docx`),document.body.appendChild(A),A.click(),A.remove(),window.URL.revokeObjectURL($),x.success("Отчёт скачан")}catch{x.error("Ошибка скачивания отчёта")}},et=async a=>{try{await ye.extract(a),x.success("Извлечение метрик запущено"),await ie()}catch{x.error("Ошибка запуска извлечения метрик")}},tt=()=>{q.value||(q.value=setInterval(async()=>{try{await ie({silent:!0}),await ue({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Me=()=>{q.value&&(clearInterval(q.value),q.value=null)},at=()=>{O.value||(O.value=setInterval(async()=>{try{await $e()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Ae=()=>{O.value&&(clearInterval(O.value),O.value=null)};_e(u,a=>{a?tt():Me()}),_e(l,a=>{a?at():Ae()});const xe=async a=>{W.value=a,await At(),o.value=!0},st=async()=>{x.success("Метрики обновлены"),await ue()},nt=async a=>{try{await ye.delete(a),x.success("Отчёт удалён"),await ie()}catch{x.error("Ошибка удаления отчёта")}},lt=async()=>{if(!j.activityCode){x.warning("Выберите профессиональную область");return}C.value=!0;try{const a=await Re.calculate(i.params.id,j.activityCode),s=Se({id:a.scoring_result_id,participant_id:i.params.id,prof_activity_code:a.prof_activity_code||j.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});U.value.unshift(s),x.success("Расчёт пригодности выполнен"),p.value=!1,j.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const s=a.response?.data?.detail||"Ошибка расчёта пригодности";x.error(s)}finally{C.value=!1}},ot=async a=>{if(!a.prof_activity_code){x.warning("Код профессиональной деятельности не найден");return}try{const s=await Re.downloadFinalReportPdf(i.params.id,a.prof_activity_code),$=window.URL.createObjectURL(new Blob([s.data])),A=document.createElement("a");A.href=$,A.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(A),A.click(),A.remove(),window.URL.revokeObjectURL($),x.success("Отчёт PDF скачан")}catch(s){const $=s.response?.data?.detail||"Ошибка загрузки PDF отчёта";x.error($)}},rt=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,it=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return De(async()=>{await He(),await ie(),await $e(),await We(),await Ke(),await ue()}),je(()=>{Me(),Ae()}),(a,s)=>{const $=_("el-button"),A=_("el-icon"),se=_("el-descriptions-item"),ut=_("el-descriptions"),de=_("el-card"),ne=_("el-table-column"),he=_("el-tag"),dt=_("el-table"),ve=_("el-empty"),ct=_("el-progress"),ce=_("el-alert"),pt=_("el-timeline-item"),mt=_("el-timeline"),ft=_("el-upload"),Ne=_("el-form-item"),Ve=_("el-form"),ke=_("el-dialog"),_t=_("el-option"),vt=_("el-select"),Ce=Je("loading");return n(),v(xt,null,{default:e(()=>[fe((n(),b("div",ca,[V.value?(n(),v(de,{key:0,class:"detail-card"},{header:e(()=>[m("div",pa,[m("h2",null,g(V.value.full_name),1),m("div",ma,[t($,{onClick:s[0]||(s[0]=d=>h(k).back())},{default:e(()=>[...s[10]||(s[10]=[f(" Назад ",-1)])]),_:1}),t($,{type:"primary",onClick:s[1]||(s[1]=d=>p.value=!0)},{default:e(()=>[t(A,null,{default:e(()=>[t(h(Dt))]),_:1}),s[11]||(s[11]=f(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(ut,{column:2,border:""},{default:e(()=>[t(se,{label:"ФИО"},{default:e(()=>[f(g(V.value.full_name),1)]),_:1}),t(se,{label:"Дата рождения"},{default:e(()=>[f(g(V.value.birth_date||"Не указана"),1)]),_:1}),t(se,{label:"Внешний ID"},{default:e(()=>[f(g(V.value.external_id||"Не указан"),1)]),_:1}),t(se,{label:"Дата создания"},{default:e(()=>[f(g(ee(V.value.created_at)),1)]),_:1})]),_:1})]),_:1})):M("",!0),t(de,{class:"section-card"},{header:e(()=>[m("div",fa,[s[13]||(s[13]=m("h3",null,"Отчёты",-1)),t($,{type:"primary",onClick:s[2]||(s[2]=d=>y.value=!0)},{default:e(()=>[t(A,null,{default:e(()=>[t(h(St))]),_:1}),s[12]||(s[12]=f(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(da,{reports:z.value,loading:N.value,onView:xe,onEdit:xe,onExtract:et,onDownload:Ze,onDelete:nt,onUpload:s[3]||(s[3]=d=>y.value=!0)},null,8,["reports","loading"])]),_:1}),t(de,{class:"section-card"},{header:e(()=>[m("div",_a,[s[15]||(s[15]=m("h3",null,"Актуальные метрики участника",-1)),t($,{type:"primary",size:"small",onClick:ue},{default:e(()=>[t(A,null,{default:e(()=>[t(h(Mt))]),_:1}),s[14]||(s[14]=f(" Обновить ",-1))]),_:1})])]),default:e(()=>[fe((n(),v(dt,{data:X.value,stripe:""},{default:e(()=>[t(ne,{prop:"metric_code",label:"Код метрики",width:"200"}),t(ne,{label:"Название метрики","min-width":"250"},{default:e(({row:d})=>[f(g(ae(d.metric_code)),1)]),_:1}),t(ne,{prop:"value",label:"Значение",width:"120"},{default:e(({row:d})=>[t(he,{type:"success"},{default:e(()=>[f(g(h(me)(d.value)),1)]),_:2},1024)]),_:1}),t(ne,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:d})=>[d.confidence!==null?(n(),b("span",{key:0,style:$t({color:I(d.confidence)})},g((d.confidence*100).toFixed(0))+"% ",5)):(n(),b("span",va,"—"))]),_:1}),t(ne,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:d})=>[f(g(ee(d.updated_at)),1)]),_:1}),t(ne,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:d})=>[d.last_source_report_id?(n(),v(he,{key:0,size:"small"},{default:e(()=>[...s[16]||(s[16]=[f(" Из отчёта ",-1)])]),_:1})):(n(),b("span",ya,"—"))]),_:1})]),_:1},8,["data"])),[[Ce,D.value]]),!X.value.length&&!D.value?(n(),v(ve,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):M("",!0)]),_:1}),U.value.length>0?(n(),v(de,{key:1,class:"section-card"},{header:e(()=>[...s[17]||(s[17]=[m("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(mt,null,{default:e(()=>[(n(!0),b(H,null,Q(U.value,d=>(n(),v(pt,{key:d.id,timestamp:ee(d.created_at),placement:"top"},{default:e(()=>[t(de,null,{default:e(()=>[m("h4",null,g(d.prof_activity_name),1),m("div",ga,[m("div",wa,[m("span",ba,g(d.score_pct)+"%",1),t(ct,{percentage:d.score_pct,status:oe(d.score_pct)},null,8,["percentage","status"])]),m("div",ha,[m("div",ka,[s[18]||(s[18]=m("h5",null,"Сильные стороны:",-1)),d.strengths&&d.strengths.length?(n(),b("ul",Ca,[(n(!0),b(H,null,Q(d.strengths,(F,pe)=>(n(),b("li",{key:pe},[m("strong",null,g(F.metric_name),1),f(" — "+g(h(me)(F.value))+" (вес "+g(h(me)(F.weight,2))+") ",1)]))),128))])):(n(),v(ve,{key:1,description:"Нет данных","image-size":60}))]),m("div",Ra,[s[19]||(s[19]=m("h5",null,"Зоны развития:",-1)),d.dev_areas&&d.dev_areas.length?(n(),b("ul",Ea,[(n(!0),b(H,null,Q(d.dev_areas,(F,pe)=>(n(),b("li",{key:pe},[m("strong",null,g(F.metric_name),1),f(" — "+g(h(me)(F.value))+" (вес "+g(h(me)(F.weight,2))+") ",1)]))),128))])):(n(),v(ve,{key:1,description:"Нет данных","image-size":60}))]),m("div",Da,[m("h5",null,[s[20]||(s[20]=f(" Рекомендации: ",-1)),d.recommendations_status?(n(),v(he,{key:0,type:te(d.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[f(g(re(d.recommendations_status)),1)]),_:2},1032,["type"])):M("",!0)]),rt(d)?(n(),b("ul",Sa,[(n(!0),b(H,null,Q(d.recommendations,(F,pe)=>(n(),b("li",{key:pe,class:"recommendation-item"},[m("strong",null,g(F.title),1),F.skill_focus?(n(),b("div",$a,[s[21]||(s[21]=m("strong",null,"Навык:",-1)),f(" "+g(F.skill_focus),1)])):M("",!0),F.development_advice?(n(),b("div",Ma,g(F.development_advice),1)):M("",!0),F.recommended_formats&&F.recommended_formats.length>0?(n(),b("div",Aa,[s[22]||(s[22]=m("strong",null,"Рекомендуемые форматы:",-1)),m("ul",xa,[(n(!0),b(H,null,Q(F.recommended_formats,(yt,gt)=>(n(),b("li",{key:gt},g(yt),1))),128))])])):M("",!0)]))),128))])):d.recommendations_status==="pending"?(n(),v(ce,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):d.recommendations_status==="error"?(n(),v(ce,{key:2,title:it(d),type:"error",closable:!1,"show-icon":""},null,8,["title"])):d.recommendations_status==="disabled"?(n(),v(ce,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(n(),v(ve,{key:4,description:"Нет данных","image-size":60}))])]),d.prof_activity_code?(n(),b("div",Na,[t($,{type:"primary",size:"small",onClick:F=>ot(d)},{default:e(()=>[t(A,null,{default:e(()=>[t(h(Ee))]),_:1}),s[23]||(s[23]=f(" Скачать PDF ",-1))]),_:1},8,["onClick"])])):M("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):M("",!0),t(ke,{modelValue:y.value,"onUpdate:modelValue":s[5]||(s[5]=d=>y.value=d),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t($,{onClick:s[4]||(s[4]=d=>y.value=!1)},{default:e(()=>[...s[26]||(s[26]=[f(" Отмена ",-1)])]),_:1}),t($,{type:"primary",loading:S.value,onClick:Ye},{default:e(()=>[...s[27]||(s[27]=[f(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Ve,{ref_key:"uploadFormRef",ref:R,model:K,rules:Z,"label-position":"top"},{default:e(()=>[t(Ne,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(ft,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Qe,"file-list":P.value},{tip:e(()=>[...s[25]||(s[25]=[m("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t($,{type:"primary"},{default:e(()=>[...s[24]||(s[24]=[f(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ke,{modelValue:p.value,"onUpdate:modelValue":s[8]||(s[8]=d=>p.value=d),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t($,{onClick:s[7]||(s[7]=d=>p.value=!1)},{default:e(()=>[...s[28]||(s[28]=[f(" Отмена ",-1)])]),_:1}),t($,{type:"primary",loading:C.value,disabled:!j.activityCode||z.value.length===0,onClick:lt},{default:e(()=>[...s[29]||(s[29]=[f(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Ve,{model:j,"label-position":"top"},{default:e(()=>[t(Ne,{label:"Профессиональная область",required:""},{default:e(()=>[fe((n(),v(vt,{modelValue:j.activityCode,"onUpdate:modelValue":s[6]||(s[6]=d=>j.activityCode=d),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(n(!0),b(H,null,Q(G.value,d=>(n(),v(_t,{key:d.code,label:d.name,value:d.code},{default:e(()=>[m("span",null,g(d.name),1),m("span",Va,g(d.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Ce,T.value]])]),_:1}),t(ce,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),z.value.length===0?(n(),v(ce,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):M("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ke,{modelValue:o.value,"onUpdate:modelValue":s[9]||(s[9]=d=>o.value=d),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[W.value?(n(),v(Jt,{key:0,"report-id":W.value,onMetricsUpdated:st},null,8,["report-id"])):M("",!0)]),_:1},8,["modelValue"])])),[[Ce,L.value]])]),_:1})}}},Pa=be(Ia,[["__scopeId","data-v-1c1c817f"]]);export{Pa as default};
