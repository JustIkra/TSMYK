import{P as J,m as h,Q as H,p as ee,r as _,c as S,o as n,d as t,x as A,R as Ct,w as e,u as g,S as $t,L as Rt,z as qe,B as w,F as Z,H as Ee,v as f,f as v,C as Y,a as p,E as I,q as Xe,e as Ge,I as je,J as Se,K as ce,T as Dt,U as he,k as ke,V as Ce,g as $e,W as Et,X as ze,Y as Ue,h as Pe,Z as Re,_ as De,O as St,$ as Je,M as xt,n as Mt,a0 as At,t as Vt,a1 as Oe,G as It}from"./index-W21bR5uH.js";import{A as Nt}from"./AppLayout-DXhjPsAy.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as Ft,m as de,g as Lt,p as Tt}from"./metricNames-CvSOkbdc.js";import{p as We,u as zt}from"./participants-C9aOVkZ4.js";const fe={async upload(i,C){const r=new FormData;return r.append("file",C),(await J.post(`/participants/${i}/reports`,r,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(i){return await J.get(`/reports/${i}/download`,{responseType:"blob"})},async getById(i){return(await J.get(`/reports/${i}`)).data},async delete(i){return(await J.delete(`/reports/${i}`)).data},async extract(i){return(await J.post(`/reports/${i}/extract`)).data},async getMetrics(i){return(await J.get(`/reports/${i}/metrics`)).data},async getList(i){return(await J.get(`/participants/${i}/reports`)).data}},we={async calculate(i,C){return(await J.post(`/scoring/participants/${i}/calculate`,null,{params:{activity_code:C}})).data},async getHistory(i,C=10){return(await J.get(`/scoring/participants/${i}/scores`,{params:{limit:C}})).data},async getById(i){return(await J.get(`/scoring-results/${i}`)).data},async generateRecommendations(i){return(await J.post(`/reports/${i}/recommendations`)).data},async getFinalReport(i,C,r="json"){const D={params:{activity_code:C,format:r}};r==="html"&&(D.responseType="text");const F=await J.get(`/participants/${i}/final-report`,D);return F.data},async downloadFinalReportPdf(i,C){return await J.get(`/participants/${i}/final-report`,{params:{activity_code:C,format:"pdf"},responseType:"blob"})}};function _e(i,C=1){if(i==null||i==="")return"";const r=typeof i=="string"?parseFloat(i):i;return isNaN(r)?"":r.toLocaleString("ru-RU",{minimumFractionDigits:C,maximumFractionDigits:C})}function oe(i){if(i==null||i==="")return null;const r=String(i).trim().replace(",","."),D=parseFloat(r);return isNaN(D)?null:D}function Ut(i){return oe(i)}function ue(i,C=1){return _e(i,C)}const Pt={key:0,class:"error-message"},Ot={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(i,{emit:C}){const r=i,D=C,F=h(null),V=h(""),L=h(!1),x=h(!1),M=h(""),R=H(()=>oe(V.value)),T=H(()=>{const d=R.value;return d===null||d<=r.min}),B=H(()=>{const d=R.value;return d===null||d>=r.max}),q=d=>{if(d==null||d===""){V.value="";return}L.value?V.value=String(d).replace(".",","):V.value=_e(d,r.precision)},X=d=>{if(d==null||d==="")return x.value=!1,M.value="",!0;const l=oe(d);return l===null?(x.value=!0,M.value="Некорректное число",!1):l<r.min?(x.value=!0,M.value=`Значение должно быть не меньше ${_e(r.min,r.precision)}`,!1):l>r.max?(x.value=!0,M.value=`Значение должно быть не больше ${_e(r.max,r.precision)}`,!1):(x.value=!1,M.value="",!0)},k=d=>{const l=d.replace(/[^\d,.-]/g,"");let b=!1;const m=l.split("").filter(y=>y===","||y==="."?b?!1:(b=!0,!0):!0).join("").replace(".",",");V.value=m;const u=oe(m);u!==null?D("update:modelValue",u):(m===""||m==="-")&&D("update:modelValue",null)},U=()=>{L.value=!1;const d=oe(V.value);if(X(V.value)){if(d!==null){const l=Math.round(d*Math.pow(10,r.precision))/Math.pow(10,r.precision),b=Math.max(r.min,Math.min(r.max,l));D("update:modelValue",b),q(b),D("change",b)}}else if(d!==null&&(d<r.min||d>r.max)){const l=Math.max(r.min,Math.min(r.max,d));D("update:modelValue",l),q(l),D("change",l),x.value=!1,M.value=""}D("blur")},j=()=>{L.value=!0,R.value!==null&&(V.value=String(R.value).replace(".",","))},G=()=>{const d=R.value||0,l=Math.min(r.max,d+r.step),b=Math.round(l*Math.pow(10,r.precision))/Math.pow(10,r.precision);D("update:modelValue",b),D("change",b),q(b)},N=()=>{const d=R.value||0,l=Math.max(r.min,d-r.step),b=Math.round(l*Math.pow(10,r.precision))/Math.pow(10,r.precision);D("update:modelValue",b),D("change",b),q(b)};return ee(()=>r.modelValue,d=>{q(d)},{immediate:!0}),q(r.modelValue),(d,l)=>{const b=_("el-button"),m=_("el-button-group"),u=_("el-input");return n(),S(Z,null,[t(u,{ref_key:"inputRef",ref:F,modelValue:V.value,"onUpdate:modelValue":l[0]||(l[0]=y=>V.value=y),placeholder:i.placeholder,disabled:i.disabled,class:qe({"is-invalid":x.value}),onInput:k,onBlur:U,onFocus:j},Ct({_:2},[i.showControls?{name:"append",fn:e(()=>[t(m,null,{default:e(()=>[t(b,{icon:g($t),disabled:i.disabled||T.value,onClick:N},null,8,["icon","disabled"]),t(b,{icon:g(Rt),disabled:i.disabled||B.value,onClick:G},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),x.value?(n(),S("div",Pt,w(M.value),1)):A("",!0)],64)}}},Bt=pe(Ot,[["__scopeId","data-v-74ef628d"]]),qt={class:"card-header"},Xt={key:1},Gt={key:0,class:"metric-description"},jt={key:2,class:"metrics-info"},Jt={class:"info-row"},Wt={key:0,class:"info-row"},Ht={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(i,{emit:C}){const r=i,D=C,F=h(!1),V=h(!1),L=h(!1),x=h(null),M=h([]),R=h([]),T=h({metrics:{}}),B=h({}),q=H(()=>!R.value||R.value.length===0?[]:[...new Set(R.value.map(m=>m.source))]),X=H(()=>!R.value||R.value.length===0?null:new Date),k=async()=>{try{const m=await de.listMetricDefs(!0);M.value=m.items||[]}catch(m){console.error("Failed to load metric definitions:",m),x.value="Не удалось загрузить определения метрик"}},U=async()=>{F.value=!0,x.value=null;try{const m=await de.listExtractedMetrics(r.reportId);R.value=m.items||[],T.value.metrics={},R.value.forEach(u=>{T.value.metrics[u.metric_def_id]=oe(u.value)}),B.value=JSON.parse(JSON.stringify(T.value.metrics))}catch(m){console.error("Failed to load metrics:",m),x.value="Не удалось загрузить метрики"}finally{F.value=!1}},j=()=>{L.value=!0,B.value=JSON.parse(JSON.stringify(T.value.metrics))},G=()=>{T.value.metrics=JSON.parse(JSON.stringify(B.value)),L.value=!1,x.value=null},N=async()=>{V.value=!0,x.value=null;try{const m=[];for(const[u,y]of Object.entries(T.value.metrics))if(y!=null&&y!==""){const P=Ut(y);P!==null&&m.push({metric_def_id:u,value:P,source:"MANUAL",notes:null})}if(m.length===0){I.warning("Не введено ни одного значения метрики"),V.value=!1;return}await de.bulkCreateExtractedMetrics(r.reportId,m),I.success(`Успешно сохранено ${m.length} метрик`),L.value=!1,await U(),D("metrics-updated")}catch(m){console.error("Failed to save metrics:",m);let u="Не удалось сохранить метрики";m.response?.data?.detail&&(typeof m.response.data.detail=="string"?u=m.response.data.detail:Array.isArray(m.response.data.detail)&&(u=m.response.data.detail.map(y=>y.msg||y.message).join(", "))),x.value=u,I.error(u)}finally{V.value=!1}},d=m=>{switch(m){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},l=m=>{switch(m){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return m}},b=m=>new Date(m).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Ee(async()=>{await k(),await U()}),ee(()=>r.reportId,async m=>{m&&await U()}),(m,u)=>{const y=_("el-button"),P=_("el-alert"),te=_("el-form-item"),z=_("el-col"),re=_("el-row"),W=_("el-form"),ae=_("el-divider"),ie=_("el-tag"),se=_("el-card");return n(),f(se,{class:"metrics-editor"},{header:e(()=>[p("div",qt,[u[4]||(u[4]=p("span",null,"Ручной ввод метрик",-1)),L.value?(n(),S("div",Xt,[t(y,{size:"small",onClick:G},{default:e(()=>[...u[2]||(u[2]=[v(" Отмена ",-1)])]),_:1}),t(y,{type:"primary",size:"small",loading:V.value,onClick:N},{default:e(()=>[...u[3]||(u[3]=[v(" Сохранить ",-1)])]),_:1},8,["loading"])])):(n(),f(y,{key:0,type:"primary",size:"small",onClick:j},{default:e(()=>[...u[1]||(u[1]=[v(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[x.value?(n(),f(P,{key:0,type:"error",title:x.value,closable:"",style:{"margin-bottom":"16px"},onClose:u[0]||(u[0]=O=>x.value=null)},null,8,["title"])):A("",!0),!R.value||R.value.length===0?(n(),f(P,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...u[5]||(u[5]=[v(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):A("",!0),t(W,{ref:"formRef",model:T.value,"label-position":"top",disabled:!L.value},{default:e(()=>[t(re,{gutter:20},{default:e(()=>[(n(!0),S(Z,null,Y(M.value,O=>(n(),f(z,{key:O.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(te,{label:g(Ft)(O),prop:`metrics.${O.id}`},{default:e(()=>[t(Bt,{modelValue:T.value.metrics[O.id],"onUpdate:modelValue":c=>T.value.metrics[O.id]=c,min:O.min_value||1,max:O.max_value||10,precision:1,step:.1,disabled:!L.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),O.description?(n(),S("div",Gt,w(O.description),1)):A("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),R.value&&R.value.length>0?(n(),S("div",jt,[t(ae),p("div",Jt,[u[6]||(u[6]=p("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),S(Z,null,Y(q.value,O=>(n(),f(ie,{key:O,type:d(O),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[v(w(l(O)),1)]),_:2},1032,["type"]))),128))]),X.value?(n(),S("div",Wt,[u[7]||(u[7]=p("span",{class:"info-label"},"Последнее обновление:",-1)),p("span",null,w(b(X.value)),1)])):A("",!0)])):A("",!0)]),_:1})}}},Kt=pe(Ht,[["__scopeId","data-v-1e3d866a"]]),Zt={class:"report-list"},Qt={class:"report-list__controls"},Yt={class:"controls-left"},ea={class:"controls-right"},ta={class:"filename"},aa={class:"status-cell"},sa={key:1,class:"report-list__cards"},na={class:"report-card__header"},la={class:"report-card__status"},oa={class:"report-card__body"},ra={class:"report-card__field"},ia={class:"field-value field-value--filename"},ua={class:"report-card__field"},da={class:"field-value"},ca={class:"report-card__actions"},pa={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(i,{emit:C}){const r=i,D=C,F=Xe(),V=Ge(),L=h(window.innerWidth<=768),x=()=>{L.value=window.innerWidth<=768};Ee(()=>{window.addEventListener("resize",x),F.query.status&&(M.value=F.query.status),F.query.sort&&(R.value=F.query.sort)}),je(()=>{window.removeEventListener("resize",x)});const M=h(""),R=h("desc"),T=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ee([M,R],([d,l])=>{const b={...F.query};d?b.status=d:delete b.status,l?b.sort=l:delete b.sort,V.replace({query:b})});const B=()=>{},q=()=>{R.value=R.value==="desc"?"asc":"desc"},X=H(()=>{let d=[...r.reports];return M.value&&(d=d.filter(l=>l.status===M.value)),d.sort((l,b)=>{const m=new Date(l.uploaded_at),u=new Date(b.uploaded_at);return R.value==="desc"?u-m:m-u}),d}),k=H(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),U=d=>{if(!d)return"—";const l=new Date(d);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},j=d=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[d]||d,G=d=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[d]||"info",N=async({action:d,report:l})=>{switch(d){case"view":D("view",l.id);break;case"edit":D("edit",l.id);break;case"extract":D("extract",l.id);break;case"download":D("download",l.id);break;case"delete":try{await St.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),D("delete",l.id)}catch{}break}};return(d,l)=>{const b=_("el-option"),m=_("el-select"),u=_("el-icon"),y=_("el-button"),P=_("el-table-column"),te=_("el-tag"),z=_("el-dropdown-item"),re=_("el-dropdown-menu"),W=_("el-dropdown"),ae=_("el-table"),ie=_("el-card"),se=_("el-empty"),O=Se("loading");return n(),S("div",Zt,[p("div",Qt,[p("div",Yt,[t(m,{modelValue:M.value,"onUpdate:modelValue":l[0]||(l[0]=c=>M.value=c),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(b,{label:"Все статусы",value:""}),(n(),S(Z,null,Y(T,c=>t(b,{key:c.value,label:c.label,value:c.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),p("div",ea,[t(y,{type:R.value==="desc"?"primary":"default",size:"small",onClick:q},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Dt))]),_:1}),v(" "+w(R.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),L.value?ce((n(),S("div",sa,[(n(!0),S(Z,null,Y(X.value,c=>(n(),f(ie,{key:c.id,class:"report-card",shadow:"hover"},{header:e(()=>[p("div",na,[p("div",la,[c.status==="PROCESSING"?(n(),f(u,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(g(he))]),_:1})):c.status==="EXTRACTED"?(n(),f(u,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(g(ke))]),_:1})):c.status==="FAILED"?(n(),f(u,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(g(Ce))]),_:1})):(n(),f(u,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(g($e))]),_:1})),t(te,{type:G(c.status),size:"small"},{default:e(()=>[v(w(j(c.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[p("div",ca,[c.status==="EXTRACTED"?(n(),f(y,{key:0,type:"success",size:"small",onClick:K=>N({action:"edit",report:c})},{default:e(()=>[t(u,null,{default:e(()=>[t(g(ze))]),_:1}),l[10]||(l[10]=v(" Редактировать ",-1))]),_:1},8,["onClick"])):A("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(n(),f(y,{key:1,type:"info",size:"small",onClick:K=>N({action:"view",report:c})},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Ue))]),_:1}),l[11]||(l[11]=v(" Просмотр ",-1))]),_:1},8,["onClick"])):A("",!0),t(y,{type:"primary",size:"small",onClick:K=>N({action:"extract",report:c})},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Pe))]),_:1}),v(" "+w(c.status==="FAILED"?"Повторить":c.status==="PROCESSING"?"Перезапустить":c.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(y,{size:"small",onClick:K=>N({action:"download",report:c})},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Re))]),_:1}),l[12]||(l[12]=v(" Скачать ",-1))]),_:1},8,["onClick"]),t(y,{type:"danger",size:"small",onClick:K=>N({action:"delete",report:c})},{default:e(()=>[t(u,null,{default:e(()=>[t(g(De))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[p("div",oa,[p("div",ra,[l[8]||(l[8]=p("span",{class:"field-label"},"Файл:",-1)),p("span",ia,w(c.file_ref?.filename||"Без названия"),1)]),p("div",ua,[l[9]||(l[9]=p("span",{class:"field-label"},"Дата загрузки:",-1)),p("span",da,w(U(c.uploaded_at)),1)])])]),_:2},1024))),128)),!X.value.length&&!i.loading?(n(),f(se,{key:0,description:k.value,"image-size":120},{default:e(()=>[M.value?A("",!0):(n(),f(y,{key:0,type:"primary",onClick:l[1]||(l[1]=c=>d.$emit("upload"))},{default:e(()=>[...l[13]||(l[13]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])),[[O,i.loading]]):ce((n(),f(ae,{key:0,data:X.value,class:"report-list__table",stripe:"","empty-text":k.value},{default:e(()=>[t(P,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:c})=>[p("span",ta,w(c.file_ref?.filename||"Без названия"),1)]),_:1}),t(P,{prop:"status",label:"Статус",width:"200"},{default:e(({row:c})=>[p("div",aa,[c.status==="PROCESSING"?(n(),f(u,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(g(he))]),_:1})):c.status==="EXTRACTED"?(n(),f(u,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(g(ke))]),_:1})):c.status==="FAILED"?(n(),f(u,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(g(Ce))]),_:1})):(n(),f(u,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(g($e))]),_:1})),t(te,{type:G(c.status),size:"default"},{default:e(()=>[v(w(j(c.status)),1)]),_:2},1032,["type"])])]),_:1}),t(P,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:c})=>[v(w(U(c.uploaded_at)),1)]),_:1}),t(P,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:c})=>[t(W,{trigger:"click",onCommand:N},{dropdown:e(()=>[t(re,null,{default:e(()=>[c.status==="EXTRACTED"?(n(),f(z,{key:0,command:{action:"edit",report:c}},{default:e(()=>[t(u,null,{default:e(()=>[t(g(ze))]),_:1}),l[4]||(l[4]=v(" Редактировать метрики ",-1))]),_:1},8,["command"])):A("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(n(),f(z,{key:1,command:{action:"view",report:c}},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Ue))]),_:1}),l[5]||(l[5]=v(" Просмотр метрик ",-1))]),_:1},8,["command"])):A("",!0),t(z,{command:{action:"extract",report:c}},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Pe))]),_:1}),v(" "+w(c.status==="FAILED"?"Повторить извлечение":c.status==="PROCESSING"?"Перезапустить извлечение":c.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(z,{divided:"",command:{action:"download",report:c}},{default:e(()=>[t(u,null,{default:e(()=>[t(g(Re))]),_:1}),l[6]||(l[6]=v(" Скачать ",-1))]),_:1},8,["command"]),t(z,{command:{action:"delete",report:c},class:"dropdown-item--danger"},{default:e(()=>[t(u,null,{default:e(()=>[t(g(De))]),_:1}),l[7]||(l[7]=v(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(y,{type:"primary",size:"small"},{default:e(()=>[l[3]||(l[3]=v(" Действия ",-1)),t(u,{class:"el-icon--right"},{default:e(()=>[t(g(Et))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[O,i.loading]]),!X.value.length&&!i.loading&&!L.value?(n(),f(se,{key:2,description:k.value,"image-size":120},{default:e(()=>[M.value?A("",!0):(n(),f(y,{key:0,type:"primary",onClick:l[2]||(l[2]=c=>d.$emit("upload"))},{default:e(()=>[...l[14]||(l[14]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])}}},ma=pe(pa,[["__scopeId","data-v-d4a9cae6"]]),fa={class:"metrics-drawer"},_a={class:"drawer-actions"},va={key:1},ya={key:1},ga={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:C}){const r=i,D=C,F=h(!1),V=h([]),L=h([]),x=H(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),M=k=>{D("update:modelValue",k)},R=async()=>{try{const k=await de.listMetricDefs(!0);L.value=k.items||[]}catch(k){console.error("Error loading metric definitions:",k)}},T=async()=>{F.value=!0;try{const k=await We.getMetrics(r.participantId);V.value=k.metrics||[]}catch(k){console.error("Error loading participant metrics:",k),I.error("Ошибка загрузки метрик участника")}finally{F.value=!1}},B=k=>{if(!k)return"—";const U=L.value.find(G=>G.code===k);return Lt(U,k,{warn:()=>{}})},q=k=>k>=.8?"var(--el-color-success)":k>=.6?"var(--el-color-warning)":"var(--el-color-danger)",X=k=>{if(!k)return"—";const U=new Date(k);return Number.isNaN(U.getTime())?"—":U.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return ee(()=>r.participantId,async k=>{k&&r.modelValue&&(await R(),await T())}),ee(()=>r.modelValue,async k=>{k&&r.participantId&&(await R(),await T())}),(k,U)=>{const j=_("el-icon"),G=_("el-button"),N=_("el-table-column"),d=_("el-tag"),l=_("el-table"),b=_("el-empty"),m=_("el-drawer"),u=Se("loading");return n(),f(m,{"model-value":i.modelValue,title:`Метрики участника: ${i.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":M},{default:e(()=>[ce((n(),S("div",fa,[p("div",_a,[t(G,{type:"primary",size:"small",onClick:T},{default:e(()=>[t(j,null,{default:e(()=>[t(g(Je))]),_:1}),U[0]||(U[0]=v(" Обновить ",-1))]),_:1})]),t(l,{data:V.value,stripe:"","empty-text":x.value},{default:e(()=>[t(N,{prop:"metric_code",label:"Код метрики",width:"200"}),t(N,{label:"Название метрики","min-width":"250"},{default:e(({row:y})=>[v(w(B(y.metric_code)),1)]),_:1}),t(N,{prop:"value",label:"Значение",width:"120"},{default:e(({row:y})=>[t(d,{type:"success"},{default:e(()=>[v(w(g(ue)(y.value)),1)]),_:2},1024)]),_:1}),t(N,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:y})=>[y.confidence!==null?(n(),S("span",{key:0,style:xt({color:q(y.confidence)})},w((y.confidence*100).toFixed(0))+"% ",5)):(n(),S("span",va,"—"))]),_:1}),t(N,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:y})=>[v(w(X(y.updated_at)),1)]),_:1}),t(N,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:y})=>[y.last_source_report_id?(n(),f(d,{key:0,size:"small"},{default:e(()=>[...U[1]||(U[1]=[v(" Из отчёта ",-1)])]),_:1})):(n(),S("span",ya,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!V.value.length&&!F.value?(n(),f(b,{key:0,description:x.value},null,8,["description"])):A("",!0)])),[[u,F.value]])]),_:1},8,["model-value","title"])}}},wa=pe(ga,[["__scopeId","data-v-93720633"]]),ba={class:"participant-detail"},ha={class:"card-header"},ka={class:"header-actions"},Ca={class:"section-header"},$a={class:"scoring-result"},Ra={class:"score-value"},Da={class:"score-number"},Ea={class:"score-details"},Sa={class:"score-section"},xa={key:0},Ma={class:"score-section"},Aa={key:0},Va={class:"score-section recommendations-status-section"},Ia={class:"recommendations-pending-alert"},Na={key:0,class:"final-report-actions"},Fa={key:0,class:"batch-files-list"},La={class:"batch-files-header"},Ta={class:"batch-file-info"},za={class:"batch-file-name"},Ua={class:"batch-file-size"},Pa={key:0,class:"batch-file-error"},Oa={class:"activity-code-hint"},Be=20*1024*1024,be=10,Ba={__name:"ParticipantDetailView",setup(i){const C=Ge(),r=Xe(),D=zt(),F=h(!1),V=h(!1),L=h(window.innerWidth<=768),x=()=>{L.value=window.innerWidth<=768},M=h(!1),R=h(!1),T=h(!1),B=H(()=>D.currentParticipant),q=h([]),X=h([]),k=h([]),U=h([]),j=h(null),G=h(null),N=h(null),d=H(()=>q.value.some(a=>a.status==="PROCESSING")),l=H(()=>X.value.some(a=>a.recommendations_status==="pending")),b=h(!1),m=h(!1),u=h(!1),y=h(!1),P=h(null),te=h([]),z=h([]);let re=0;const W=Mt({activityCode:""}),ae=a=>{if(!a)return"—";const s=new Date(a);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},ie=a=>a>=80?"success":a>=60?"":"warning",se=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,O=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",c=async()=>{F.value=!0;try{await D.getParticipant(r.params.id)}catch{I.error("Участник не найден"),C.push("/participants")}finally{F.value=!1}},K=async({silent:a=!1}={})=>{a||(V.value=!0);try{const s=await We.getReports(r.params.id);q.value=s.items||[]}catch(s){console.error("Error loading reports:",s),I.error("Ошибка загрузки списка отчётов")}finally{a||(V.value=!1)}},xe=a=>{if(!a)return a;const s=Array.isArray(a.recommendations)?a.recommendations:[];let E=a.recommendations_status||a.recommendationsStatus||null;E||(E=s.length>0?"ready":"pending");const $=Number(a.score_pct),ne=Number.isNaN($)?a.score_pct:$;return{...a,score_pct:ne,recommendations:s,recommendations_status:E,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Me=async()=>{try{const a=await we.getHistory(r.params.id),s=Array.isArray(a.items)?a.items:[];X.value=s.map(xe)}catch(a){console.error("Error loading scoring results:",a)}},He=async()=>{M.value=!0;try{const a=await Tt.list();k.value=a||[]}catch{I.error("Ошибка загрузки профессиональных областей")}finally{M.value=!1}},Ke=async()=>{try{const a=await de.listMetricDefs(!0);U.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},Ae=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB",Ze=a=>a.name.toLowerCase().endsWith(".docx")?a.size>Be?`Размер файла превышает ${Ae(Be)}`:null:"Только файлы формата .docx",Qe=(a,s)=>{const E=a.raw;if(z.value.length>=be){I.warning(`Максимальное количество файлов: ${be}`),P.value&&P.value.clearFiles();return}const $=Ze(E);if($){I.error($),P.value&&P.value.clearFiles();return}z.value.push({id:++re,file:E,name:E.name,size:E.size,status:"pending",progress:0,error:null,reportId:null}),P.value&&P.value.clearFiles()},Ye=a=>{z.value=z.value.filter(s=>s.id!==a)},et=async a=>{a.status="uploading",a.progress=0;try{const s=await fe.upload(r.params.id,a.file);a.status="success",a.reportId=s.id}catch(s){a.status="error",a.error=s.response?.data?.detail||"Ошибка загрузки"}},tt=async()=>{const a=z.value.filter(s=>s.status==="pending");if(a.length===0){I.warning("Нет файлов для загрузки");return}R.value=!0;try{await Promise.allSettled(a.map($=>et($)));const s=z.value.filter($=>$.status==="success").length,E=z.value.filter($=>$.status==="error").length;E===0?(I.success(`Загружено ${s} отчётов`),b.value=!1,Ve()):I.warning(`Загружено: ${s}, ошибок: ${E}`),await K()}finally{R.value=!1}},Ve=()=>{z.value=[],te.value=[],P.value&&P.value.clearFiles()},at=async a=>{try{const s=await fe.download(a),E=window.URL.createObjectURL(new Blob([s.data])),$=document.createElement("a");$.href=E,$.setAttribute("download",`report_${a}.docx`),document.body.appendChild($),$.click(),$.remove(),window.URL.revokeObjectURL(E),I.success("Отчёт скачан")}catch{I.error("Ошибка скачивания отчёта")}},st=async a=>{try{await fe.extract(a),I.success("Извлечение метрик запущено"),await K()}catch{I.error("Ошибка запуска извлечения метрик")}},nt=()=>{G.value||(G.value=setInterval(async()=>{try{await K({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Ie=()=>{G.value&&(clearInterval(G.value),G.value=null)},lt=()=>{N.value||(N.value=setInterval(async()=>{try{await Me()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Ne=()=>{N.value&&(clearInterval(N.value),N.value=null)};ee(d,a=>{a?nt():Ie()}),ee(l,a=>{a?lt():Ne()});const Fe=async a=>{j.value=a,await It(),u.value=!0},ot=async()=>{I.success("Метрики обновлены")},rt=async a=>{try{await fe.delete(a),I.success("Отчёт удалён"),await K()}catch{I.error("Ошибка удаления отчёта")}},it=async()=>{if(!W.activityCode){I.warning("Выберите профессиональную область");return}T.value=!0;try{const a=await we.calculate(r.params.id,W.activityCode),s=xe({id:a.scoring_result_id,participant_id:r.params.id,prof_activity_code:a.prof_activity_code||W.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});X.value.unshift(s),I.success("Расчёт пригодности выполнен"),m.value=!1,W.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const s=a.response?.data?.detail||"Ошибка расчёта пригодности";I.error(s)}finally{T.value=!1}},ut=async a=>{if(!a.prof_activity_code){I.warning("Код профессиональной деятельности не найден");return}try{const s=await we.downloadFinalReportPdf(r.params.id,a.prof_activity_code),E=window.URL.createObjectURL(new Blob([s.data])),$=document.createElement("a");$.href=E,$.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild($),$.click(),$.remove(),window.URL.revokeObjectURL(E),I.success("Отчёт PDF скачан")}catch(s){const E=s.response?.data?.detail||"Ошибка загрузки PDF отчёта";I.error(E)}},Le=a=>a?.recommendations_status==="ready"||a?.recommendations_status==="disabled",dt=a=>a?.recommendations_status==="pending"?"Дождитесь завершения генерации рекомендаций":a?.recommendations_status==="error"?"Ошибка генерации рекомендаций. Попробуйте пересчитать пригодность":"",ct=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Ee(async()=>{window.addEventListener("resize",x),await c(),await K(),await Me(),await He(),await Ke()}),je(()=>{window.removeEventListener("resize",x),Ie(),Ne()}),(a,s)=>{const E=_("el-button"),$=_("el-icon"),ne=_("el-descriptions-item"),pt=_("el-descriptions"),me=_("el-card"),mt=_("el-progress"),ve=_("el-empty"),ft=_("el-tag"),le=_("el-alert"),_t=_("el-tooltip"),vt=_("el-timeline-item"),yt=_("el-timeline"),gt=_("el-upload"),ye=_("el-dialog"),wt=_("el-option"),bt=_("el-select"),ht=_("el-form-item"),kt=_("el-form"),Te=Se("loading");return n(),f(Nt,null,{default:e(()=>[ce((n(),S("div",ba,[B.value?(n(),f(me,{key:0,class:"detail-card"},{header:e(()=>[p("div",ha,[p("h2",null,w(B.value.full_name),1),p("div",ka,[t(E,{onClick:s[0]||(s[0]=o=>g(C).back())},{default:e(()=>[...s[12]||(s[12]=[v(" Назад ",-1)])]),_:1}),t(E,{type:"info",onClick:s[1]||(s[1]=o=>y.value=!0)},{default:e(()=>[t($,null,{default:e(()=>[t(g(At))]),_:1}),s[13]||(s[13]=v(" Метрики ",-1))]),_:1}),t(E,{type:"primary",onClick:s[2]||(s[2]=o=>m.value=!0)},{default:e(()=>[t($,null,{default:e(()=>[t(g(Vt))]),_:1}),s[14]||(s[14]=v(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(pt,{column:L.value?1:2,border:""},{default:e(()=>[t(ne,{label:"ФИО"},{default:e(()=>[v(w(B.value.full_name),1)]),_:1}),t(ne,{label:"Дата рождения"},{default:e(()=>[v(w(B.value.birth_date||"Не указана"),1)]),_:1}),t(ne,{label:"Внешний ID"},{default:e(()=>[v(w(B.value.external_id||"Не указан"),1)]),_:1}),t(ne,{label:"Дата создания"},{default:e(()=>[v(w(ae(B.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):A("",!0),t(me,{class:"section-card"},{header:e(()=>[p("div",Ca,[s[16]||(s[16]=p("h3",null,"Отчёты",-1)),t(E,{type:"primary",onClick:s[3]||(s[3]=o=>b.value=!0)},{default:e(()=>[t($,null,{default:e(()=>[t(g(Oe))]),_:1}),s[15]||(s[15]=v(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(ma,{reports:q.value,loading:V.value,onView:Fe,onEdit:Fe,onExtract:st,onDownload:at,onDelete:rt,onUpload:s[4]||(s[4]=o=>b.value=!0)},null,8,["reports","loading"])]),_:1}),X.value.length>0?(n(),f(me,{key:1,class:"section-card"},{header:e(()=>[...s[17]||(s[17]=[p("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(yt,null,{default:e(()=>[(n(!0),S(Z,null,Y(X.value,o=>(n(),f(vt,{key:o.id,timestamp:ae(o.created_at),placement:"top"},{default:e(()=>[t(me,null,{default:e(()=>[p("h4",null,w(o.prof_activity_name),1),p("div",$a,[p("div",Ra,[p("span",Da,w(o.score_pct)+"%",1),t(mt,{percentage:o.score_pct,status:ie(o.score_pct)},null,8,["percentage","status"])]),p("div",Ea,[p("div",Sa,[s[18]||(s[18]=p("h5",null,"Сильные стороны:",-1)),o.strengths&&o.strengths.length?(n(),S("ul",xa,[(n(!0),S(Z,null,Y(o.strengths,(Q,ge)=>(n(),S("li",{key:ge},[p("strong",null,w(Q.metric_name),1),v(" — "+w(g(ue)(Q.value))+" (вес "+w(g(ue)(Q.weight,2))+") ",1)]))),128))])):(n(),f(ve,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ma,[s[19]||(s[19]=p("h5",null,"Зоны развития:",-1)),o.dev_areas&&o.dev_areas.length?(n(),S("ul",Aa,[(n(!0),S(Z,null,Y(o.dev_areas,(Q,ge)=>(n(),S("li",{key:ge},[p("strong",null,w(Q.metric_name),1),v(" — "+w(g(ue)(Q.value))+" (вес "+w(g(ue)(Q.weight,2))+") ",1)]))),128))])):(n(),f(ve,{key:1,description:"Нет данных","image-size":60}))]),p("div",Va,[p("h5",null,[s[20]||(s[20]=v(" Рекомендации: ",-1)),o.recommendations_status?(n(),f(ft,{key:0,type:O(o.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[v(w(se(o.recommendations_status)),1)]),_:2},1032,["type"])):A("",!0)]),o.recommendations_status==="pending"?(n(),f(le,{key:0,type:"info",closable:!1,"show-icon":""},{title:e(()=>[p("div",Ia,[t($,{class:"is-loading"},{default:e(()=>[t(g(Je))]),_:1}),s[21]||(s[21]=p("span",null,"Рекомендации формируются...",-1))])]),default:e(()=>[...s[22]||(s[22]=[v(" Кнопка «Скачать PDF» станет доступна после завершения генерации. ",-1)])]),_:1})):o.recommendations_status==="ready"?(n(),f(le,{key:1,title:"Рекомендации готовы",type:"success",closable:!1,"show-icon":""},{default:e(()=>[...s[23]||(s[23]=[v(" Персональные рекомендации доступны в итоговом PDF-отчёте. ",-1)])]),_:1})):o.recommendations_status==="error"?(n(),f(le,{key:2,title:ct(o),type:"error",closable:!1,"show-icon":""},{default:e(()=>[...s[24]||(s[24]=[v(" Не удалось сформировать рекомендации. Попробуйте пересчитать пригодность. ",-1)])]),_:1},8,["title"])):o.recommendations_status==="disabled"?(n(),f(le,{key:3,title:"Генерация рекомендаций отключена",type:"warning",closable:!1,"show-icon":""},{default:e(()=>[...s[25]||(s[25]=[v(" Генерация рекомендаций отключена для данного окружения. ",-1)])]),_:1})):(n(),f(ve,{key:4,description:"Статус рекомендаций неизвестен","image-size":60}))])]),o.prof_activity_code?(n(),S("div",Na,[t(_t,{disabled:Le(o),content:dt(o),placement:"top"},{default:e(()=>[p("span",null,[t(E,{type:"primary",size:"small",disabled:!Le(o),loading:o.recommendations_status==="pending",onClick:Q=>ut(o)},{default:e(()=>[o.recommendations_status!=="pending"?(n(),f($,{key:0},{default:e(()=>[t(g(Re))]),_:1})):A("",!0),v(" "+w(o.recommendations_status==="pending"?"Формируется...":"Скачать PDF"),1)]),_:2},1032,["disabled","loading","onClick"])])]),_:2},1032,["disabled","content"])])):A("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):A("",!0),t(ye,{modelValue:b.value,"onUpdate:modelValue":s[6]||(s[6]=o=>b.value=o),title:"Загрузить отчёты",width:L.value?"95%":"600px",onClose:Ve},{footer:e(()=>[t(E,{onClick:s[5]||(s[5]=o=>b.value=!1)},{default:e(()=>[...s[28]||(s[28]=[v(" Отмена ",-1)])]),_:1}),t(E,{type:"primary",loading:R.value,disabled:!z.value.some(o=>o.status==="pending"),onClick:tt},{default:e(()=>[v(" Загрузить все ("+w(z.value.filter(o=>o.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(gt,{ref_key:"uploadRef",ref:P,"auto-upload":!1,multiple:"",accept:".docx","on-change":Qe,"show-file-list":!1,drag:""},{tip:e(()=>[...s[26]||(s[26]=[p("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t($,{class:"el-icon--upload"},{default:e(()=>[t(g(Oe))]),_:1}),s[27]||(s[27]=p("div",{class:"el-upload__text"},[v(" Перетащите файлы сюда или "),p("em",null,"нажмите для выбора")],-1))]),_:1},512),z.value.length?(n(),S("div",Fa,[p("div",La," Выбрано файлов: "+w(z.value.length)+"/"+w(be),1),(n(!0),S(Z,null,Y(z.value,o=>(n(),S("div",{key:o.id,class:qe(["batch-file-item","batch-file-item--"+o.status])},[o.status==="pending"?(n(),f($,{key:0,class:"batch-file-icon"},{default:e(()=>[t(g($e))]),_:1})):o.status==="uploading"?(n(),f($,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(g(he))]),_:1})):o.status==="success"?(n(),f($,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(g(ke))]),_:1})):o.status==="error"?(n(),f($,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(g(Ce))]),_:1})):A("",!0),p("div",Ta,[p("span",za,w(o.name),1),p("span",Ua,w(Ae(o.size)),1),o.error?(n(),S("span",Pa,w(o.error),1)):A("",!0)]),o.status==="pending"||o.status==="error"?(n(),f(E,{key:4,type:"danger",icon:g(De),circle:"",size:"small",onClick:Q=>Ye(o.id)},null,8,["icon","onClick"])):A("",!0)],2))),128))])):A("",!0)]),_:1},8,["modelValue","width"]),t(ye,{modelValue:m.value,"onUpdate:modelValue":s[9]||(s[9]=o=>m.value=o),title:"Рассчитать профессиональную пригодность",width:L.value?"95%":"500px"},{footer:e(()=>[t(E,{onClick:s[8]||(s[8]=o=>m.value=!1)},{default:e(()=>[...s[29]||(s[29]=[v(" Отмена ",-1)])]),_:1}),t(E,{type:"primary",loading:T.value,disabled:!W.activityCode||q.value.length===0,onClick:it},{default:e(()=>[...s[30]||(s[30]=[v(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(kt,{model:W,"label-position":"top"},{default:e(()=>[t(ht,{label:"Профессиональная область",required:""},{default:e(()=>[ce((n(),f(bt,{modelValue:W.activityCode,"onUpdate:modelValue":s[7]||(s[7]=o=>W.activityCode=o),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(n(!0),S(Z,null,Y(k.value,o=>(n(),f(wt,{key:o.code,label:o.name,value:o.code},{default:e(()=>[p("span",null,w(o.name),1),p("span",Oa,w(o.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Te,M.value]])]),_:1}),t(le,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),q.value.length===0?(n(),f(le,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):A("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),t(ye,{modelValue:u.value,"onUpdate:modelValue":s[10]||(s[10]=o=>u.value=o),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[j.value?(n(),f(Kt,{key:0,"report-id":j.value,onMetricsUpdated:ot},null,8,["report-id"])):A("",!0)]),_:1},8,["modelValue"]),t(wa,{modelValue:y.value,"onUpdate:modelValue":s[11]||(s[11]=o=>y.value=o),"participant-id":B.value?.id,"participant-name":B.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Te,F.value]])]),_:1})}}},Wa=pe(Ba,[["__scopeId","data-v-02ebd03f"]]);export{Wa as default};
