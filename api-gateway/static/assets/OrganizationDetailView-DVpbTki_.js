import{m as o,n as S,H as Ye,v as U,w as l,q as Ne,E as u,d as Oe,r,I as qe,o as d,J as ne,c as y,x as T,f as a,u as f,e as i,B as v,a as w,K as de,F as ue,C as pe,z as Se,a4 as Ie,M as Le,N as me}from"./index-Cpha-uY-.js";import{A as He}from"./AppLayout-BawcAUH5.js";import{p as ce}from"./participants-DHCamnVR.js";import{o as x}from"./organizations-qlb8mTtI.js";import{a as Je}from"./dateFormat-Bky3s5gS.js";import{u as Ke}from"./useResponsive-Bs0VDHwx.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const je={class:"org-detail"},Ge={class:"card-header"},We={class:"header-actions"},Xe={key:1,class:"departments-section"},Ze={class:"section-header"},ea={key:1,class:"departments-list"},aa={class:"dept-header"},ta=["onClick"],la={class:"dept-name"},na={class:"dept-actions"},ia={key:0,class:"dept-description"},oa={key:1,class:"dept-participants"},ra={class:"participant-search-list"},sa={key:0,class:"participant-ext-id"},da={__name:"OrganizationDetailView",setup(ua){const I=Oe(),b=Ne(),{isMobile:F}=Ke(),L=o(!1),p=o(!1),m=o(null),D=o({}),H=o({}),J=o({}),R=o(!1),K=o(null),C=S({name:"",description:""}),fe={name:[{required:!0,message:"Введите название",trigger:"blur"}]},B=o(!1),Q=o(null),h=S({name:"",description:""}),ie={name:[{required:!0,message:"Введите название отдела",trigger:"blur"}]},A=o(!1),j=o(null),_=S({id:null,name:"",description:""}),E=o(!1),G=o("existing"),g=o(null),$=o([]),M=o([]),Y=o(!1),W=o("");let oe=null;const X=o(null),c=S({full_name:"",birth_date:"",external_id:""}),ve={full_name:[{required:!0,message:"Введите ФИО",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},z=async()=>{L.value=!0;try{const n=await x.getById(b.params.id);m.value=n}catch{u.error("Организация не найдена"),I.push("/organizations")}finally{L.value=!1}},_e=async()=>{K.value&&await K.value.validate(async n=>{if(n){p.value=!0;try{await x.update(b.params.id,C),u.success("Организация обновлена"),R.value=!1,await z()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления")}finally{p.value=!1}}})},ye=async()=>{Q.value&&await Q.value.validate(async n=>{if(n){p.value=!0;try{await x.createDepartment(b.params.id,h),u.success("Отдел создан"),B.value=!1,h.name="",h.description="",await z()}catch(e){u.error(e.response?.data?.detail||"Ошибка создания отдела")}finally{p.value=!1}}})},ge=n=>{_.id=n.id,_.name=n.name,_.description=n.description||"",A.value=!0},we=async()=>{j.value&&await j.value.validate(async n=>{if(n){p.value=!0;try{await x.updateDepartment(b.params.id,_.id,{name:_.name,description:_.description}),u.success("Отдел обновлён"),A.value=!1,await z()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления отдела")}finally{p.value=!1}}})},be=n=>{me.confirm(`Удалить отдел "${n.name}"? Участники будут отвязаны, но не удалены.`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await x.deleteDepartment(b.params.id,n.id),u.success("Отдел удалён"),await z()}catch{u.error("Ошибка удаления отдела")}}).catch(()=>{})},Ve=async n=>{if(D.value[n]){D.value[n]=!1;return}D.value[n]=!0,await N(n)},N=async n=>{J.value[n]=!0;try{const e=await x.listDepartmentParticipants(b.params.id,n);H.value[n]=e}catch{u.error("Ошибка загрузки участников отдела")}finally{J.value[n]=!1}},ke=async n=>{g.value=n,$.value=[],M.value=[],W.value="",G.value="existing",c.full_name="",c.birth_date="",c.external_id="",E.value=!0,await re("")},re=async n=>{Y.value=!0;try{const e={size:50};n&&n.length>=2&&(e.query=n);const s=await ce.search(e);M.value=s.items||[]}catch{M.value=[]}finally{Y.value=!1}},xe=n=>{clearTimeout(oe),oe=setTimeout(()=>{re(n)},300)},De=async()=>{if(!(!$.value.length||!g.value)){p.value=!0;try{await x.attachParticipants(b.params.id,g.value.id,$.value),u.success("Участники привязаны"),E.value=!1,await z(),D.value[g.value.id]&&await N(g.value.id)}catch(n){u.error(n.response?.data?.detail||"Ошибка привязки участников")}finally{p.value=!1}}},Ce=async()=>{!X.value||!g.value||await X.value.validate(async n=>{if(n){p.value=!0;try{const e=await ce.create({full_name:c.full_name,birth_date:c.birth_date||null,external_id:c.external_id||null});await x.attachParticipants(b.params.id,g.value.id,[e.id]),u.success(`Участник "${e.full_name}" создан и привязан`),E.value=!1,await z(),D.value[g.value.id]&&await N(g.value.id)}catch(e){u.error(e.response?.data?.detail||"Ошибка создания участника")}finally{p.value=!1}}})},he=(n,e)=>{me.confirm(`Отвязать "${e.full_name}" от отдела "${n.name}"?`,"Подтверждение",{confirmButtonText:"Отвязать",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await x.detachParticipant(b.params.id,n.id,e.id),u.success("Участник отвязан"),await z(),await N(n.id)}catch{u.error("Ошибка отвязки участника")}}).catch(()=>{})};return Ye(async()=>{await z(),m.value&&(C.name=m.value.name,C.description=m.value.description||"")}),(n,e)=>{const s=r("el-button"),O=r("el-descriptions-item"),ze=r("el-descriptions"),Pe=r("el-card"),Z=r("el-icon"),ee=r("el-empty"),$e=r("el-tag"),Ue=r("el-link"),ae=r("el-table-column"),Fe=r("el-table"),V=r("el-input"),k=r("el-form-item"),q=r("el-form"),te=r("el-dialog"),Re=r("el-checkbox"),Be=r("el-checkbox-group"),se=r("el-tab-pane"),Ae=r("el-date-picker"),Ee=r("el-tabs"),Me=r("el-drawer"),le=qe("loading");return d(),U(He,null,{default:l(()=>[ne((d(),y("div",je,[m.value?(d(),U(Pe,{key:0,class:"detail-card"},{header:l(()=>[w("div",Ge,[w("h2",null,v(m.value.name),1),w("div",We,[a(s,{onClick:e[0]||(e[0]=t=>f(I).push("/organizations"))},{default:l(()=>[...e[22]||(e[22]=[i(" Назад ",-1)])]),_:1}),a(s,{type:"primary",onClick:e[1]||(e[1]=t=>R.value=!0)},{default:l(()=>[...e[23]||(e[23]=[i(" Редактировать ",-1)])]),_:1})])])]),default:l(()=>[a(ze,{column:f(F)?1:2,border:""},{default:l(()=>[a(O,{label:"Название"},{default:l(()=>[i(v(m.value.name),1)]),_:1}),a(O,{label:"Описание"},{default:l(()=>[i(v(m.value.description||"Не указано"),1)]),_:1}),a(O,{label:"Дата создания"},{default:l(()=>[i(v(f(Je)(m.value.created_at)),1)]),_:1}),a(O,{label:"Кол-во отделов"},{default:l(()=>[i(v(m.value.departments?.length||0),1)]),_:1})]),_:1},8,["column"])]),_:1})):T("",!0),m.value?(d(),y("div",Xe,[w("div",Ze,[e[25]||(e[25]=w("h3",null,"Отделы",-1)),a(s,{type:"primary",onClick:e[2]||(e[2]=t=>B.value=!0)},{default:l(()=>[a(Z,null,{default:l(()=>[a(f(de))]),_:1}),e[24]||(e[24]=i(" Добавить отдел ",-1))]),_:1})]),m.value.departments?.length?(d(),y("div",ea,[(d(!0),y(ue,null,pe(m.value.departments,t=>(d(),y("div",{key:t.id,class:"dept-item"},[w("div",aa,[w("div",{class:"dept-title",onClick:P=>Ve(t.id)},[a(Z,{class:Se(["dept-expand-icon",{"is-expanded":D.value[t.id]}])},{default:l(()=>[a(f(Ie))]),_:1},8,["class"]),w("span",la,v(t.name),1),a($e,{size:"small",type:"info"},{default:l(()=>[i(v(t.participants_count)+" уч. ",1)]),_:2},1024)],8,ta),w("div",na,[a(s,{size:"small",type:"primary",plain:"",onClick:P=>ke(t)},{default:l(()=>[a(Z,null,{default:l(()=>[a(f(de))]),_:1}),e[26]||(e[26]=i(" Добавить ",-1))]),_:1},8,["onClick"]),a(s,{size:"small",onClick:P=>ge(t)},{default:l(()=>[...e[27]||(e[27]=[i(" Изменить ",-1)])]),_:1},8,["onClick"]),a(s,{size:"small",type:"danger",plain:"",onClick:P=>be(t)},{default:l(()=>[...e[28]||(e[28]=[i(" Удалить ",-1)])]),_:1},8,["onClick"])])]),t.description&&D.value[t.id]?(d(),y("div",ia,v(t.description),1)):T("",!0),D.value[t.id]?ne((d(),y("div",oa,[H.value[t.id]?.length?(d(),U(Fe,{key:1,data:H.value[t.id],size:"small",stripe:""},{default:l(()=>[a(ae,{label:"ФИО"},{default:l(({row:P})=>[a(Ue,{type:"primary",underline:!1,onClick:Te=>f(I).push(`/participants/${P.id}`)},{default:l(()=>[i(v(P.full_name),1)]),_:2},1032,["onClick"])]),_:1}),a(ae,{prop:"external_id",label:"Внешний ID",width:"150"}),a(ae,{label:"",width:"120",align:"center"},{default:l(({row:P})=>[a(s,{type:"warning",size:"small",plain:"",onClick:Te=>he(t,P)},{default:l(()=>[...e[29]||(e[29]=[i(" Отвязать ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])):(d(),U(ee,{key:0,description:"Нет участников","image-size":60}))])),[[le,J.value[t.id]]]):T("",!0)]))),128))])):(d(),U(ee,{key:0,description:"Нет отделов","image-size":80}))])):T("",!0),a(te,{modelValue:R.value,"onUpdate:modelValue":e[6]||(e[6]=t=>R.value=t),title:"Редактировать организацию",width:f(F)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[5]||(e[5]=t=>R.value=!1)},{default:l(()=>[...e[30]||(e[30]=[i(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:_e},{default:l(()=>[...e[31]||(e[31]=[i(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(q,{ref_key:"editFormRef",ref:K,model:C,rules:fe,"label-position":"top"},{default:l(()=>[a(k,{label:"Название",prop:"name"},{default:l(()=>[a(V,{modelValue:C.name,"onUpdate:modelValue":e[3]||(e[3]=t=>C.name=t)},null,8,["modelValue"])]),_:1}),a(k,{label:"Описание",prop:"description"},{default:l(()=>[a(V,{modelValue:C.description,"onUpdate:modelValue":e[4]||(e[4]=t=>C.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(te,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=t=>B.value=t),title:"Добавить отдел",width:f(F)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[9]||(e[9]=t=>B.value=!1)},{default:l(()=>[...e[32]||(e[32]=[i(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:ye},{default:l(()=>[...e[33]||(e[33]=[i(" Создать ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(q,{ref_key:"deptFormRef",ref:Q,model:h,rules:ie,"label-position":"top"},{default:l(()=>[a(k,{label:"Название",prop:"name"},{default:l(()=>[a(V,{modelValue:h.name,"onUpdate:modelValue":e[7]||(e[7]=t=>h.name=t),placeholder:"Введите название отдела"},null,8,["modelValue"])]),_:1}),a(k,{label:"Описание",prop:"description"},{default:l(()=>[a(V,{modelValue:h.description,"onUpdate:modelValue":e[8]||(e[8]=t=>h.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(te,{modelValue:A.value,"onUpdate:modelValue":e[14]||(e[14]=t=>A.value=t),title:"Редактировать отдел",width:f(F)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[13]||(e[13]=t=>A.value=!1)},{default:l(()=>[...e[34]||(e[34]=[i(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:we},{default:l(()=>[...e[35]||(e[35]=[i(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(q,{ref_key:"editDeptFormRef",ref:j,model:_,rules:ie,"label-position":"top"},{default:l(()=>[a(k,{label:"Название",prop:"name"},{default:l(()=>[a(V,{modelValue:_.name,"onUpdate:modelValue":e[11]||(e[11]=t=>_.name=t)},null,8,["modelValue"])]),_:1}),a(k,{label:"Описание",prop:"description"},{default:l(()=>[a(V,{modelValue:_.description,"onUpdate:modelValue":e[12]||(e[12]=t=>_.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(Me,{modelValue:E.value,"onUpdate:modelValue":e[21]||(e[21]=t=>E.value=t),title:"Добавить участника — "+(g.value?.name||""),size:f(F)?"100%":"480px",direction:"rtl","destroy-on-close":""},{default:l(()=>[a(Ee,{modelValue:G.value,"onUpdate:modelValue":e[20]||(e[20]=t=>G.value=t)},{default:l(()=>[a(se,{label:"Найти существующего",name:"existing"},{default:l(()=>[a(V,{modelValue:W.value,"onUpdate:modelValue":e[15]||(e[15]=t=>W.value=t),placeholder:"Поиск по имени...",clearable:"","prefix-icon":f(Le),style:{"margin-bottom":"var(--spacing-md)"},onInput:xe},null,8,["modelValue","prefix-icon"]),ne((d(),y("div",ra,[!Y.value&&!M.value.length?(d(),U(ee,{key:0,description:"Участники не найдены","image-size":60})):(d(),U(Be,{key:1,modelValue:$.value,"onUpdate:modelValue":e[16]||(e[16]=t=>$.value=t)},{default:l(()=>[(d(!0),y(ue,null,pe(M.value,t=>(d(),y("div",{key:t.id,class:"participant-search-item"},[a(Re,{value:t.id},{default:l(()=>[w("span",null,v(t.full_name),1),t.external_id?(d(),y("span",sa,v(t.external_id),1)):T("",!0)]),_:2},1032,["value"])]))),128))]),_:1},8,["modelValue"]))])),[[le,Y.value]]),a(s,{type:"primary",loading:p.value,disabled:!$.value.length,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:De},{default:l(()=>[i(" Привязать ("+v($.value.length)+") ",1)]),_:1},8,["loading","disabled"])]),_:1}),a(se,{label:"Создать нового",name:"create"},{default:l(()=>[a(q,{ref_key:"newParticipantFormRef",ref:X,model:c,rules:ve,"label-position":"top"},{default:l(()=>[a(k,{label:"ФИО",prop:"full_name"},{default:l(()=>[a(V,{modelValue:c.full_name,"onUpdate:modelValue":e[17]||(e[17]=t=>c.full_name=t),placeholder:"Введите полное имя"},null,8,["modelValue"])]),_:1}),a(k,{label:"Дата рождения",prop:"birth_date"},{default:l(()=>[a(Ae,{modelValue:c.birth_date,"onUpdate:modelValue":e[18]||(e[18]=t=>c.birth_date=t),type:"date",placeholder:"Выберите дату",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(k,{label:"Внешний ID",prop:"external_id"},{default:l(()=>[a(V,{modelValue:c.external_id,"onUpdate:modelValue":e[19]||(e[19]=t=>c.external_id=t),placeholder:"Внешний идентификатор (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),a(s,{type:"primary",loading:p.value,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:Ce},{default:l(()=>[...e[36]||(e[36]=[i(" Создать и привязать ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title","size"])])),[[le,L.value]])]),_:1})}}},ga=Qe(da,[["__scopeId","data-v-62a0d101"]]);export{ga as default};
