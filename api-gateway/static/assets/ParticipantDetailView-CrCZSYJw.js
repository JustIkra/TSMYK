import{O as W,m as y,P as Y,p as ne,r as p,c as S,o as l,d as t,x as V,Q as Rt,w as e,u as d,R as St,K as Et,z as Qe,B as w,F as te,H as Ye,S as it,v as _,f as m,a as r,C as se,T as he,U as xt,V as Dt,W as Mt,X as It,L as ut,Y as Vt,Z as et,E as T,q as ct,e as dt,I as tt,J as be,_ as At,k as Je,$ as He,g as Ke,a0 as Ft,a1 as st,a2 as lt,h as nt,a3 as We,a4 as Ze,N as Tt,n as Nt,a5 as zt,t as Pt,a6 as ot,G as Lt}from"./index-NAK3em8G.js";import{A as Ot}from"./AppLayout-BOcAUkeW.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as Ut,a as Bt,m as we,b as ke,g as Xt,p as Gt}from"./dateFormat-BLAc33Sw.js";import{a as pt,p as mt,u as qt}from"./useResponsive-BCdKrgNn.js";const ge={async upload(i,R){const o=new FormData;return o.append("file",R),(await W.post(`/participants/${i}/reports`,o,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(i){return await W.get(`/reports/${i}/download`,{responseType:"blob"})},async getById(i){return(await W.get(`/reports/${i}`)).data},async delete(i){return(await W.delete(`/reports/${i}`)).data},async extract(i){return(await W.post(`/reports/${i}/extract`)).data},async getMetrics(i){return(await W.get(`/reports/${i}/metrics`)).data},async getList(i){return(await W.get(`/participants/${i}/reports`)).data},async getReportImages(i){return(await W.get(`/reports/${i}/images`)).data}},qe={async calculate(i,R){return(await W.post(`/scoring/participants/${i}/calculate`,null,{params:{activity_code:R}})).data},async getHistory(i,R=10){return(await W.get(`/scoring/participants/${i}/scores`,{params:{limit:R}})).data},async getById(i){return(await W.get(`/scoring-results/${i}`)).data},async generateRecommendations(i){return(await W.post(`/reports/${i}/recommendations`)).data},async getFinalReport(i,R,o="json"){const E={params:{activity_code:R,format:o}};o==="html"&&(E.responseType="text");const z=await W.get(`/participants/${i}/final-report`,E);return z.data},async downloadFinalReportPdf(i,R,o=null){const E={activity_code:R,format:"pdf"};return o&&(E.scoring_result_id=o),await W.get(`/participants/${i}/final-report`,{params:E,responseType:"blob"})}};function Ae(i,R=1){if(i==null||i==="")return"";const o=typeof i=="string"?parseFloat(i):i;return isNaN(o)?"":o.toLocaleString("ru-RU",{minimumFractionDigits:R,maximumFractionDigits:R})}function fe(i){if(i==null||i==="")return null;const o=String(i).trim().replace(",","."),E=parseFloat(o);return isNaN(E)?null:E}function jt(i){return fe(i)}function ye(i,R=1){return Ae(i,R)}const Jt={key:0,class:"error-message"},Ht={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(i,{emit:R}){const o=i,E=R,z=y(null),P=y(""),O=y(!1),$=y(!1),N=y(""),q=Y(()=>fe(P.value)),X=Y(()=>{const v=q.value;return v===null||v<=o.min}),G=Y(()=>{const v=q.value;return v===null||v>=o.max}),D=v=>{if(v==null||v===""){P.value="";return}O.value?P.value=String(v).replace(".",","):P.value=Ae(v,o.precision)},b=v=>{if(v==null||v==="")return $.value=!1,N.value="",!0;const A=fe(v);return A===null?($.value=!0,N.value="Некорректное число",!1):A<o.min?($.value=!0,N.value=`Значение должно быть не меньше ${Ae(o.min,o.precision)}`,!1):A>o.max?($.value=!0,N.value=`Значение должно быть не больше ${Ae(o.max,o.precision)}`,!1):($.value=!1,N.value="",!0)},j=v=>{const A=v.replace(/[^\d,.-]/g,"");let f=!1;const M=A.split("").filter(Z=>Z===","||Z==="."?f?!1:(f=!0,!0):!0).join("").replace(".",",");P.value=M;const F=fe(M);F!==null?E("update:modelValue",F):(M===""||M==="-")&&E("update:modelValue",null)},H=()=>{O.value=!1;const v=fe(P.value);if(b(P.value)){if(v!==null){const A=Math.round(v*Math.pow(10,o.precision))/Math.pow(10,o.precision),f=Math.max(o.min,Math.min(o.max,A));E("update:modelValue",f),D(f),E("change",f)}}else if(v!==null&&(v<o.min||v>o.max)){const A=Math.max(o.min,Math.min(o.max,v));E("update:modelValue",A),D(A),E("change",A),$.value=!1,N.value=""}E("blur")},L=()=>{O.value=!0,q.value!==null&&(P.value=String(q.value).replace(".",","))},C=()=>{const v=q.value||0,A=Math.min(o.max,v+o.step),f=Math.round(A*Math.pow(10,o.precision))/Math.pow(10,o.precision);E("update:modelValue",f),E("change",f),D(f)},u=()=>{const v=q.value||0,A=Math.max(o.min,v-o.step),f=Math.round(A*Math.pow(10,o.precision))/Math.pow(10,o.precision);E("update:modelValue",f),E("change",f),D(f)};return ne(()=>o.modelValue,v=>{D(v)},{immediate:!0}),D(o.modelValue),(v,A)=>{const f=p("el-button"),M=p("el-button-group"),F=p("el-input");return l(),S(te,null,[t(F,{ref_key:"inputRef",ref:z,modelValue:P.value,"onUpdate:modelValue":A[0]||(A[0]=Z=>P.value=Z),placeholder:i.placeholder,disabled:i.disabled,class:Qe({"is-invalid":$.value}),onInput:j,onBlur:H,onFocus:L},Rt({_:2},[i.showControls?{name:"append",fn:e(()=>[t(M,null,{default:e(()=>[t(f,{icon:d(St),disabled:i.disabled||X.value,onClick:u},null,8,["icon","disabled"]),t(f,{icon:d(Et),disabled:i.disabled||G.value,onClick:C},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),$.value?(l(),S("div",Jt,w(N.value),1)):V("",!0)],64)}}},Kt=Ce(Ht,[["__scopeId","data-v-f31d5553"]]),Wt={class:"card-header"},Zt={class:"card-header-left"},Qt={class:"card-header-actions"},Yt={class:"metrics-filter"},ea={class:"metrics-stats"},ta={class:"metrics-count"},aa={key:0,class:"metric-description"},sa={key:0,class:"metrics-info"},la={class:"info-row"},na={key:0,class:"info-row"},oa={key:0,class:"loading-container"},ra={key:1,class:"no-images"},ia={key:2,class:"images-container"},ua={class:"image-controls"},ca={class:"image-slide"},da=["src","alt"],pa={class:"image-info"},ma={class:"image-filename"},fa={key:0,class:"image-page"},_a={__name:"MetricsEditor",props:{reportId:{type:String,required:!0},reportStatus:{type:String,default:null}},emits:["metrics-updated"],setup(i,{emit:R}){const o=i,E=R,z=y(!1),P=y(!1),O=y(!1),$=y(null),N=y(!1),q=y(0),X=y(0),G=y([]),D=y([]),b=y({metrics:{}}),j=y({}),H=y("metrics"),L=y([]),C=y(!1),u=y(1),v=y(!1),A=y(null),f=y(500),M=y(null),F=Y(()=>{if(!G.value||G.value.length===0)return[];if(N.value)return G.value;const k=new Set(D.value.filter(c=>{const h=parseFloat(String(c.value).replace(",","."));return!isNaN(h)&&h>0}).map(c=>c.metric_def_id));return G.value.filter(c=>{const h=k.has(c.id),B=b.value.metrics[c.id],U=B!=null&&B!==""&&parseFloat(String(B).replace(",","."))>0;return h||U})}),Z=Y(()=>!D.value||D.value.length===0?[]:[...new Set(D.value.map(k=>k.source))]),J=Y(()=>{if(!D.value||D.value.length===0)return null;const k=D.value.map(c=>c.updated_at||c.created_at).filter(Boolean).map(c=>new Date(c));return k.length===0?null:new Date(Math.max(...k))}),ae=async()=>{z.value=!0,$.value=null;try{const k=await we.getMetricTemplate(o.reportId);q.value=k.filled_count||0,X.value=k.missing_count||0;const c=k.items||[];D.value=c.filter(h=>h.value!==null).map(h=>({metric_def_id:h.metric_def.id,value:h.value,source:h.source,confidence:h.confidence,notes:h.notes,updated_at:h.updated_at})),G.value=c.map(h=>({id:h.metric_def.id,code:h.metric_def.code,name:h.metric_def.name,name_ru:h.metric_def.name_ru,unit:h.metric_def.unit,min_value:h.metric_def.min_value,max_value:h.metric_def.max_value,description:h.metric_def.description})),b.value.metrics={},c.forEach(h=>{const B=h.metric_def.id;h.value!==null?b.value.metrics[B]=fe(h.value):b.value.metrics[B]=null}),j.value=JSON.parse(JSON.stringify(b.value.metrics))}catch(k){console.error("Failed to load metrics:",k),$.value="Не удалось загрузить метрики"}finally{z.value=!1}},K=async()=>{await ae(),T.success("Метрики обновлены")},_e=()=>{M.value||(M.value=setInterval(async()=>{await ae()},5e3))},Q=()=>{M.value&&(clearInterval(M.value),M.value=null)},ce=()=>{O.value=!0,N.value=!0,j.value=JSON.parse(JSON.stringify(b.value.metrics))},de=()=>{b.value.metrics=JSON.parse(JSON.stringify(j.value)),O.value=!1,$.value=null},g=async()=>{P.value=!0,$.value=null;try{const k=[],c=[];for(const[U,ee]of Object.entries(b.value.metrics)){const ie=j.value[U],ve=ie!=null&&ie!=="";if(ee!=null&&ee!==""){const ue=jt(ee);ue!==null&&k.push({metric_def_id:U,value:ue,source:"MANUAL",notes:null})}else ve&&c.push(U)}let h=0;for(const U of c)try{await we.clearExtractedMetric(o.reportId,U),h++}catch(ee){ee.response?.status!==404&&console.error("Failed to delete metric:",U,ee)}k.length>0&&await we.bulkCreateExtractedMetrics(o.reportId,k);const B=[];k.length>0&&B.push(`сохранено: ${k.length}`),h>0&&B.push(`сброшено: ${h}`),B.length===0?T.info("Нет изменений для сохранения"):T.success(`Метрики обновлены (${B.join(", ")})`),O.value=!1,await ae(),E("metrics-updated")}catch(k){console.error("Failed to save metrics:",k);let c="Не удалось сохранить метрики";k.response?.data?.detail&&(typeof k.response.data.detail=="string"?c=k.response.data.detail:Array.isArray(k.response.data.detail)&&(c=k.response.data.detail.map(h=>h.msg||h.message).join(", "))),$.value=c,T.error(c)}finally{P.value=!1}},oe=k=>{switch(k){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},re=k=>{switch(k){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return k}},$e=Bt,Re=async()=>{C.value=!0,$.value=null;try{L.value=await ge.getReportImages(o.reportId)}catch(k){console.error("Failed to load report images:",k),$.value="Не удалось загрузить изображения отчёта",T.error("Не удалось загрузить изображения отчёта")}finally{C.value=!1}},Fe=()=>{u.value<2&&(u.value=Math.min(2,u.value+.25))},Te=()=>{u.value>.5&&(u.value=Math.max(.5,u.value-.25))},Se=()=>{u.value=1},Ee=()=>{v.value=!v.value,v.value?f.value=window.innerHeight-100:f.value=500};return Ye(async()=>{}),it(()=>{Q()}),ne(()=>o.reportId,async k=>{k&&(await ae(),L.value=[])}),ne(()=>o.reportStatus,async(k,c)=>{c||await ae(),k==="PROCESSING"?(_e(),c&&c!=="PROCESSING"&&await ae()):(Q(),k==="EXTRACTED"&&c&&c!=="EXTRACTED"&&await ae())},{immediate:!0}),ne(H,async k=>{k==="images"&&L.value.length===0&&!C.value&&await Re()}),(k,c)=>{const h=p("el-icon"),B=p("el-tag"),U=p("el-button"),ee=p("el-alert"),ie=p("el-switch"),ve=p("el-form-item"),ue=p("el-col"),Ne=p("el-row"),xe=p("el-form"),De=p("el-divider"),Me=p("el-tab-pane"),ze=p("el-empty"),Pe=p("el-button-group"),Le=p("el-carousel-item"),Ie=p("el-carousel"),Oe=p("el-tabs"),Ue=p("el-card");return l(),_(Ue,{class:"metrics-editor"},{header:e(()=>[r("div",Wt,[r("div",Zt,[c[5]||(c[5]=r("span",null,"Метрики отчёта",-1)),i.reportStatus==="PROCESSING"?(l(),_(B,{key:0,type:"warning",size:"small",class:"status-tag"},{default:e(()=>[t(h,{class:"is-loading"},{default:e(()=>[t(d(he))]),_:1}),c[3]||(c[3]=m(" Извлечение... ",-1))]),_:1})):i.reportStatus==="EXTRACTED"?(l(),_(B,{key:1,type:"success",size:"small",class:"status-tag"},{default:e(()=>[...c[4]||(c[4]=[m(" Извлечено ",-1)])]),_:1})):V("",!0)]),r("div",Qt,[O.value?V("",!0):(l(),_(U,{key:0,size:"small",loading:z.value,onClick:K},{default:e(()=>[t(h,null,{default:e(()=>[t(d(et))]),_:1}),c[6]||(c[6]=m(" Обновить ",-1))]),_:1},8,["loading"])),O.value?(l(),S(te,{key:2},[t(U,{size:"small",onClick:de},{default:e(()=>[...c[8]||(c[8]=[m(" Отмена ",-1)])]),_:1}),t(U,{type:"primary",size:"small",loading:P.value,onClick:g},{default:e(()=>[...c[9]||(c[9]=[m(" Сохранить ",-1)])]),_:1},8,["loading"])],64)):(l(),_(U,{key:1,type:"primary",size:"small",onClick:ce},{default:e(()=>[...c[7]||(c[7]=[m(" Редактировать ",-1)])]),_:1}))])])]),default:e(()=>[$.value?(l(),_(ee,{key:0,type:"error",title:$.value,closable:"",style:{"margin-bottom":"16px"},onClose:c[0]||(c[0]=a=>$.value=null)},null,8,["title"])):V("",!0),!D.value||D.value.length===0?(l(),_(ee,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...c[10]||(c[10]=[m(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):V("",!0),t(Oe,{modelValue:H.value,"onUpdate:modelValue":c[2]||(c[2]=a=>H.value=a),type:"card"},{default:e(()=>[t(Me,{label:"Метрики",name:"metrics"},{default:e(()=>[r("div",Yt,[t(ie,{modelValue:N.value,"onUpdate:modelValue":c[1]||(c[1]=a=>N.value=a),"active-text":"Показать все метрики","inactive-text":"Только заполненные"},null,8,["modelValue"]),r("div",ea,[t(B,{type:"success",size:"small"},{default:e(()=>[m(" Заполнено: "+w(q.value),1)]),_:1}),t(B,{type:"info",size:"small"},{default:e(()=>[m(" Не заполнено: "+w(X.value),1)]),_:1}),r("span",ta," Показано: "+w(F.value.length)+" из "+w(G.value.length),1)])]),t(xe,{ref:"formRef",model:b.value,"label-position":"top",disabled:!O.value},{default:e(()=>[t(Ne,{gutter:20},{default:e(()=>[(l(!0),S(te,null,se(F.value,a=>(l(),_(ue,{key:a.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ve,{label:d(Ut)(a),prop:`metrics.${a.id}`},{default:e(()=>[t(Kt,{modelValue:b.value.metrics[a.id],"onUpdate:modelValue":s=>b.value.metrics[a.id]=s,min:a.min_value||1,max:a.max_value||10,precision:1,step:.1,disabled:!O.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),a.description?(l(),S("div",aa,w(a.description),1)):V("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),D.value&&D.value.length>0?(l(),S("div",sa,[t(De),r("div",la,[c[11]||(c[11]=r("span",{class:"info-label"},"Источник данных:",-1)),(l(!0),S(te,null,se(Z.value,a=>(l(),_(B,{key:a,type:oe(a),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[m(w(re(a)),1)]),_:2},1032,["type"]))),128))]),J.value?(l(),S("div",na,[c[12]||(c[12]=r("span",{class:"info-label"},"Последнее обновление:",-1)),r("span",null,w(d($e)(J.value)),1)])):V("",!0)])):V("",!0)]),_:1}),t(Me,{label:"Изображения отчёта",name:"images"},{default:e(()=>[C.value?(l(),S("div",oa,[t(h,{class:"is-loading"},{default:e(()=>[t(d(he))]),_:1}),c[13]||(c[13]=r("span",{style:{"margin-left":"8px"}},"Загрузка изображений...",-1))])):L.value.length===0?(l(),S("div",ra,[t(ze,{description:"Изображения отсутствуют"},{image:e(()=>[t(h,{size:60,color:"var(--el-color-info)"},{default:e(()=>[t(d(xt))]),_:1})]),_:1})])):(l(),S("div",ia,[r("div",ua,[t(Pe,null,{default:e(()=>[t(U,{disabled:u.value<=.5,onClick:Te},{default:e(()=>[t(h,null,{default:e(()=>[t(d(Dt))]),_:1})]),_:1},8,["disabled"]),t(U,{onClick:Se},{default:e(()=>[m(w(Math.round(u.value*100))+"% ",1)]),_:1}),t(U,{disabled:u.value>=2,onClick:Fe},{default:e(()=>[t(h,null,{default:e(()=>[t(d(Mt))]),_:1})]),_:1},8,["disabled"])]),_:1}),t(U,{style:{"margin-left":"12px"},onClick:Ee},{default:e(()=>[t(h,null,{default:e(()=>[t(d(It))]),_:1}),c[14]||(c[14]=m(" Полноэкранный режим ",-1))]),_:1})]),r("div",{ref_key:"carouselContainer",ref:A,class:Qe(["carousel-wrapper",{fullscreen:v.value}])},[t(Ie,{height:f.value+"px",arrow:"always","indicator-position":"outside"},{default:e(()=>[(l(!0),S(te,null,se(L.value,a=>(l(),_(Le,{key:a.id},{default:e(()=>[r("div",ca,[r("div",{class:"image-wrapper",style:ut({transform:`scale(${u.value})`})},[r("img",{src:a.data_url,alt:a.filename,class:"report-image"},null,8,da)],4),r("div",pa,[r("span",ma,w(a.filename),1),a.page_number?(l(),S("span",fa," Страница "+w(a.page_number),1)):V("",!0)])])]),_:2},1024))),128))]),_:1},8,["height"]),v.value?(l(),_(U,{key:0,class:"exit-fullscreen",circle:"",onClick:Ee},{default:e(()=>[t(h,null,{default:e(()=>[t(d(Vt))]),_:1})]),_:1})):V("",!0)],2)]))]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},va=Ce(_a,[["__scopeId","data-v-8aeca2ab"]]),ga={class:"report-list"},ya={class:"report-list__controls"},wa={class:"controls-left"},ha={class:"controls-right"},ba={class:"filename"},ka={class:"status-cell"},Ca={key:1,class:"report-list__cards"},$a={class:"report-card__header"},Ra={class:"report-card__status"},Sa={class:"report-card__body"},Ea={class:"report-card__field"},xa={class:"field-value field-value--filename"},Da={class:"report-card__field"},Ma={class:"field-value"},Ia={class:"report-card__actions"},Va={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(i,{emit:R}){const o=i,E=R,z=ct(),P=dt(),{isMobile:O}=pt();Ye(()=>{z.query.status&&($.value=z.query.status),z.query.sort&&(N.value=z.query.sort)});const $=y(""),N=y("desc"),q=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ne([$,N],([C,u])=>{const v={...z.query};C?v.status=C:delete v.status,u?v.sort=u:delete v.sort,P.replace({query:v})});const X=()=>{},G=()=>{N.value=N.value==="desc"?"asc":"desc"},D=Y(()=>{let C=[...o.reports];return $.value&&(C=C.filter(u=>u.status===$.value)),C.sort((u,v)=>{const A=new Date(u.uploaded_at),f=new Date(v.uploaded_at);return N.value==="desc"?f-A:A-f}),C}),b=Y(()=>$.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),j=C=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[C]||C,H=C=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[C]||"info",L=async({action:C,report:u})=>{switch(C){case"view":E("view",u.id);break;case"edit":E("edit",u.id);break;case"extract":E("extract",u.id);break;case"download":E("download",u.id);break;case"delete":try{await Tt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",u.id)}catch{}break}};return(C,u)=>{const v=p("el-option"),A=p("el-select"),f=p("el-icon"),M=p("el-button"),F=p("el-table-column"),Z=p("el-tag"),J=p("el-dropdown-item"),ae=p("el-dropdown-menu"),K=p("el-dropdown"),_e=p("el-table"),Q=p("el-card"),ce=p("el-empty"),de=tt("loading");return l(),S("div",ga,[r("div",ya,[r("div",wa,[t(A,{modelValue:$.value,"onUpdate:modelValue":u[0]||(u[0]=g=>$.value=g),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:X},{default:e(()=>[t(v,{label:"Все статусы",value:""}),(l(),S(te,null,se(q,g=>t(v,{key:g.value,label:g.label,value:g.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),r("div",ha,[t(M,{type:N.value==="desc"?"primary":"default",size:"small",onClick:G},{default:e(()=>[t(f,null,{default:e(()=>[t(d(At))]),_:1}),m(" "+w(N.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),d(O)?be((l(),S("div",Ca,[(l(!0),S(te,null,se(D.value,g=>(l(),_(Q,{key:g.id,class:"report-card",shadow:"hover"},{header:e(()=>[r("div",$a,[r("div",Ra,[g.status==="PROCESSING"?(l(),_(f,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(d(he))]),_:1})):g.status==="EXTRACTED"?(l(),_(f,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(d(Je))]),_:1})):g.status==="FAILED"?(l(),_(f,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(d(He))]),_:1})):(l(),_(f,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(d(Ke))]),_:1})),t(Z,{type:H(g.status),size:"small"},{default:e(()=>[m(w(j(g.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[r("div",Ia,[g.status==="EXTRACTED"?(l(),_(M,{key:0,type:"success",size:"small",onClick:oe=>L({action:"edit",report:g})},{default:e(()=>[t(f,null,{default:e(()=>[t(d(st))]),_:1}),u[10]||(u[10]=m(" Редактировать ",-1))]),_:1},8,["onClick"])):V("",!0),g.status==="PROCESSING"||g.status==="EXTRACTED"?(l(),_(M,{key:1,type:"info",size:"small",onClick:oe=>L({action:"view",report:g})},{default:e(()=>[t(f,null,{default:e(()=>[t(d(lt))]),_:1}),u[11]||(u[11]=m(" Просмотр ",-1))]),_:1},8,["onClick"])):V("",!0),t(M,{type:"primary",size:"small",onClick:oe=>L({action:"extract",report:g})},{default:e(()=>[t(f,null,{default:e(()=>[t(d(nt))]),_:1}),m(" "+w(g.status==="FAILED"?"Повторить":g.status==="PROCESSING"?"Перезапустить":g.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(M,{size:"small",onClick:oe=>L({action:"download",report:g})},{default:e(()=>[t(f,null,{default:e(()=>[t(d(We))]),_:1}),u[12]||(u[12]=m(" Скачать ",-1))]),_:1},8,["onClick"]),t(M,{type:"danger",size:"small",onClick:oe=>L({action:"delete",report:g})},{default:e(()=>[t(f,null,{default:e(()=>[t(d(Ze))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[r("div",Sa,[r("div",Ea,[u[8]||(u[8]=r("span",{class:"field-label"},"Файл:",-1)),r("span",xa,w(g.file_ref?.filename||"Без названия"),1)]),r("div",Da,[u[9]||(u[9]=r("span",{class:"field-label"},"Дата загрузки:",-1)),r("span",Ma,w(d(ke)(g.uploaded_at)),1)])])]),_:2},1024))),128)),!D.value.length&&!i.loading?(l(),_(ce,{key:0,description:b.value,"image-size":120},{default:e(()=>[$.value?V("",!0):(l(),_(M,{key:0,type:"primary",onClick:u[1]||(u[1]=g=>C.$emit("upload"))},{default:e(()=>[...u[13]||(u[13]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):V("",!0)])),[[de,i.loading]]):be((l(),_(_e,{key:0,data:D.value,class:"report-list__table",stripe:"","empty-text":b.value},{default:e(()=>[t(F,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:g})=>[r("span",ba,w(g.file_ref?.filename||"Без названия"),1)]),_:1}),t(F,{prop:"status",label:"Статус",width:"200"},{default:e(({row:g})=>[r("div",ka,[g.status==="PROCESSING"?(l(),_(f,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(d(he))]),_:1})):g.status==="EXTRACTED"?(l(),_(f,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(d(Je))]),_:1})):g.status==="FAILED"?(l(),_(f,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(d(He))]),_:1})):(l(),_(f,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(d(Ke))]),_:1})),t(Z,{type:H(g.status),size:"default"},{default:e(()=>[m(w(j(g.status)),1)]),_:2},1032,["type"])])]),_:1}),t(F,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:g})=>[m(w(d(ke)(g.uploaded_at)),1)]),_:1}),t(F,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:g})=>[t(K,{trigger:"click",onCommand:L},{dropdown:e(()=>[t(ae,null,{default:e(()=>[g.status==="EXTRACTED"?(l(),_(J,{key:0,command:{action:"edit",report:g}},{default:e(()=>[t(f,null,{default:e(()=>[t(d(st))]),_:1}),u[4]||(u[4]=m(" Редактировать метрики ",-1))]),_:1},8,["command"])):V("",!0),g.status==="PROCESSING"||g.status==="EXTRACTED"?(l(),_(J,{key:1,command:{action:"view",report:g}},{default:e(()=>[t(f,null,{default:e(()=>[t(d(lt))]),_:1}),u[5]||(u[5]=m(" Просмотр метрик ",-1))]),_:1},8,["command"])):V("",!0),t(J,{command:{action:"extract",report:g}},{default:e(()=>[t(f,null,{default:e(()=>[t(d(nt))]),_:1}),m(" "+w(g.status==="FAILED"?"Повторить извлечение":g.status==="PROCESSING"?"Перезапустить извлечение":g.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(J,{divided:"",command:{action:"download",report:g}},{default:e(()=>[t(f,null,{default:e(()=>[t(d(We))]),_:1}),u[6]||(u[6]=m(" Скачать ",-1))]),_:1},8,["command"]),t(J,{command:{action:"delete",report:g},class:"dropdown-item--danger"},{default:e(()=>[t(f,null,{default:e(()=>[t(d(Ze))]),_:1}),u[7]||(u[7]=m(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(M,{type:"primary",size:"small"},{default:e(()=>[u[3]||(u[3]=m(" Действия ",-1)),t(f,{class:"el-icon--right"},{default:e(()=>[t(d(Ft))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[de,i.loading]]),!D.value.length&&!i.loading&&!d(O)?(l(),_(ce,{key:2,description:b.value,"image-size":120},{default:e(()=>[$.value?V("",!0):(l(),_(M,{key:0,type:"primary",onClick:u[2]||(u[2]=g=>C.$emit("upload"))},{default:e(()=>[...u[14]||(u[14]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):V("",!0)])}}},Aa=Ce(Va,[["__scopeId","data-v-45976573"]]),Fa={class:"metrics-drawer"},Ta={class:"drawer-actions"},Na={key:1},za={key:1},Pa={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:R}){const o=i,E=R,z=y(!1),P=y([]),O=y([]),$=Y(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),N=b=>{E("update:modelValue",b)},q=async()=>{try{const b=await we.listMetricDefs(!0);O.value=b.items||[]}catch(b){console.error("Error loading metric definitions:",b)}},X=async()=>{z.value=!0;try{const b=await mt.getMetrics(o.participantId);P.value=b.metrics||[]}catch(b){console.error("Error loading participant metrics:",b),T.error("Ошибка загрузки метрик участника")}finally{z.value=!1}},G=b=>{if(!b)return"—";const j=O.value.find(L=>L.code===b);return Xt(j,b,{warn:()=>{}})},D=b=>b>=.8?"var(--el-color-success)":b>=.6?"var(--el-color-warning)":"var(--el-color-danger)";return ne(()=>o.participantId,async b=>{b&&o.modelValue&&(await q(),await X())}),ne(()=>o.modelValue,async b=>{b&&o.participantId&&(await q(),await X())}),(b,j)=>{const H=p("el-icon"),L=p("el-button"),C=p("el-table-column"),u=p("el-tag"),v=p("el-table"),A=p("el-empty"),f=p("el-drawer"),M=tt("loading");return l(),_(f,{"model-value":i.modelValue,title:`Метрики участника: ${i.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":N},{default:e(()=>[be((l(),S("div",Fa,[r("div",Ta,[t(L,{type:"primary",size:"small",onClick:X},{default:e(()=>[t(H,null,{default:e(()=>[t(d(et))]),_:1}),j[0]||(j[0]=m(" Обновить ",-1))]),_:1})]),t(v,{data:P.value,stripe:"","empty-text":$.value},{default:e(()=>[t(C,{prop:"metric_code",label:"Код метрики",width:"200"}),t(C,{label:"Название метрики","min-width":"250"},{default:e(({row:F})=>[m(w(G(F.metric_code)),1)]),_:1}),t(C,{prop:"value",label:"Значение",width:"120"},{default:e(({row:F})=>[t(u,{type:"success"},{default:e(()=>[m(w(d(ye)(F.value)),1)]),_:2},1024)]),_:1}),t(C,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:F})=>[F.confidence!==null?(l(),S("span",{key:0,style:ut({color:D(F.confidence)})},w((F.confidence*100).toFixed(0))+"% ",5)):(l(),S("span",Na,"—"))]),_:1}),t(C,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:F})=>[m(w(d(ke)(F.updated_at)),1)]),_:1}),t(C,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:F})=>[F.last_source_report_id?(l(),_(u,{key:0,size:"small"},{default:e(()=>[...j[1]||(j[1]=[m(" Из отчёта ",-1)])]),_:1})):(l(),S("span",za,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!P.value.length&&!z.value?(l(),_(A,{key:0,description:$.value},null,8,["description"])):V("",!0)])),[[M,z.value]])]),_:1},8,["model-value","title"])}}},La=Ce(Pa,[["__scopeId","data-v-1043d8e9"]]),Oa={class:"participant-detail"},Ua={class:"card-header"},Ba={class:"header-actions"},Xa={class:"section-header"},Ga={class:"scoring-result"},qa={class:"score-value"},ja={class:"score-number"},Ja={class:"score-details"},Ha={class:"score-section"},Ka={key:0},Wa={class:"score-section"},Za={key:0},Qa={class:"score-section recommendations-status-section"},Ya={class:"recommendations-pending-alert"},es={key:0,class:"final-report-actions"},ts={key:0,class:"batch-files-list"},as={class:"batch-files-header"},ss={class:"batch-file-info"},ls={class:"batch-file-name"},ns={class:"batch-file-size"},os={key:0,class:"batch-file-error"},rs={class:"activity-code-hint"},rt=20*1024*1024,je=10,is={__name:"ParticipantDetailView",setup(i){const R=dt(),o=ct(),E=qt(),z=y(!1),P=y(!1),{isMobile:O}=pt(),$=y(!1),N=y(!1),q=y(!1),X=Y(()=>E.currentParticipant),G=y([]),D=y([]),b=y([]),j=y([]),H=y(null),L=y(null),C=y(null),u=Y(()=>G.value.some(a=>a.status==="PROCESSING")),v=Y(()=>H.value&&G.value.find(s=>s.id===H.value)?.status||null),A=Y(()=>D.value.some(a=>a.recommendations_status==="pending")),f=y(!1),M=y(!1),F=y(!1),Z=y(!1),J=y(null),ae=y([]),K=y([]);let _e=0;const Q=Nt({activityCode:""}),ce=a=>a>=80?"success":a>=60?"":"warning",de=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,g=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",oe=async()=>{z.value=!0;try{await E.getParticipant(o.params.id)}catch{T.error("Участник не найден"),R.push("/participants")}finally{z.value=!1}},re=async({silent:a=!1}={})=>{a||(P.value=!0);try{const s=await mt.getReports(o.params.id);G.value=s.items||[]}catch(s){console.error("Error loading reports:",s),T.error("Ошибка загрузки списка отчётов")}finally{a||(P.value=!1)}},$e=a=>{if(!a)return a;const s=Array.isArray(a.recommendations)?a.recommendations:[];let I=a.recommendations_status||a.recommendationsStatus||null;I||(I=s.length>0?"ready":"pending");const x=Number(a.score_pct),pe=Number.isNaN(x)?a.score_pct:x;return{...a,score_pct:pe,recommendations:s,recommendations_status:I,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Re=async()=>{try{const a=await qe.getHistory(o.params.id),s=Array.isArray(a.items)?a.items:[];D.value=s.map($e)}catch(a){console.error("Error loading scoring results:",a)}},Fe=async()=>{$.value=!0;try{const a=await Gt.list();b.value=a||[]}catch{T.error("Ошибка загрузки профессиональных областей")}finally{$.value=!1}},Te=async()=>{try{const a=await we.listMetricDefs(!0);j.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},Se=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB",Ee=a=>a.name.toLowerCase().endsWith(".docx")?a.size>rt?`Размер файла превышает ${Se(rt)}`:null:"Только файлы формата .docx",k=(a,s)=>{const I=a.raw;if(K.value.length>=je){T.warning(`Максимальное количество файлов: ${je}`),J.value&&J.value.clearFiles();return}const x=Ee(I);if(x){T.error(x),J.value&&J.value.clearFiles();return}K.value.push({id:++_e,file:I,name:I.name,size:I.size,status:"pending",progress:0,error:null,reportId:null}),J.value&&J.value.clearFiles()},c=a=>{K.value=K.value.filter(s=>s.id!==a)},h=async a=>{a.status="uploading",a.progress=0;try{const s=await ge.upload(o.params.id,a.file);a.status="success",a.reportId=s.id}catch(s){a.status="error",a.error=s.response?.data?.detail||"Ошибка загрузки"}},B=async()=>{const a=K.value.filter(s=>s.status==="pending");if(a.length===0){T.warning("Нет файлов для загрузки");return}N.value=!0;try{await Promise.allSettled(a.map(x=>h(x)));const s=K.value.filter(x=>x.status==="success").length,I=K.value.filter(x=>x.status==="error").length;I===0?(T.success(`Загружено ${s} отчётов`),f.value=!1,U()):T.warning(`Загружено: ${s}, ошибок: ${I}`),await re()}finally{N.value=!1}},U=()=>{K.value=[],ae.value=[],J.value&&J.value.clearFiles()},ee=async a=>{try{const s=await ge.download(a),I=window.URL.createObjectURL(new Blob([s.data])),x=document.createElement("a");x.href=I,x.setAttribute("download",`report_${a}.docx`),document.body.appendChild(x),x.click(),x.remove(),window.URL.revokeObjectURL(I),T.success("Отчёт скачан")}catch{T.error("Ошибка скачивания отчёта")}},ie=async a=>{try{await ge.extract(a),T.success("Извлечение метрик запущено"),await re()}catch{T.error("Ошибка запуска извлечения метрик")}},ve=()=>{L.value||(L.value=setInterval(async()=>{try{await re({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},ue=()=>{L.value&&(clearInterval(L.value),L.value=null)},Ne=()=>{C.value||(C.value=setInterval(async()=>{try{await Re()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},xe=()=>{C.value&&(clearInterval(C.value),C.value=null)};ne(u,a=>{a?ve():ue()}),ne(A,a=>{a?Ne():xe()});const De=async a=>{H.value=a,await Lt(),F.value=!0},Me=async()=>{T.success("Метрики обновлены"),await re({silent:!0})},ze=async a=>{try{await ge.delete(a),T.success("Отчёт удалён"),await re()}catch{T.error("Ошибка удаления отчёта")}},Pe=async()=>{if(!Q.activityCode){T.warning("Выберите профессиональную область");return}q.value=!0;try{const a=await qe.calculate(o.params.id,Q.activityCode),s=$e({id:a.scoring_result_id,participant_id:o.params.id,prof_activity_code:a.prof_activity_code||Q.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});D.value.unshift(s),T.success("Расчёт пригодности выполнен"),M.value=!1,Q.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const s=a.response?.data?.detail||"Ошибка расчёта пригодности";T.error(s)}finally{q.value=!1}},Le=async a=>{if(!a.prof_activity_code){T.warning("Код профессиональной деятельности не найден");return}try{const s=await qe.downloadFinalReportPdf(o.params.id,a.prof_activity_code,a.id),I=window.URL.createObjectURL(new Blob([s.data])),x=document.createElement("a");x.href=I,x.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(x),x.click(),x.remove(),window.URL.revokeObjectURL(I),T.success("Отчёт PDF скачан")}catch(s){const I=s.response?.data?.detail||"Ошибка загрузки PDF отчёта";T.error(I)}},Ie=a=>a?.recommendations_status==="ready"||a?.recommendations_status==="disabled",Oe=a=>a?.recommendations_status==="pending"?"Дождитесь завершения генерации рекомендаций":a?.recommendations_status==="error"?"Ошибка генерации рекомендаций. Попробуйте пересчитать пригодность":"",Ue=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Ye(async()=>{await oe(),await re(),await Re(),await Fe(),await Te()}),it(()=>{ue(),xe()}),(a,s)=>{const I=p("el-button"),x=p("el-icon"),pe=p("el-descriptions-item"),ft=p("el-descriptions"),Ve=p("el-card"),_t=p("el-progress"),Be=p("el-empty"),vt=p("el-tag"),me=p("el-alert"),gt=p("el-tooltip"),yt=p("el-timeline-item"),wt=p("el-timeline"),ht=p("el-upload"),Xe=p("el-dialog"),bt=p("el-option"),kt=p("el-select"),Ct=p("el-form-item"),$t=p("el-form"),at=tt("loading");return l(),_(Ot,null,{default:e(()=>[be((l(),S("div",Oa,[X.value?(l(),_(Ve,{key:0,class:"detail-card"},{header:e(()=>[r("div",Ua,[r("h2",null,w(X.value.full_name),1),r("div",Ba,[t(I,{onClick:s[0]||(s[0]=n=>d(R).back())},{default:e(()=>[...s[12]||(s[12]=[m(" Назад ",-1)])]),_:1}),t(I,{type:"info",onClick:s[1]||(s[1]=n=>Z.value=!0)},{default:e(()=>[t(x,null,{default:e(()=>[t(d(zt))]),_:1}),s[13]||(s[13]=m(" Метрики ",-1))]),_:1}),t(I,{type:"primary",onClick:s[2]||(s[2]=n=>M.value=!0)},{default:e(()=>[t(x,null,{default:e(()=>[t(d(Pt))]),_:1}),s[14]||(s[14]=m(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(ft,{column:d(O)?1:2,border:""},{default:e(()=>[t(pe,{label:"ФИО"},{default:e(()=>[m(w(X.value.full_name),1)]),_:1}),t(pe,{label:"Дата рождения"},{default:e(()=>[m(w(X.value.birth_date||"Не указана"),1)]),_:1}),t(pe,{label:"Внешний ID"},{default:e(()=>[m(w(X.value.external_id||"Не указан"),1)]),_:1}),t(pe,{label:"Дата создания"},{default:e(()=>[m(w(d(ke)(X.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):V("",!0),t(Ve,{class:"section-card"},{header:e(()=>[r("div",Xa,[s[16]||(s[16]=r("h3",null,"Отчёты",-1)),t(I,{type:"primary",onClick:s[3]||(s[3]=n=>f.value=!0)},{default:e(()=>[t(x,null,{default:e(()=>[t(d(ot))]),_:1}),s[15]||(s[15]=m(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(Aa,{reports:G.value,loading:P.value,onView:De,onEdit:De,onExtract:ie,onDownload:ee,onDelete:ze,onUpload:s[4]||(s[4]=n=>f.value=!0)},null,8,["reports","loading"])]),_:1}),D.value.length>0?(l(),_(Ve,{key:1,class:"section-card"},{header:e(()=>[...s[17]||(s[17]=[r("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(wt,null,{default:e(()=>[(l(!0),S(te,null,se(D.value,n=>(l(),_(yt,{key:n.id,timestamp:d(ke)(n.created_at),placement:"top"},{default:e(()=>[t(Ve,null,{default:e(()=>[r("h4",null,w(n.prof_activity_name),1),r("div",Ga,[r("div",qa,[r("span",ja,w(n.score_pct)+"%",1),t(_t,{percentage:n.score_pct,status:ce(n.score_pct)},null,8,["percentage","status"])]),r("div",Ja,[r("div",Ha,[s[18]||(s[18]=r("h5",null,"Сильные стороны:",-1)),n.strengths&&n.strengths.length?(l(),S("ul",Ka,[(l(!0),S(te,null,se(n.strengths,(le,Ge)=>(l(),S("li",{key:Ge},[r("strong",null,w(le.metric_name),1),m(" — "+w(d(ye)(le.value))+" (вес "+w(d(ye)(le.weight,2))+") ",1)]))),128))])):(l(),_(Be,{key:1,description:"Нет данных","image-size":60}))]),r("div",Wa,[s[19]||(s[19]=r("h5",null,"Зоны развития:",-1)),n.dev_areas&&n.dev_areas.length?(l(),S("ul",Za,[(l(!0),S(te,null,se(n.dev_areas,(le,Ge)=>(l(),S("li",{key:Ge},[r("strong",null,w(le.metric_name),1),m(" — "+w(d(ye)(le.value))+" (вес "+w(d(ye)(le.weight,2))+") ",1)]))),128))])):(l(),_(Be,{key:1,description:"Нет данных","image-size":60}))]),r("div",Qa,[r("h5",null,[s[20]||(s[20]=m(" Рекомендации: ",-1)),n.recommendations_status?(l(),_(vt,{key:0,type:g(n.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[m(w(de(n.recommendations_status)),1)]),_:2},1032,["type"])):V("",!0)]),n.recommendations_status==="pending"?(l(),_(me,{key:0,type:"info",closable:!1,"show-icon":""},{title:e(()=>[r("div",Ya,[t(x,{class:"is-loading"},{default:e(()=>[t(d(et))]),_:1}),s[21]||(s[21]=r("span",null,"Рекомендации формируются...",-1))])]),default:e(()=>[...s[22]||(s[22]=[m(" Кнопка «Скачать PDF» станет доступна после завершения генерации. ",-1)])]),_:1})):n.recommendations_status==="ready"?(l(),_(me,{key:1,title:"Рекомендации готовы",type:"success",closable:!1,"show-icon":""},{default:e(()=>[...s[23]||(s[23]=[m(" Персональные рекомендации доступны в итоговом PDF-отчёте. ",-1)])]),_:1})):n.recommendations_status==="error"?(l(),_(me,{key:2,title:Ue(n),type:"error",closable:!1,"show-icon":""},{default:e(()=>[...s[24]||(s[24]=[m(" Не удалось сформировать рекомендации. Попробуйте пересчитать пригодность. ",-1)])]),_:1},8,["title"])):n.recommendations_status==="disabled"?(l(),_(me,{key:3,title:"Генерация рекомендаций отключена",type:"warning",closable:!1,"show-icon":""},{default:e(()=>[...s[25]||(s[25]=[m(" Генерация рекомендаций отключена для данного окружения. ",-1)])]),_:1})):(l(),_(Be,{key:4,description:"Статус рекомендаций неизвестен","image-size":60}))])]),n.prof_activity_code?(l(),S("div",es,[t(gt,{disabled:Ie(n),content:Oe(n),placement:"top"},{default:e(()=>[r("span",null,[t(I,{type:"primary",size:"small",disabled:!Ie(n),loading:n.recommendations_status==="pending",onClick:le=>Le(n)},{default:e(()=>[n.recommendations_status!=="pending"?(l(),_(x,{key:0},{default:e(()=>[t(d(We))]),_:1})):V("",!0),m(" "+w(n.recommendations_status==="pending"?"Формируется...":"Скачать PDF"),1)]),_:2},1032,["disabled","loading","onClick"])])]),_:2},1032,["disabled","content"])])):V("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):V("",!0),t(Xe,{modelValue:f.value,"onUpdate:modelValue":s[6]||(s[6]=n=>f.value=n),title:"Загрузить отчёты",width:d(O)?"95%":"600px",onClose:U},{footer:e(()=>[t(I,{onClick:s[5]||(s[5]=n=>f.value=!1)},{default:e(()=>[...s[28]||(s[28]=[m(" Отмена ",-1)])]),_:1}),t(I,{type:"primary",loading:N.value,disabled:!K.value.some(n=>n.status==="pending"),onClick:B},{default:e(()=>[m(" Загрузить все ("+w(K.value.filter(n=>n.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(ht,{ref_key:"uploadRef",ref:J,"auto-upload":!1,multiple:"",accept:".docx","on-change":k,"show-file-list":!1,drag:""},{tip:e(()=>[...s[26]||(s[26]=[r("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t(x,{class:"el-icon--upload"},{default:e(()=>[t(d(ot))]),_:1}),s[27]||(s[27]=r("div",{class:"el-upload__text"},[m(" Перетащите файлы сюда или "),r("em",null,"нажмите для выбора")],-1))]),_:1},512),K.value.length?(l(),S("div",ts,[r("div",as," Выбрано файлов: "+w(K.value.length)+"/"+w(je),1),(l(!0),S(te,null,se(K.value,n=>(l(),S("div",{key:n.id,class:Qe(["batch-file-item","batch-file-item--"+n.status])},[n.status==="pending"?(l(),_(x,{key:0,class:"batch-file-icon"},{default:e(()=>[t(d(Ke))]),_:1})):n.status==="uploading"?(l(),_(x,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(d(he))]),_:1})):n.status==="success"?(l(),_(x,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(d(Je))]),_:1})):n.status==="error"?(l(),_(x,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(d(He))]),_:1})):V("",!0),r("div",ss,[r("span",ls,w(n.name),1),r("span",ns,w(Se(n.size)),1),n.error?(l(),S("span",os,w(n.error),1)):V("",!0)]),n.status==="pending"||n.status==="error"?(l(),_(I,{key:4,type:"danger",icon:d(Ze),circle:"",size:"small",onClick:le=>c(n.id)},null,8,["icon","onClick"])):V("",!0)],2))),128))])):V("",!0)]),_:1},8,["modelValue","width"]),t(Xe,{modelValue:M.value,"onUpdate:modelValue":s[9]||(s[9]=n=>M.value=n),title:"Рассчитать профессиональную пригодность",width:d(O)?"95%":"500px"},{footer:e(()=>[t(I,{onClick:s[8]||(s[8]=n=>M.value=!1)},{default:e(()=>[...s[29]||(s[29]=[m(" Отмена ",-1)])]),_:1}),t(I,{type:"primary",loading:q.value,disabled:!Q.activityCode||G.value.length===0,onClick:Pe},{default:e(()=>[...s[30]||(s[30]=[m(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t($t,{model:Q,"label-position":"top"},{default:e(()=>[t(Ct,{label:"Профессиональная область",required:""},{default:e(()=>[be((l(),_(kt,{modelValue:Q.activityCode,"onUpdate:modelValue":s[7]||(s[7]=n=>Q.activityCode=n),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(l(!0),S(te,null,se(b.value,n=>(l(),_(bt,{key:n.code,label:n.name,value:n.code},{default:e(()=>[r("span",null,w(n.name),1),r("span",rs,w(n.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[at,$.value]])]),_:1}),t(me,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),G.value.length===0?(l(),_(me,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):V("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),t(Xe,{modelValue:F.value,"onUpdate:modelValue":s[10]||(s[10]=n=>F.value=n),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[H.value?(l(),_(va,{key:0,"report-id":H.value,"report-status":v.value,onMetricsUpdated:Me},null,8,["report-id","report-status"])):V("",!0)]),_:1},8,["modelValue"]),t(La,{modelValue:Z.value,"onUpdate:modelValue":s[11]||(s[11]=n=>Z.value=n),"participant-id":X.value?.id,"participant-name":X.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[at,z.value]])]),_:1})}}},fs=Ce(is,[["__scopeId","data-v-f1cdc201"]]);export{fs as default};
