import{P as H,m as C,D as x,n as R,H as J,v as D,w as i,E as V,d as K,r as f,I as j,o as _,a as u,J as G,f as n,e as b,u as p,K as I,L as Q,M as W,c as k,x as X,F as Y,C as Z,B as F,N as ee}from"./index-DkBW6kl5.js";import{A as ae}from"./AppLayout-SXmHkj5y.js";import{o as O}from"./organizations-BvO8ewAK.js";import{u as te}from"./useResponsive-BIJ3kAHe.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const oe=H("organizations",()=>{const y=C([]),v=C(null),o=C(!1),r=C(null),s=C({total:0,page:1,size:20,totalPages:0});async function z(d={}){o.value=!0,r.value=null;try{const a=await O.search(d);return y.value=a.items,s.value={total:a.total,page:a.page,size:a.size,totalPages:Math.ceil(a.total/a.size)},a}catch(a){const l=x(a,"Ошибка загрузки организаций");throw r.value=l.message,a.normalizedError=l,a}finally{o.value=!1}}async function h(d){o.value=!0,r.value=null;try{const a=await O.getById(d);return v.value=a,a}catch(a){const l=x(a,"Ошибка загрузки организации");throw r.value=l.message,a.normalizedError=l,a}finally{o.value=!1}}async function m(d){o.value=!0,r.value=null;try{const a=await O.create(d);return y.value.unshift(a),a}catch(a){const l=x(a,"Ошибка создания организации");throw r.value=l.message,a.normalizedError=l,a}finally{o.value=!1}}async function S(d,a){o.value=!0,r.value=null;try{const l=await O.update(d,a),c=y.value.findIndex(e=>e.id===d);return c!==-1&&(y.value[c]=l),v.value?.id===d&&(v.value={...v.value,...l}),l}catch(l){const c=x(l,"Ошибка обновления организации");throw r.value=c.message,l.normalizedError=c,l}finally{o.value=!1}}async function g(d){o.value=!0,r.value=null;try{await O.delete(d),y.value=y.value.filter(a=>a.id!==d),v.value?.id===d&&(v.value=null)}catch(a){const l=x(a,"Ошибка удаления организации");throw r.value=l.message,a.normalizedError=l,a}finally{o.value=!1}}return{organizations:y,currentOrganization:v,loading:o,error:r,pagination:s,searchOrganizations:z,getOrganization:h,createOrganization:m,updateOrganization:S,deleteOrganization:g}}),le={class:"organizations-view"},ie={class:"page-header"},re={class:"header-content"},se={class:"filter-card card"},de={class:"table-card card"},ue={class:"actions-group"},pe={key:1,class:"org-cards"},ce={class:"org-card__name"},me={class:"org-card__info"},ge={class:"org-card__field"},fe={class:"field-value"},ve={class:"org-card__field"},_e={class:"field-value"},ye={class:"org-card__actions"},ze={key:2,class:"pagination"},we={key:3,class:"pagination pagination--mobile"},be={__name:"OrganizationsView",setup(y){const v=K(),o=oe(),{isMobile:r}=te(),s=R({query:"",page:1,size:20}),z=C(!1),h=C(null),m=R({name:"",description:""}),S={name:[{required:!0,message:"Введите название",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},g=async()=>{try{await o.searchOrganizations(s)}catch{V.error("Ошибка загрузки организаций")}},d=async()=>{h.value&&await h.value.validate(async c=>{if(c)try{await o.createOrganization(m),V.success("Организация создана"),z.value=!1,m.name="",m.description="",await g()}catch{V.error(o.error||"Ошибка создания организации")}})},a=c=>{v.push(`/organizations/${c}`)},l=c=>{ee.confirm(`Вы уверены, что хотите удалить организацию "${c.name}"? Все отделы также будут удалены.`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await o.deleteOrganization(c.id),V.success("Организация удалена"),await g()}catch{V.error(o.error||"Ошибка удаления организации")}}).catch(()=>{})};return J(()=>{g()}),(c,e)=>{const M=f("el-icon"),w=f("el-button"),B=f("el-input"),$=f("el-form-item"),N=f("el-form"),E=f("el-table-column"),q=f("el-table"),A=f("el-empty"),P=f("el-pagination"),L=f("el-dialog"),T=j("loading");return _(),D(ae,null,{default:i(()=>[u("div",le,[u("div",ie,[u("div",re,[e[12]||(e[12]=u("h1",{class:"page-title"}," Организации ",-1)),n(w,{type:"primary",onClick:e[0]||(e[0]=t=>z.value=!0)},{default:i(()=>[n(M,null,{default:i(()=>[n(p(I))]),_:1}),e[11]||(e[11]=b(" Добавить организацию ",-1))]),_:1})])]),u("div",se,[n(N,{inline:!p(r),model:s},{default:i(()=>[n($,{label:"Поиск"},{default:i(()=>[n(B,{modelValue:s.query,"onUpdate:modelValue":e[1]||(e[1]=t=>s.query=t),placeholder:"Название организации",clearable:"",style:Q(p(r)?"width: 100%":"width: 300px"),onChange:g},{prefix:i(()=>[n(M,null,{default:i(()=>[n(p(W))]),_:1})]),_:1},8,["modelValue","style"])]),_:1})]),_:1},8,["inline","model"])]),G((_(),k("div",de,[p(r)?(_(),k("div",pe,[(_(!0),k(Y,null,Z(p(o).organizations,t=>(_(),k("div",{key:t.id,class:"org-card"},[u("div",ce,F(t.name),1),u("div",me,[u("div",ge,[e[15]||(e[15]=u("span",{class:"field-label"},"Описание:",-1)),u("span",fe,F(t.description||"—"),1)]),u("div",ve,[e[16]||(e[16]=u("span",{class:"field-label"},"Отделов:",-1)),u("span",_e,F(t.departments_count),1)])]),u("div",ye,[n(w,{type:"primary",onClick:U=>a(t.id)},{default:i(()=>[...e[17]||(e[17]=[b(" Открыть ",-1)])]),_:1},8,["onClick"]),n(w,{type:"danger",plain:"",onClick:U=>l(t)},{default:i(()=>[...e[18]||(e[18]=[b(" Удалить ",-1)])]),_:1},8,["onClick"])])]))),128)),!p(o).organizations.length&&!p(o).loading?(_(),D(A,{key:0,description:"Нет организаций","image-size":120},{default:i(()=>[n(w,{type:"primary",onClick:e[2]||(e[2]=t=>z.value=!0)},{default:i(()=>[...e[19]||(e[19]=[b(" Добавить организацию ",-1)])]),_:1})]),_:1})):X("",!0)])):(_(),D(q,{key:0,data:p(o).organizations,stripe:"","table-layout":"fixed"},{default:i(()=>[n(E,{prop:"name",label:"Название"}),n(E,{prop:"description",label:"Описание","show-overflow-tooltip":""}),n(E,{prop:"departments_count",label:"Кол-во отделов",width:"150",align:"center"}),n(E,{label:"Действия",width:"200",align:"center"},{default:i(({row:t})=>[u("div",ue,[n(w,{type:"primary",size:"small",onClick:U=>a(t.id)},{default:i(()=>[...e[13]||(e[13]=[b(" Открыть ",-1)])]),_:1},8,["onClick"]),n(w,{type:"danger",size:"small",plain:"",onClick:U=>l(t)},{default:i(()=>[...e[14]||(e[14]=[b(" Удалить ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),p(r)?(_(),k("div",we,[n(P,{"current-page":s.page,"onUpdate:currentPage":e[5]||(e[5]=t=>s.page=t),"page-size":s.size,"onUpdate:pageSize":e[6]||(e[6]=t=>s.size=t),total:p(o).pagination.total,"page-sizes":[10,20,50],layout:"prev, pager, next",small:"",onCurrentChange:g,onSizeChange:g},null,8,["current-page","page-size","total"])])):(_(),k("div",ze,[n(P,{"current-page":s.page,"onUpdate:currentPage":e[3]||(e[3]=t=>s.page=t),"page-size":s.size,"onUpdate:pageSize":e[4]||(e[4]=t=>s.size=t),total:p(o).pagination.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onCurrentChange:g,onSizeChange:g},null,8,["current-page","page-size","total"])]))])),[[T,p(o).loading]]),n(L,{modelValue:z.value,"onUpdate:modelValue":e[10]||(e[10]=t=>z.value=t),title:"Добавить организацию",width:p(r)?"95%":"500px"},{footer:i(()=>[n(w,{onClick:e[9]||(e[9]=t=>z.value=!1)},{default:i(()=>[...e[20]||(e[20]=[b(" Отмена ",-1)])]),_:1}),n(w,{type:"primary",loading:p(o).loading,onClick:d},{default:i(()=>[...e[21]||(e[21]=[b(" Создать ",-1)])]),_:1},8,["loading"])]),default:i(()=>[n(N,{ref_key:"createFormRef",ref:h,model:m,rules:S,"label-position":"top"},{default:i(()=>[n($,{label:"Название",prop:"name"},{default:i(()=>[n(B,{modelValue:m.name,"onUpdate:modelValue":e[7]||(e[7]=t=>m.name=t),placeholder:"Введите название организации"},null,8,["modelValue"])]),_:1}),n($,{label:"Описание",prop:"description"},{default:i(()=>[n(B,{modelValue:m.description,"onUpdate:modelValue":e[8]||(e[8]=t=>m.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"])])]),_:1})}}},Oe=ne(be,[["__scopeId","data-v-63b7b6a7"]]);export{Oe as default};
