import{m as r,n as q,H as Ae,v as b,w as l,q as Ee,E as d,d as Me,r as i,I as Ye,o as u,J as ie,c as F,x as U,f as a,u as V,e as o,B as f,a as v,F as re,C as se,K as de,N as ue}from"./index-CXqDLguq.js";import{A as Te}from"./AppLayout-DhwbxZmU.js";import{p as pe}from"./participants-cnkWTAa8.js";import{o as k}from"./organizations-t79EapG9.js";import{a as Ne}from"./dateFormat-Bky3s5gS.js";import{u as Oe}from"./useResponsive-CH83388s.js";import{_ as qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Le={class:"org-detail"},He={class:"card-header"},Je={class:"header-actions"},Ke={class:"section-header"},Se={key:1,class:"departments-list"},je={class:"dept-header"},Ge={class:"dept-title"},Ie={class:"dept-name"},Qe={class:"dept-actions"},We={key:0,class:"dept-description"},Xe={key:1,class:"dept-participants"},Ze={key:0,style:{float:"right",color:"var(--color-text-secondary)","font-size":"12px"}},ea={__name:"OrganizationDetailView",setup(aa){const ee=Me(),w=Ee(),{isMobile:$}=Oe(),L=r(!1),p=r(!1),m=r(null),z=r({}),H=r({}),J=r({}),R=r(!1),K=r(null),D=q({name:"",description:""}),me={name:[{required:!0,message:"Введите название",trigger:"blur"}]},B=r(!1),S=r(null),x=q({name:"",description:""}),ae={name:[{required:!0,message:"Введите название отдела",trigger:"blur"}]},A=r(!1),j=r(null),_=q({id:null,name:"",description:""}),E=r(!1),G=r("existing"),y=r(null),P=r([]),M=r([]),I=r(!1),Q=r(null),c=q({full_name:"",birth_date:"",external_id:""}),ce={full_name:[{required:!0,message:"Введите ФИО",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},C=async()=>{L.value=!0;try{const n=await k.getById(w.params.id);m.value=n}catch{d.error("Организация не найдена"),ee.push("/organizations")}finally{L.value=!1}},fe=async()=>{K.value&&await K.value.validate(async n=>{if(n){p.value=!0;try{await k.update(w.params.id,D),d.success("Организация обновлена"),R.value=!1,await C()}catch(e){d.error(e.response?.data?.detail||"Ошибка обновления")}finally{p.value=!1}}})},ve=async()=>{S.value&&await S.value.validate(async n=>{if(n){p.value=!0;try{await k.createDepartment(w.params.id,x),d.success("Отдел создан"),B.value=!1,x.name="",x.description="",await C()}catch(e){d.error(e.response?.data?.detail||"Ошибка создания отдела")}finally{p.value=!1}}})},_e=n=>{_.id=n.id,_.name=n.name,_.description=n.description||"",A.value=!0},ye=async()=>{j.value&&await j.value.validate(async n=>{if(n){p.value=!0;try{await k.updateDepartment(w.params.id,_.id,{name:_.name,description:_.description}),d.success("Отдел обновлён"),A.value=!1,await C()}catch(e){d.error(e.response?.data?.detail||"Ошибка обновления отдела")}finally{p.value=!1}}})},ge=n=>{ue.confirm(`Удалить отдел "${n.name}"? Участники будут отвязаны, но не удалены.`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await k.deleteDepartment(w.params.id,n.id),d.success("Отдел удалён"),await C()}catch{d.error("Ошибка удаления отдела")}}).catch(()=>{})},we=async n=>{if(z.value[n]){z.value[n]=!1;return}z.value[n]=!0,await N(n)},N=async n=>{J.value[n]=!0;try{const e=await k.listDepartmentParticipants(w.params.id,n);H.value[n]=e}catch{d.error("Ошибка загрузки участников отдела")}finally{J.value[n]=!1}},be=n=>{y.value=n,P.value=[],M.value=[],G.value="existing",c.full_name="",c.birth_date="",c.external_id="",E.value=!0},Ve=async n=>{if(!n||n.length<2){M.value=[];return}I.value=!0;try{const e=await pe.search({query:n,size:20});M.value=e.items||[]}catch{M.value=[]}finally{I.value=!1}},ke=async()=>{if(!(!P.value.length||!y.value)){p.value=!0;try{await k.attachParticipants(w.params.id,y.value.id,P.value),d.success("Участники привязаны"),E.value=!1,await C(),z.value[y.value.id]&&await N(y.value.id)}catch(n){d.error(n.response?.data?.detail||"Ошибка привязки участников")}finally{p.value=!1}}},De=async()=>{!Q.value||!y.value||await Q.value.validate(async n=>{if(n){p.value=!0;try{const e=await pe.create({full_name:c.full_name,birth_date:c.birth_date||null,external_id:c.external_id||null});await k.attachParticipants(w.params.id,y.value.id,[e.id]),d.success(`Участник "${e.full_name}" создан и привязан`),E.value=!1,await C(),z.value[y.value.id]&&await N(y.value.id)}catch(e){d.error(e.response?.data?.detail||"Ошибка создания участника")}finally{p.value=!1}}})},xe=(n,e)=>{ue.confirm(`Отвязать "${e.full_name}" от отдела "${n.name}"?`,"Подтверждение",{confirmButtonText:"Отвязать",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await k.detachParticipant(w.params.id,n.id,e.id),d.success("Участник отвязан"),await C(),await N(n.id)}catch{d.error("Ошибка отвязки участника")}}).catch(()=>{})};return Ae(async()=>{await C(),m.value&&(D.name=m.value.name,D.description=m.value.description||"")}),(n,e)=>{const s=i("el-button"),O=i("el-descriptions-item"),Ce=i("el-descriptions"),W=i("el-card"),le=i("el-icon"),te=i("el-empty"),he=i("el-tag"),ze=i("el-divider"),X=i("el-table-column"),Pe=i("el-table"),h=i("el-input"),g=i("el-form-item"),Y=i("el-form"),Z=i("el-dialog"),Fe=i("el-option"),Ue=i("el-select"),ne=i("el-tab-pane"),$e=i("el-date-picker"),Re=i("el-tabs"),Be=i("el-drawer"),oe=Ye("loading");return u(),b(Te,null,{default:l(()=>[ie((u(),F("div",Le,[m.value?(u(),b(W,{key:0,class:"detail-card"},{header:l(()=>[v("div",He,[v("h2",null,f(m.value.name),1),v("div",Je,[a(s,{onClick:e[0]||(e[0]=t=>V(ee).push("/organizations"))},{default:l(()=>[...e[21]||(e[21]=[o(" Назад ",-1)])]),_:1}),a(s,{type:"primary",onClick:e[1]||(e[1]=t=>R.value=!0)},{default:l(()=>[...e[22]||(e[22]=[o(" Редактировать ",-1)])]),_:1})])])]),default:l(()=>[a(Ce,{column:V($)?1:2,border:""},{default:l(()=>[a(O,{label:"Название"},{default:l(()=>[o(f(m.value.name),1)]),_:1}),a(O,{label:"Описание"},{default:l(()=>[o(f(m.value.description||"Не указано"),1)]),_:1}),a(O,{label:"Дата создания"},{default:l(()=>[o(f(V(Ne)(m.value.created_at)),1)]),_:1}),a(O,{label:"Кол-во отделов"},{default:l(()=>[o(f(m.value.departments?.length||0),1)]),_:1})]),_:1},8,["column"])]),_:1})):U("",!0),m.value?(u(),b(W,{key:1,class:"section-card"},{header:l(()=>[v("div",Ke,[e[24]||(e[24]=v("h3",null,"Отделы",-1)),a(s,{type:"primary",onClick:e[2]||(e[2]=t=>B.value=!0)},{default:l(()=>[a(le,null,{default:l(()=>[a(V(de))]),_:1}),e[23]||(e[23]=o(" Добавить отдел ",-1))]),_:1})])]),default:l(()=>[m.value.departments?.length?(u(),F("div",Se,[(u(!0),F(re,null,se(m.value.departments,t=>(u(),b(W,{key:t.id,class:"dept-card",shadow:"hover"},{header:l(()=>[v("div",je,[v("div",Ge,[v("span",Ie,f(t.name),1),a(he,{size:"small"},{default:l(()=>[o(f(t.participants_count)+" уч. ",1)]),_:2},1024)]),v("div",Qe,[a(s,{size:"small",onClick:T=>we(t.id)},{default:l(()=>[o(f(z.value[t.id]?"Свернуть":"Участники"),1)]),_:2},1032,["onClick"]),a(s,{size:"small",type:"primary",plain:"",onClick:T=>be(t)},{default:l(()=>[a(le,null,{default:l(()=>[a(V(de))]),_:1}),e[25]||(e[25]=o(" Добавить ",-1))]),_:1},8,["onClick"]),a(s,{size:"small",onClick:T=>_e(t)},{default:l(()=>[...e[26]||(e[26]=[o(" Изменить ",-1)])]),_:1},8,["onClick"]),a(s,{size:"small",type:"danger",plain:"",onClick:T=>ge(t)},{default:l(()=>[...e[27]||(e[27]=[o(" Удалить ",-1)])]),_:1},8,["onClick"])])])]),default:l(()=>[t.description?(u(),F("div",We,f(t.description),1)):U("",!0),z.value[t.id]?ie((u(),F("div",Xe,[t.description?(u(),b(ze,{key:0})):U("",!0),e[29]||(e[29]=v("div",{class:"dept-participants-header"},[v("span",null,"Участники отдела")],-1)),H.value[t.id]?.length?(u(),b(Pe,{key:2,data:H.value[t.id],size:"small",stripe:""},{default:l(()=>[a(X,{prop:"full_name",label:"ФИО"}),a(X,{prop:"external_id",label:"Внешний ID",width:"150"}),a(X,{label:"",width:"120",align:"center"},{default:l(({row:T})=>[a(s,{type:"warning",size:"small",plain:"",onClick:la=>xe(t,T)},{default:l(()=>[...e[28]||(e[28]=[o(" Отвязать ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])):(u(),b(te,{key:1,description:"Нет участников","image-size":60}))])),[[oe,J.value[t.id]]]):U("",!0)]),_:2},1024))),128))])):(u(),b(te,{key:0,description:"Нет отделов","image-size":80}))]),_:1})):U("",!0),a(Z,{modelValue:R.value,"onUpdate:modelValue":e[6]||(e[6]=t=>R.value=t),title:"Редактировать организацию",width:V($)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[5]||(e[5]=t=>R.value=!1)},{default:l(()=>[...e[30]||(e[30]=[o(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:fe},{default:l(()=>[...e[31]||(e[31]=[o(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(Y,{ref_key:"editFormRef",ref:K,model:D,rules:me,"label-position":"top"},{default:l(()=>[a(g,{label:"Название",prop:"name"},{default:l(()=>[a(h,{modelValue:D.name,"onUpdate:modelValue":e[3]||(e[3]=t=>D.name=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"Описание",prop:"description"},{default:l(()=>[a(h,{modelValue:D.description,"onUpdate:modelValue":e[4]||(e[4]=t=>D.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(Z,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=t=>B.value=t),title:"Добавить отдел",width:V($)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[9]||(e[9]=t=>B.value=!1)},{default:l(()=>[...e[32]||(e[32]=[o(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:ve},{default:l(()=>[...e[33]||(e[33]=[o(" Создать ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(Y,{ref_key:"deptFormRef",ref:S,model:x,rules:ae,"label-position":"top"},{default:l(()=>[a(g,{label:"Название",prop:"name"},{default:l(()=>[a(h,{modelValue:x.name,"onUpdate:modelValue":e[7]||(e[7]=t=>x.name=t),placeholder:"Введите название отдела"},null,8,["modelValue"])]),_:1}),a(g,{label:"Описание",prop:"description"},{default:l(()=>[a(h,{modelValue:x.description,"onUpdate:modelValue":e[8]||(e[8]=t=>x.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(Z,{modelValue:A.value,"onUpdate:modelValue":e[14]||(e[14]=t=>A.value=t),title:"Редактировать отдел",width:V($)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[13]||(e[13]=t=>A.value=!1)},{default:l(()=>[...e[34]||(e[34]=[o(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:ye},{default:l(()=>[...e[35]||(e[35]=[o(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(Y,{ref_key:"editDeptFormRef",ref:j,model:_,rules:ae,"label-position":"top"},{default:l(()=>[a(g,{label:"Название",prop:"name"},{default:l(()=>[a(h,{modelValue:_.name,"onUpdate:modelValue":e[11]||(e[11]=t=>_.name=t)},null,8,["modelValue"])]),_:1}),a(g,{label:"Описание",prop:"description"},{default:l(()=>[a(h,{modelValue:_.description,"onUpdate:modelValue":e[12]||(e[12]=t=>_.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(Be,{modelValue:E.value,"onUpdate:modelValue":e[20]||(e[20]=t=>E.value=t),title:"Добавить участника — "+(y.value?.name||""),size:V($)?"100%":"480px",direction:"rtl","destroy-on-close":""},{default:l(()=>[a(Re,{modelValue:G.value,"onUpdate:modelValue":e[19]||(e[19]=t=>G.value=t)},{default:l(()=>[a(ne,{label:"Найти существующего",name:"existing"},{default:l(()=>[a(Y,{"label-position":"top"},{default:l(()=>[a(g,{label:"Поиск участника"},{default:l(()=>[a(Ue,{modelValue:P.value,"onUpdate:modelValue":e[15]||(e[15]=t=>P.value=t),multiple:"",filterable:"",remote:"","reserve-keyword":"",placeholder:"Введите имя для поиска","remote-method":Ve,loading:I.value,style:{width:"100%"}},{default:l(()=>[(u(!0),F(re,null,se(M.value,t=>(u(),b(Fe,{key:t.id,label:t.full_name,value:t.id},{default:l(()=>[v("span",null,f(t.full_name),1),t.external_id?(u(),F("span",Ze,f(t.external_id),1)):U("",!0)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),a(s,{type:"primary",loading:p.value,disabled:!P.value.length,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:ke},{default:l(()=>[o(" Привязать ("+f(P.value.length)+") ",1)]),_:1},8,["loading","disabled"])]),_:1}),a(ne,{label:"Создать нового",name:"create"},{default:l(()=>[a(Y,{ref_key:"newParticipantFormRef",ref:Q,model:c,rules:ce,"label-position":"top"},{default:l(()=>[a(g,{label:"ФИО",prop:"full_name"},{default:l(()=>[a(h,{modelValue:c.full_name,"onUpdate:modelValue":e[16]||(e[16]=t=>c.full_name=t),placeholder:"Введите полное имя"},null,8,["modelValue"])]),_:1}),a(g,{label:"Дата рождения",prop:"birth_date"},{default:l(()=>[a($e,{modelValue:c.birth_date,"onUpdate:modelValue":e[17]||(e[17]=t=>c.birth_date=t),type:"date",placeholder:"Выберите дату",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(g,{label:"Внешний ID",prop:"external_id"},{default:l(()=>[a(h,{modelValue:c.external_id,"onUpdate:modelValue":e[18]||(e[18]=t=>c.external_id=t),placeholder:"Внешний идентификатор (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),a(s,{type:"primary",loading:p.value,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:De},{default:l(()=>[...e[36]||(e[36]=[o(" Создать и привязать ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title","size"])])),[[oe,L.value]])]),_:1})}}},ua=qe(ea,[["__scopeId","data-v-5b58a6a8"]]);export{ua as default};
