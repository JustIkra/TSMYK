import{O as Z,P as lt,m as b,Q as j,D as st,p as ne,r as v,c as T,o as n,f as t,x as z,R as nt,w as e,u as m,S as ot,K as rt,z as $e,B as w,F as ee,H as Ie,T as je,v as g,e as _,a as d,C as se,U as be,V as Fe,E as U,q as Je,d as We,I as Ae,J as pe,W as it,k as De,X as Me,g as Re,Y as ut,Z as Pe,_ as Oe,h as Ue,$ as Be,a0 as Ve,N as ct,L as dt,a1 as pt,a2 as Xe,a3 as ft,G as mt}from"./index-DTfR6DO4.js";import{A as _t}from"./AppLayout-B0knWvzM.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as he,f as vt,g as gt}from"./metricNames-ay_YIwgL.js";import{f as yt,a as fe}from"./dateFormat-Bky3s5gS.js";import{a as He,p as Ke,u as ht}from"./useResponsive-CnBQ06PR.js";const ye={async upload(l,k){const o=new FormData;return o.append("file",k),(await Z.post(`/participants/${l}/reports`,o,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(l){return await Z.get(`/reports/${l}/download`,{responseType:"blob"})},async getById(l){return(await Z.get(`/reports/${l}`)).data},async delete(l){return(await Z.delete(`/reports/${l}`)).data},async extract(l){return(await Z.post(`/reports/${l}/extract`)).data},async getMetrics(l){return(await Z.get(`/reports/${l}/metrics`)).data},async getList(l){return(await Z.get(`/participants/${l}/reports`)).data}},Ze=lt("metrics",()=>{const l=b([]),k=b(!1),o=b(null),$=b(null),G=300*1e3,F=j(()=>$.value?Date.now()-$.value>G:!0),N=j(()=>l.value.length>0);async function E({force:p=!1,activeOnly:M=!1}={}){if(!p&&N.value&&!F.value)return l.value;if(k.value)return new Promise(I=>{const D=setInterval(()=>{k.value||(clearInterval(D),I(l.value))},50)});k.value=!0,o.value=null;try{const I=await he.listMetricDefs(M);return l.value=I.items||[],$.value=Date.now(),l.value}catch(I){const D=st(I,"Ошибка загрузки метрик");throw o.value=D.message,I.normalizedError=D,I}finally{k.value=!1}}function R(p){return l.value.find(M=>M.id===p)}function O(p){const M=R(p);return M?.name_ru||M?.name||p}function H(){$.value=null}function B(p){const M=l.value.findIndex(I=>I.id===p.id);M!==-1&&(l.value[M]=p)}function C(p){l.value=l.value.filter(M=>M.id!==p)}function A(p){l.value.push(p)}return{metricDefs:l,loading:k,error:o,isStale:F,hasData:N,fetchMetricDefs:E,getMetricDefById:R,getMetricName:O,invalidateCache:H,updateInCache:B,removeFromCache:C,addToCache:A}});function we(l,k=1){if(l==null||l==="")return"";const o=typeof l=="string"?parseFloat(l):l;return isNaN(o)?"":o.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function re(l){if(l==null||l==="")return null;const o=String(l).trim().replace(",","."),$=parseFloat(o);return isNaN($)?null:$}function wt(l){return re(l)}function bt(l,k=1){return we(l,k)}const kt={key:0,class:"error-message"},Ct={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(l,{emit:k}){const o=l,$=k,G=b(null),F=b(""),N=b(!1),E=b(!1),R=b(""),O=j(()=>re(F.value)),H=j(()=>{const c=O.value;return c===null||c<=o.min}),B=j(()=>{const c=O.value;return c===null||c>=o.max}),C=c=>{if(c==null||c===""){F.value="";return}N.value?F.value=String(c).replace(".",","):F.value=we(c,o.precision)},A=c=>{if(c==null||c==="")return E.value=!1,R.value="",!0;const x=re(c);return x===null?(E.value=!0,R.value="Некорректное число",!1):x<o.min?(E.value=!0,R.value=`Значение должно быть не меньше ${we(o.min,o.precision)}`,!1):x>o.max?(E.value=!0,R.value=`Значение должно быть не больше ${we(o.max,o.precision)}`,!1):(E.value=!1,R.value="",!0)},p=c=>{const x=c.replace(/[^\d,.-]/g,"");let f=!1;const V=x.split("").filter(S=>S===","||S==="."?f?!1:(f=!0,!0):!0).join("").replace(".",",");F.value=V;const J=re(V);J!==null?$("update:modelValue",J):(V===""||V==="-")&&$("update:modelValue",null)},M=()=>{N.value=!1;const c=re(F.value);if(A(F.value)){if(c!==null){const x=Math.round(c*Math.pow(10,o.precision))/Math.pow(10,o.precision),f=Math.max(o.min,Math.min(o.max,x));$("update:modelValue",f),C(f),$("change",f)}}else if(c!==null&&(c<o.min||c>o.max)){const x=Math.max(o.min,Math.min(o.max,c));$("update:modelValue",x),C(x),$("change",x),E.value=!1,R.value=""}$("blur")},I=()=>{N.value=!0,O.value!==null&&(F.value=String(O.value).replace(".",","))},D=()=>{const c=O.value||0,x=Math.min(o.max,c+o.step),f=Math.round(x*Math.pow(10,o.precision))/Math.pow(10,o.precision);$("update:modelValue",f),$("change",f),C(f)},u=()=>{const c=O.value||0,x=Math.max(o.min,c-o.step),f=Math.round(x*Math.pow(10,o.precision))/Math.pow(10,o.precision);$("update:modelValue",f),$("change",f),C(f)};return ne(()=>o.modelValue,c=>{C(c)},{immediate:!0}),C(o.modelValue),(c,x)=>{const f=v("el-button"),V=v("el-button-group"),J=v("el-input");return n(),T(ee,null,[t(J,{ref_key:"inputRef",ref:G,modelValue:F.value,"onUpdate:modelValue":x[0]||(x[0]=S=>F.value=S),placeholder:l.placeholder,disabled:l.disabled,class:$e({"is-invalid":E.value}),onInput:p,onBlur:M,onFocus:I},nt({_:2},[l.showControls?{name:"append",fn:e(()=>[t(V,null,{default:e(()=>[t(f,{icon:m(ot),disabled:l.disabled||H.value,onClick:u},null,8,["icon","disabled"]),t(f,{icon:m(rt),disabled:l.disabled||B.value,onClick:D},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),E.value?(n(),T("div",kt,w(R.value),1)):z("",!0)],64)}}},xt=me(Ct,[["__scopeId","data-v-ff39cd14"]]),Et={class:"card-header"},St={class:"card-header-left"},$t={class:"card-header-actions"},Dt={class:"metrics-filter"},Mt={class:"metrics-stats"},Rt={class:"metrics-count"},Vt={key:0,class:"metric-description"},It={key:0,class:"metrics-info"},Ft={class:"info-row"},At={key:0,class:"info-row"},Tt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0},reportStatus:{type:String,default:null},reportExtractWarning:{type:String,default:null}},emits:["metrics-updated"],setup(l,{emit:k}){const o=l,$=k,G=b(!1),F=b(!1),N=b(!1),E=b(null),R=b(!1),O=b(0),H=b(0),B=b([]),C=b([]),A=b({metrics:{}}),p=b({}),M=b("metrics"),I=b(null),D=j(()=>{if(!B.value||B.value.length===0)return[];if(R.value)return B.value;const h=new Set(C.value.filter(r=>{const a=parseFloat(String(r.value).replace(",","."));return!isNaN(a)&&a>0}).map(r=>r.metric_def_id));return B.value.filter(r=>{const a=h.has(r.id),P=A.value.metrics[r.id],K=P!=null&&P!==""&&parseFloat(String(P).replace(",","."))>0;return a||K})}),u=j(()=>!C.value||C.value.length===0?[]:[...new Set(C.value.map(h=>h.source))]),c=j(()=>{if(!C.value||C.value.length===0)return null;const h=C.value.map(r=>r.updated_at||r.created_at).filter(Boolean).map(r=>new Date(r));return h.length===0?null:new Date(Math.max(...h))}),x=async()=>{G.value=!0,E.value=null;try{const h=await he.getMetricTemplate(o.reportId);O.value=h.filled_count||0,H.value=h.missing_count||0;const r=h.items||[];C.value=r.filter(a=>a.value!==null).map(a=>({metric_def_id:a.metric_def.id,value:a.value,source:a.source,confidence:a.confidence,notes:a.notes,updated_at:a.updated_at})),B.value=r.map(a=>({id:a.metric_def.id,code:a.metric_def.code,name:a.metric_def.name,name_ru:a.metric_def.name_ru,unit:a.metric_def.unit,min_value:a.metric_def.min_value,max_value:a.metric_def.max_value,description:a.metric_def.description})),A.value.metrics={},r.forEach(a=>{const P=a.metric_def.id;a.value!==null?A.value.metrics[P]=re(a.value):A.value.metrics[P]=null}),p.value=JSON.parse(JSON.stringify(A.value.metrics))}catch(h){console.error("Failed to load metrics:",h),E.value="Не удалось загрузить метрики"}finally{G.value=!1}},f=async()=>{await x(),U.success("Метрики обновлены")},V=()=>{I.value||(I.value=setInterval(async()=>{await x()},5e3))},J=()=>{I.value&&(clearInterval(I.value),I.value=null)},S=()=>{N.value=!0,R.value=!0,p.value=JSON.parse(JSON.stringify(A.value.metrics))},Y=()=>{A.value.metrics=JSON.parse(JSON.stringify(p.value)),N.value=!1,E.value=null},ie=async()=>{F.value=!0,E.value=null;try{const h=[],r=[];for(const[W,te]of Object.entries(A.value.metrics)){const ae=p.value[W],ce=ae!=null&&ae!=="";if(te!=null&&te!==""){const le=wt(te);le!==null&&h.push({metric_def_id:W,value:le,source:"MANUAL",notes:null})}else ce&&r.push(W)}const P=(await Promise.allSettled(r.map(W=>he.clearExtractedMetric(o.reportId,W)))).filter(W=>W.status==="fulfilled"||W.status==="rejected"&&W.reason?.response?.status===404).length;h.length>0&&await he.bulkCreateExtractedMetrics(o.reportId,h);const K=[];h.length>0&&K.push(`сохранено: ${h.length}`),P>0&&K.push(`сброшено: ${P}`),K.length===0?U.info("Нет изменений для сохранения"):U.success(`Метрики обновлены (${K.join(", ")})`),N.value=!1,await x(),$("metrics-updated")}catch(h){console.error("Failed to save metrics:",h);let r="Не удалось сохранить метрики";h.response?.data?.detail&&(typeof h.response.data.detail=="string"?r=h.response.data.detail:Array.isArray(h.response.data.detail)&&(r=h.response.data.detail.map(a=>a.msg||a.message).join(", "))),E.value=r,U.error(r)}finally{F.value=!1}},Q=h=>{switch(h){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},ue=h=>{switch(h){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return h}},oe=yt;return Ie(async()=>{}),je(()=>{J()}),ne(()=>o.reportId,async h=>{h&&await x()}),ne(()=>o.reportStatus,async(h,r)=>{r||await x(),h==="PROCESSING"?(V(),r&&r!=="PROCESSING"&&await x()):(J(),h==="EXTRACTED"&&r&&r!=="EXTRACTED"&&await x())},{immediate:!0}),(h,r)=>{const a=v("el-icon"),P=v("el-tag"),K=v("el-button"),W=v("el-alert"),te=v("el-switch"),ae=v("el-form-item"),ce=v("el-col"),le=v("el-row"),_e=v("el-form"),ke=v("el-divider"),Ce=v("el-tab-pane"),xe=v("el-tabs"),Ee=v("el-card");return n(),g(Ee,{class:"metrics-editor"},{header:e(()=>[d("div",Et,[d("div",St,[r[5]||(r[5]=d("span",null,"Метрики отчёта",-1)),l.reportStatus==="PROCESSING"?(n(),g(P,{key:0,type:"warning",size:"small",class:"status-tag"},{default:e(()=>[t(a,{class:"is-loading"},{default:e(()=>[t(m(be))]),_:1}),r[3]||(r[3]=_(" Извлечение... ",-1))]),_:1})):l.reportStatus==="EXTRACTED"?(n(),g(P,{key:1,type:"success",size:"small",class:"status-tag"},{default:e(()=>[...r[4]||(r[4]=[_(" Извлечено ",-1)])]),_:1})):z("",!0)]),d("div",$t,[N.value?z("",!0):(n(),g(K,{key:0,size:"small",loading:G.value,onClick:f},{default:e(()=>[t(a,null,{default:e(()=>[t(m(Fe))]),_:1}),r[6]||(r[6]=_(" Обновить ",-1))]),_:1},8,["loading"])),N.value?(n(),T(ee,{key:2},[t(K,{size:"small",onClick:Y},{default:e(()=>[...r[8]||(r[8]=[_(" Отмена ",-1)])]),_:1}),t(K,{type:"primary",size:"small",loading:F.value,onClick:ie},{default:e(()=>[...r[9]||(r[9]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])],64)):(n(),g(K,{key:1,type:"primary",size:"small",onClick:S},{default:e(()=>[...r[7]||(r[7]=[_(" Редактировать ",-1)])]),_:1}))])])]),default:e(()=>[E.value?(n(),g(W,{key:0,type:"error",title:E.value,closable:"",style:{"margin-bottom":"16px"},onClose:r[0]||(r[0]=X=>E.value=null)},null,8,["title"])):z("",!0),o.reportExtractWarning&&o.reportStatus==="EXTRACTED"?(n(),g(W,{key:1,type:"warning",title:o.reportExtractWarning,closable:!1,style:{"margin-bottom":"16px"}},null,8,["title"])):z("",!0),!C.value||C.value.length===0?(n(),g(W,{key:2,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...r[10]||(r[10]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):z("",!0),t(xe,{modelValue:M.value,"onUpdate:modelValue":r[2]||(r[2]=X=>M.value=X),type:"card"},{default:e(()=>[t(Ce,{label:"Метрики",name:"metrics"},{default:e(()=>[d("div",Dt,[t(te,{modelValue:R.value,"onUpdate:modelValue":r[1]||(r[1]=X=>R.value=X),"active-text":"Показать все метрики","inactive-text":"Только заполненные"},null,8,["modelValue"]),d("div",Mt,[t(P,{type:"success",size:"small"},{default:e(()=>[_(" Заполнено: "+w(O.value),1)]),_:1}),t(P,{type:"info",size:"small"},{default:e(()=>[_(" Не заполнено: "+w(H.value),1)]),_:1}),d("span",Rt," Показано: "+w(D.value.length)+" из "+w(B.value.length),1)])]),t(_e,{ref:"formRef",model:A.value,"label-position":"top",disabled:!N.value},{default:e(()=>[t(le,{gutter:20},{default:e(()=>[(n(!0),T(ee,null,se(D.value,X=>(n(),g(ce,{key:X.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ae,{label:m(vt)(X),prop:`metrics.${X.id}`},{default:e(()=>[t(xt,{modelValue:A.value.metrics[X.id],"onUpdate:modelValue":i=>A.value.metrics[X.id]=i,min:X.min_value||1,max:X.max_value||10,precision:1,step:.1,disabled:!N.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),X.description?(n(),T("div",Vt,w(X.description),1)):z("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),C.value&&C.value.length>0?(n(),T("div",It,[t(ke),d("div",Ft,[r[11]||(r[11]=d("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),T(ee,null,se(u.value,X=>(n(),g(P,{key:X,type:Q(X),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(w(ue(X)),1)]),_:2},1032,["type"]))),128))]),c.value?(n(),T("div",At,[r[12]||(r[12]=d("span",{class:"info-label"},"Последнее обновление:",-1)),d("span",null,w(m(oe)(c.value)),1)])):z("",!0)])):z("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Nt=me(Tt,[["__scopeId","data-v-b43d5796"]]),zt={class:"report-list"},Lt={class:"report-list__controls"},Pt={class:"controls-left"},Ot={class:"controls-right"},Ut={class:"filename"},Bt={class:"status-cell"},Xt={key:1,class:"report-list__cards"},Gt={class:"report-card__header"},qt={class:"report-card__status"},jt={class:"report-card__body"},Jt={class:"report-card__field"},Wt={class:"field-value field-value--filename"},Ht={class:"report-card__field"},Kt={class:"field-value"},Zt={class:"report-card__actions"},Qt={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(l,{emit:k}){const o=l,$=k,G=Je(),F=We(),{isMobile:N}=He();Ie(()=>{G.query.status&&(E.value=G.query.status),G.query.sort&&(R.value=G.query.sort)});const E=b(""),R=b("desc"),O=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ne([E,R],([D,u])=>{const c={...G.query};D?c.status=D:delete c.status,u?c.sort=u:delete c.sort,F.replace({query:c})});const H=()=>{},B=()=>{R.value=R.value==="desc"?"asc":"desc"},C=j(()=>{let D=[...o.reports];return E.value&&(D=D.filter(u=>u.status===E.value)),D.sort((u,c)=>{const x=new Date(u.uploaded_at),f=new Date(c.uploaded_at);return R.value==="desc"?f-x:x-f}),D}),A=j(()=>E.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),p=D=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[D]||D,M=D=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[D]||"info",I=async({action:D,report:u})=>{switch(D){case"view":$("view",u.id);break;case"edit":$("edit",u.id);break;case"extract":$("extract",u.id);break;case"download":$("download",u.id);break;case"delete":try{await ct.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),$("delete",u.id)}catch{}break}};return(D,u)=>{const c=v("el-option"),x=v("el-select"),f=v("el-icon"),V=v("el-button"),J=v("el-table-column"),S=v("el-tag"),Y=v("el-dropdown-item"),ie=v("el-dropdown-menu"),Q=v("el-dropdown"),ue=v("el-table"),oe=v("el-card"),h=v("el-empty"),r=Ae("loading");return n(),T("div",zt,[d("div",Lt,[d("div",Pt,[t(x,{modelValue:E.value,"onUpdate:modelValue":u[0]||(u[0]=a=>E.value=a),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:H},{default:e(()=>[t(c,{label:"Все статусы",value:""}),(n(),T(ee,null,se(O,a=>t(c,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),d("div",Ot,[t(V,{type:R.value==="desc"?"primary":"default",size:"small",onClick:B},{default:e(()=>[t(f,null,{default:e(()=>[t(m(it))]),_:1}),_(" "+w(R.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),m(N)?pe((n(),T("div",Xt,[(n(!0),T(ee,null,se(C.value,a=>(n(),g(oe,{key:a.id,class:"report-card",shadow:"hover"},{header:e(()=>[d("div",Gt,[d("div",qt,[a.status==="PROCESSING"?(n(),g(f,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(m(be))]),_:1})):a.status==="EXTRACTED"?(n(),g(f,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(m(De))]),_:1})):a.status==="FAILED"?(n(),g(f,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(m(Me))]),_:1})):(n(),g(f,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(m(Re))]),_:1})),t(S,{type:M(a.status),size:"small"},{default:e(()=>[_(w(p(a.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[d("div",Zt,[a.status==="EXTRACTED"?(n(),g(V,{key:0,type:"success",size:"small",onClick:P=>I({action:"edit",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Pe))]),_:1}),u[10]||(u[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):z("",!0),a.status==="PROCESSING"||a.status==="EXTRACTED"?(n(),g(V,{key:1,type:"info",size:"small",onClick:P=>I({action:"view",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Oe))]),_:1}),u[11]||(u[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):z("",!0),t(V,{type:"primary",size:"small",onClick:P=>I({action:"extract",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ue))]),_:1}),_(" "+w(a.status==="FAILED"?"Повторить":a.status==="PROCESSING"?"Перезапустить":a.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(V,{size:"small",onClick:P=>I({action:"download",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Be))]),_:1}),u[12]||(u[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(V,{type:"danger",size:"small",onClick:P=>I({action:"delete",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ve))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[d("div",jt,[d("div",Jt,[u[8]||(u[8]=d("span",{class:"field-label"},"Файл:",-1)),d("span",Wt,w(a.file_ref?.filename||"Без названия"),1)]),d("div",Ht,[u[9]||(u[9]=d("span",{class:"field-label"},"Дата загрузки:",-1)),d("span",Kt,w(m(fe)(a.uploaded_at)),1)])])]),_:2},1024))),128)),!C.value.length&&!l.loading?(n(),g(h,{key:0,description:A.value,"image-size":120},{default:e(()=>[E.value?z("",!0):(n(),g(V,{key:0,type:"primary",onClick:u[1]||(u[1]=a=>D.$emit("upload"))},{default:e(()=>[...u[13]||(u[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):z("",!0)])),[[r,l.loading]]):pe((n(),g(ue,{key:0,data:C.value,class:"report-list__table",stripe:"","empty-text":A.value},{default:e(()=>[t(J,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:a})=>[d("span",Ut,w(a.file_ref?.filename||"Без названия"),1)]),_:1}),t(J,{prop:"status",label:"Статус",width:"200"},{default:e(({row:a})=>[d("div",Bt,[a.status==="PROCESSING"?(n(),g(f,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(m(be))]),_:1})):a.status==="EXTRACTED"?(n(),g(f,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(m(De))]),_:1})):a.status==="FAILED"?(n(),g(f,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(m(Me))]),_:1})):(n(),g(f,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(m(Re))]),_:1})),t(S,{type:M(a.status),size:"default"},{default:e(()=>[_(w(p(a.status)),1)]),_:2},1032,["type"])])]),_:1}),t(J,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:a})=>[_(w(m(fe)(a.uploaded_at)),1)]),_:1}),t(J,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:a})=>[t(Q,{trigger:"click",onCommand:I},{dropdown:e(()=>[t(ie,null,{default:e(()=>[a.status==="EXTRACTED"?(n(),g(Y,{key:0,command:{action:"edit",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Pe))]),_:1}),u[4]||(u[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):z("",!0),a.status==="PROCESSING"||a.status==="EXTRACTED"?(n(),g(Y,{key:1,command:{action:"view",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Oe))]),_:1}),u[5]||(u[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):z("",!0),t(Y,{command:{action:"extract",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ue))]),_:1}),_(" "+w(a.status==="FAILED"?"Повторить извлечение":a.status==="PROCESSING"?"Перезапустить извлечение":a.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(Y,{divided:"",command:{action:"download",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Be))]),_:1}),u[6]||(u[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(Y,{command:{action:"delete",report:a},class:"dropdown-item--danger"},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ve))]),_:1}),u[7]||(u[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(V,{type:"primary",size:"small"},{default:e(()=>[u[3]||(u[3]=_(" Действия ",-1)),t(f,{class:"el-icon--right"},{default:e(()=>[t(m(ut))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[r,l.loading]]),!C.value.length&&!l.loading&&!m(N)?(n(),g(h,{key:2,description:A.value,"image-size":120},{default:e(()=>[E.value?z("",!0):(n(),g(V,{key:0,type:"primary",onClick:u[2]||(u[2]=a=>D.$emit("upload"))},{default:e(()=>[...u[14]||(u[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):z("",!0)])}}},Yt=me(Qt,[["__scopeId","data-v-5eecde76"]]),ea={class:"metrics-drawer"},ta={class:"drawer-actions"},aa={key:1},la={key:1},sa={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(l,{emit:k}){const o=l,$=k,G=Ze(),F=b(!1),N=b([]),E=j(()=>G.metricDefs),R=j(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),O=p=>{$("update:modelValue",p)},H=async()=>{try{await G.fetchMetricDefs({activeOnly:!0})}catch(p){console.error("Error loading metric definitions:",p)}},B=async()=>{F.value=!0;try{const p=await Ke.getMetrics(o.participantId);N.value=p.metrics||[]}catch(p){console.error("Error loading participant metrics:",p),U.error("Ошибка загрузки метрик участника")}finally{F.value=!1}},C=p=>{if(!p)return"—";const M=E.value?.find(D=>D.code===p);return gt(M,p,{warn:()=>{}})},A=p=>p>=.8?"var(--el-color-success)":p>=.6?"var(--el-color-warning)":"var(--el-color-danger)";return ne(()=>o.participantId,async p=>{p&&o.modelValue&&(await H(),await B())}),ne(()=>o.modelValue,async p=>{p&&o.participantId&&(await H(),await B())}),(p,M)=>{const I=v("el-icon"),D=v("el-button"),u=v("el-table-column"),c=v("el-tag"),x=v("el-table"),f=v("el-empty"),V=v("el-drawer"),J=Ae("loading");return n(),g(V,{"model-value":l.modelValue,title:`Метрики участника: ${l.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":O},{default:e(()=>[pe((n(),T("div",ea,[d("div",ta,[t(D,{type:"primary",size:"small",onClick:B},{default:e(()=>[t(I,null,{default:e(()=>[t(m(Fe))]),_:1}),M[0]||(M[0]=_(" Обновить ",-1))]),_:1})]),t(x,{data:N.value,stripe:"","empty-text":R.value},{default:e(()=>[t(u,{prop:"metric_code",label:"Код метрики",width:"200"}),t(u,{label:"Название метрики","min-width":"250"},{default:e(({row:S})=>[_(w(C(S.metric_code)),1)]),_:1}),t(u,{prop:"value",label:"Значение",width:"120"},{default:e(({row:S})=>[t(c,{type:"success"},{default:e(()=>[_(w(m(bt)(S.value)),1)]),_:2},1024)]),_:1}),t(u,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:S})=>[S.confidence!==null?(n(),T("span",{key:0,style:dt({color:A(S.confidence)})},w((S.confidence*100).toFixed(0))+"% ",5)):(n(),T("span",aa,"—"))]),_:1}),t(u,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:S})=>[_(w(m(fe)(S.updated_at)),1)]),_:1}),t(u,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:S})=>[S.last_source_report_id?(n(),g(c,{key:0,size:"small"},{default:e(()=>[...M[1]||(M[1]=[_(" Из отчёта ",-1)])]),_:1})):(n(),T("span",la,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!N.value.length&&!F.value?(n(),g(f,{key:0,description:R.value},null,8,["description"])):z("",!0)])),[[J,F.value]])]),_:1},8,["model-value","title"])}}},na=me(sa,[["__scopeId","data-v-81d85b13"]]),Ge={async getParticipantScores(l){return(await Z.get(`/scoring/participants/${l}`)).data},async recalculateParticipant(l,k=null){return(await Z.post(`/scoring/participants/${l}/recalculate`,k?{weight_table_ids:k}:{})).data},async calculateSingle(l,k){return(await Z.post(`/scoring/participants/${l}/calculate/${k}`)).data},async batchRecalculate({participantIds:l=null,weightTableIds:k=null}={}){return(await Z.post("/scoring/batch/recalculate",{participant_ids:l,weight_table_ids:k})).data}},oa={class:"participant-detail"},ra={class:"card-header"},ia={class:"header-actions"},ua={class:"section-header"},ca={class:"section-header"},da={class:"scoring-content"},pa={key:1,class:"scoring-cards"},fa={class:"scoring-card-header"},ma={class:"scoring-model-name"},_a={class:"scoring-details"},va={class:"scoring-row"},ga={class:"scoring-value"},ya={class:"scoring-row"},ha={key:1,class:"scoring-penalties"},wa={class:"penalties-header"},ba={class:"penalty-metric"},ka={class:"penalty-info"},Ca={class:"scoring-footer"},xa={key:0,class:"batch-files-list"},Ea={class:"batch-files-header"},Sa={class:"batch-file-info"},$a={class:"batch-file-name"},Da={class:"batch-file-size"},Ma={key:0,class:"batch-file-error"},qe=20*1024*1024,Se=10,Ra={__name:"ParticipantDetailView",setup(l){const k=We(),o=Je(),$=ht(),G=Ze(),F=b(!1),N=b(!1),E=b(!1),R=b(!1),O=b([]),{isMobile:H}=He(),B=b(!1),C=j(()=>$.currentParticipant),A=b([]),p=b(null);j(()=>G.metricDefs);const M=b(null),I=j(()=>A.value.some(i=>i.status==="PROCESSING")),D=j(()=>p.value&&A.value.find(s=>s.id===p.value)?.status||null),u=j(()=>p.value&&A.value.find(s=>s.id===p.value)?.extract_warning||null),c=b(!1),x=b(!1),f=b(!1),V=b(null),J=b([]),S=b([]);let Y=0;const ie=async()=>{F.value=!0;try{await $.getParticipant(o.params.id)}catch{U.error("Участник не найден"),k.push("/participants")}finally{F.value=!1}},Q=async({silent:i=!1}={})=>{i||(N.value=!0);try{const s=await Ke.getReports(o.params.id);A.value=s.items||[]}catch(s){console.error("Error loading reports:",s),U.error("Ошибка загрузки списка отчётов")}finally{i||(N.value=!1)}},ue=async()=>{try{await G.fetchMetricDefs({activeOnly:!0})}catch(i){console.error("Error loading metric definitions:",i)}},oe=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(1)+" KB":(i/(1024*1024)).toFixed(1)+" MB",h=i=>i.name.toLowerCase().endsWith(".docx")?i.size>qe?`Размер файла превышает ${oe(qe)}`:null:"Только файлы формата .docx",r=(i,s)=>{const q=i.raw;if(S.value.length>=Se){U.warning(`Максимальное количество файлов: ${Se}`),V.value&&V.value.clearFiles();return}const L=h(q);if(L){U.error(L),V.value&&V.value.clearFiles();return}S.value.push({id:++Y,file:q,name:q.name,size:q.size,status:"pending",progress:0,error:null,reportId:null}),V.value&&V.value.clearFiles()},a=i=>{S.value=S.value.filter(s=>s.id!==i)},P=async i=>{i.status="uploading",i.progress=0;try{const s=await ye.upload(o.params.id,i.file);i.status="success",i.reportId=s.id}catch(s){i.status="error",i.error=s.response?.data?.detail||"Ошибка загрузки"}},K=async()=>{const i=S.value.filter(s=>s.status==="pending");if(i.length===0){U.warning("Нет файлов для загрузки");return}B.value=!0;try{await Promise.allSettled(i.map(L=>P(L)));const s=S.value.filter(L=>L.status==="success").length,q=S.value.filter(L=>L.status==="error").length;q===0?(U.success(`Загружено ${s} отчётов`),c.value=!1,W()):U.warning(`Загружено: ${s}, ошибок: ${q}`),await Q()}finally{B.value=!1}},W=()=>{S.value=[],J.value=[],V.value&&V.value.clearFiles()},te=async i=>{try{const s=await ye.download(i),q=window.URL.createObjectURL(new Blob([s.data])),L=document.createElement("a");L.href=q,L.setAttribute("download",`report_${i}.docx`),document.body.appendChild(L),L.click(),L.remove(),window.URL.revokeObjectURL(q),U.success("Отчёт скачан")}catch{U.error("Ошибка скачивания отчёта")}},ae=async i=>{try{await ye.extract(i),U.success("Извлечение метрик запущено"),await Q()}catch{U.error("Ошибка запуска извлечения метрик")}},ce=()=>{M.value||(M.value=setInterval(async()=>{try{await Q({silent:!0})}catch(i){console.error("Auto-refresh error:",i)}},3e3))},le=()=>{M.value&&(clearInterval(M.value),M.value=null)};ne(I,i=>{i?ce():le()});const _e=async i=>{p.value=i,await mt(),x.value=!0},ke=async()=>{U.success("Метрики обновлены"),await Q({silent:!0})},Ce=async i=>{try{await ye.delete(i),U.success("Отчёт удалён"),await Q()}catch{U.error("Ошибка удаления отчёта")}},xe=async()=>{E.value=!0;try{const i=await Ge.getParticipantScores(o.params.id);O.value=i.results||[]}catch(i){console.error("Error loading scoring:",i),O.value=[]}finally{E.value=!1}},Ee=async()=>{R.value=!0;try{const i=await Ge.recalculateParticipant(o.params.id);O.value=i,U.success(`Скоринг рассчитан для ${i.length} моделей`)}catch(i){console.error("Error recalculating scoring:",i),U.error(i.response?.data?.detail||"Ошибка расчёта скоринга")}finally{R.value=!1}},X=i=>{const s=parseFloat(i);return s>=7?"success":s>=5?"warning":"danger"};return Ie(async()=>{await Promise.all([ie(),Q(),ue(),xe()])}),je(()=>{le()}),(i,s)=>{const q=v("el-button"),L=v("el-icon"),ve=v("el-descriptions-item"),Qe=v("el-descriptions"),ge=v("el-card"),Ye=v("el-empty"),Te=v("el-tag"),et=v("el-divider"),Ne=v("el-text"),tt=v("el-upload"),ze=v("el-dialog"),Le=Ae("loading");return n(),g(_t,null,{default:e(()=>[pe((n(),T("div",oa,[C.value?(n(),g(ge,{key:0,class:"detail-card"},{header:e(()=>[d("div",ra,[d("h2",null,w(C.value.full_name),1),d("div",ia,[t(q,{onClick:s[0]||(s[0]=y=>m(k).back())},{default:e(()=>[...s[8]||(s[8]=[_(" Назад ",-1)])]),_:1}),t(q,{type:"info",onClick:s[1]||(s[1]=y=>f.value=!0)},{default:e(()=>[t(L,null,{default:e(()=>[t(m(pt))]),_:1}),s[9]||(s[9]=_(" Метрики ",-1))]),_:1})])])]),default:e(()=>[t(Qe,{column:m(H)?1:2,border:""},{default:e(()=>[t(ve,{label:"ФИО"},{default:e(()=>[_(w(C.value.full_name),1)]),_:1}),t(ve,{label:"Дата рождения"},{default:e(()=>[_(w(C.value.birth_date||"Не указана"),1)]),_:1}),t(ve,{label:"Внешний ID"},{default:e(()=>[_(w(C.value.external_id||"Не указан"),1)]),_:1}),t(ve,{label:"Дата создания"},{default:e(()=>[_(w(m(fe)(C.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):z("",!0),t(ge,{class:"section-card"},{header:e(()=>[d("div",ua,[s[11]||(s[11]=d("h3",null,"Отчёты",-1)),t(q,{type:"primary",onClick:s[2]||(s[2]=y=>c.value=!0)},{default:e(()=>[t(L,null,{default:e(()=>[t(m(Xe))]),_:1}),s[10]||(s[10]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(Yt,{reports:A.value,loading:N.value,onView:_e,onEdit:_e,onExtract:ae,onDownload:te,onDelete:Ce,onUpload:s[3]||(s[3]=y=>c.value=!0)},null,8,["reports","loading"])]),_:1}),t(ge,{class:"section-card"},{header:e(()=>[d("div",ca,[s[13]||(s[13]=d("h3",null,"Скоринг по моделям компетенций",-1)),t(q,{type:"primary",loading:R.value,onClick:Ee},{default:e(()=>[t(L,null,{default:e(()=>[t(m(Fe))]),_:1}),s[12]||(s[12]=_(" Пересчитать ",-1))]),_:1},8,["loading"])])]),default:e(()=>[pe((n(),T("div",da,[!E.value&&O.value.length===0?(n(),g(Ye,{key:0,description:"Скоринг ещё не рассчитан. Нажмите «Пересчитать» для расчёта."})):(n(),T("div",pa,[(n(!0),T(ee,null,se(O.value,y=>(n(),g(ge,{key:y.id,class:"scoring-result-card",shadow:"hover"},{header:e(()=>[d("div",fa,[d("span",ma,w(y.prof_activity_name),1),t(Te,{type:X(y.final_score),size:"large",class:"scoring-final-tag"},{default:e(()=>[_(w(parseFloat(y.final_score).toFixed(1)),1)]),_:2},1032,["type"])])]),default:e(()=>[d("div",_a,[d("div",va,[s[14]||(s[14]=d("span",{class:"scoring-label"},"Базовый балл:",-1)),d("span",ga,w(parseFloat(y.base_score).toFixed(2)),1)]),d("div",ya,[s[15]||(s[15]=d("span",{class:"scoring-label"},"Множитель штрафов:",-1)),d("span",{class:$e(["scoring-value",{"scoring-value--penalty":parseFloat(y.penalty_multiplier)<1}])}," × "+w(parseFloat(y.penalty_multiplier).toFixed(2)),3)]),y.penalties_applied&&y.penalties_applied.length>0?(n(),g(et,{key:0})):z("",!0),y.penalties_applied&&y.penalties_applied.length>0?(n(),T("div",ha,[d("div",wa,[t(L,{color:"var(--el-color-warning)"},{default:e(()=>[t(m(ft))]),_:1}),s[16]||(s[16]=d("span",null,"Применённые штрафы:",-1))]),(n(!0),T(ee,null,se(y.penalties_applied,(de,at)=>(n(),T("div",{key:at,class:"penalty-item"},[d("span",ba,w(de.metric_code),1),d("span",ka,w(parseFloat(de.value).toFixed(1))+" < "+w(parseFloat(de.threshold).toFixed(1)),1),t(Te,{type:"danger",size:"small"},{default:e(()=>[_(" -"+w((parseFloat(de.penalty)*100).toFixed(0))+"% ",1)]),_:2},1024)]))),128))])):(n(),g(Ne,{key:2,type:"success",size:"small"},{default:e(()=>[...s[17]||(s[17]=[_(" Штрафы не применены ",-1)])]),_:1}))]),d("div",Ca,[t(Ne,{type:"info",size:"small"},{default:e(()=>[_(" Рассчитано: "+w(m(fe)(y.computed_at)),1)]),_:2},1024)])]),_:2},1024))),128))]))])),[[Le,E.value]])]),_:1}),t(ze,{modelValue:c.value,"onUpdate:modelValue":s[5]||(s[5]=y=>c.value=y),title:"Загрузить отчёты",width:m(H)?"95%":"600px","destroy-on-close":"",onClose:W},{footer:e(()=>[t(q,{onClick:s[4]||(s[4]=y=>c.value=!1)},{default:e(()=>[...s[20]||(s[20]=[_(" Отмена ",-1)])]),_:1}),t(q,{type:"primary",loading:B.value,disabled:!S.value.some(y=>y.status==="pending"),onClick:K},{default:e(()=>[_(" Загрузить все ("+w(S.value.filter(y=>y.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(tt,{ref_key:"uploadRef",ref:V,"auto-upload":!1,multiple:"",accept:".docx","on-change":r,"show-file-list":!1,drag:""},{tip:e(()=>[...s[18]||(s[18]=[d("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t(L,{class:"el-icon--upload"},{default:e(()=>[t(m(Xe))]),_:1}),s[19]||(s[19]=d("div",{class:"el-upload__text"},[_(" Перетащите файлы сюда или "),d("em",null,"нажмите для выбора")],-1))]),_:1},512),S.value.length?(n(),T("div",xa,[d("div",Ea," Выбрано файлов: "+w(S.value.length)+"/"+w(Se),1),(n(!0),T(ee,null,se(S.value,y=>(n(),T("div",{key:y.id,class:$e(["batch-file-item","batch-file-item--"+y.status])},[y.status==="pending"?(n(),g(L,{key:0,class:"batch-file-icon"},{default:e(()=>[t(m(Re))]),_:1})):y.status==="uploading"?(n(),g(L,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(m(be))]),_:1})):y.status==="success"?(n(),g(L,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(m(De))]),_:1})):y.status==="error"?(n(),g(L,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(m(Me))]),_:1})):z("",!0),d("div",Sa,[d("span",$a,w(y.name),1),d("span",Da,w(oe(y.size)),1),y.error?(n(),T("span",Ma,w(y.error),1)):z("",!0)]),y.status==="pending"||y.status==="error"?(n(),g(q,{key:4,type:"danger",icon:m(Ve),circle:"",size:"small",onClick:de=>a(y.id)},null,8,["icon","onClick"])):z("",!0)],2))),128))])):z("",!0)]),_:1},8,["modelValue","width"]),t(ze,{modelValue:x.value,"onUpdate:modelValue":s[6]||(s[6]=y=>x.value=y),title:"Метрики отчёта",width:"90%",top:"5vh","destroy-on-close":""},{default:e(()=>[p.value?(n(),g(Nt,{key:0,"report-id":p.value,"report-status":D.value,"report-extract-warning":u.value,onMetricsUpdated:ke},null,8,["report-id","report-status","report-extract-warning"])):z("",!0)]),_:1},8,["modelValue"]),t(na,{modelValue:f.value,"onUpdate:modelValue":s[7]||(s[7]=y=>f.value=y),"participant-id":C.value?.id,"participant-name":C.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Le,F.value]])]),_:1})}}},za=me(Ra,[["__scopeId","data-v-5bd80d5c"]]);export{za as default};
