import{m as s,n as X,H as Ce,v as _,w as a,q as xe,E as u,d as ze,r,I as $e,o as d,J as te,c as x,x as h,f as l,u as y,e as n,B as c,a as f,F as le,C as oe,K as ne,N as ie}from"./index-pMPAA_ZS.js";import{A as he}from"./AppLayout-DAeAYoqy.js";import{p as Fe}from"./participants-CmlL1aEQ.js";import{o as V}from"./organizations-BliYB-Bx.js";import{a as Pe}from"./dateFormat-Bky3s5gS.js";import{u as Be}from"./useResponsive-55PwFRX2.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ue={class:"org-detail"},Ee={class:"card-header"},Ae={class:"header-actions"},Ne={class:"section-header"},Oe={key:1,class:"departments-list"},Te={class:"dept-header"},Me={class:"dept-title"},Le={class:"dept-name"},qe={class:"dept-actions"},He={key:0,class:"dept-description"},Je={key:1,class:"dept-participants"},Ke={key:0,style:{float:"right",color:"var(--color-text-secondary)","font-size":"12px"}},Se={__name:"OrganizationDetailView",setup(je){const Y=ze(),g=xe(),{isMobile:F}=Be(),L=s(!1),m=s(!1),p=s(null),z=s({}),q=s({}),H=s({}),P=s(!1),J=s(null),w=X({name:"",description:""}),se={name:[{required:!0,message:"Введите название",trigger:"blur"}]},B=s(!1),K=s(null),k=X({name:"",description:""}),Z={name:[{required:!0,message:"Введите название отдела",trigger:"blur"}]},R=s(!1),S=s(null),v=X({id:null,name:"",description:""}),U=s(!1),E=s(null),b=s([]),A=s([]),j=s(!1),D=async()=>{L.value=!0;try{const o=await V.getById(g.params.id);p.value=o}catch{u.error("Организация не найдена"),Y.push("/organizations")}finally{L.value=!1}},re=async()=>{J.value&&await J.value.validate(async o=>{if(o){m.value=!0;try{await V.update(g.params.id,w),u.success("Организация обновлена"),P.value=!1,await D()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления")}finally{m.value=!1}}})},de=async()=>{K.value&&await K.value.validate(async o=>{if(o){m.value=!0;try{await V.createDepartment(g.params.id,k),u.success("Отдел создан"),B.value=!1,k.name="",k.description="",await D()}catch(e){u.error(e.response?.data?.detail||"Ошибка создания отдела")}finally{m.value=!1}}})},ue=o=>{v.id=o.id,v.name=o.name,v.description=o.description||"",R.value=!0},pe=async()=>{S.value&&await S.value.validate(async o=>{if(o){m.value=!0;try{await V.updateDepartment(g.params.id,v.id,{name:v.name,description:v.description}),u.success("Отдел обновлён"),R.value=!1,await D()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления отдела")}finally{m.value=!1}}})},me=o=>{ie.confirm(`Удалить отдел "${o.name}"? Участники будут отвязаны, но не удалены.`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await V.deleteDepartment(g.params.id,o.id),u.success("Отдел удалён"),await D()}catch{u.error("Ошибка удаления отдела")}}).catch(()=>{})},ce=async o=>{if(z.value[o]){z.value[o]=!1;return}z.value[o]=!0,await G(o)},G=async o=>{H.value[o]=!0;try{const e=await V.listDepartmentParticipants(g.params.id,o);q.value[o]=e}catch{u.error("Ошибка загрузки участников отдела")}finally{H.value[o]=!1}},fe=o=>{E.value=o,b.value=[],A.value=[],U.value=!0},ve=async o=>{if(!o||o.length<2){A.value=[];return}j.value=!0;try{const e=await Fe.search({query:o,size:20});A.value=e.items||[]}catch{A.value=[]}finally{j.value=!1}},_e=async()=>{if(!(!b.value.length||!E.value)){m.value=!0;try{await V.attachParticipants(g.params.id,E.value.id,b.value),u.success("Участники привязаны"),U.value=!1,await D(),z.value[E.value.id]&&await G(E.value.id)}catch(o){u.error(o.response?.data?.detail||"Ошибка привязки участников")}finally{m.value=!1}}},ye=(o,e)=>{ie.confirm(`Отвязать "${e.full_name}" от отдела "${o.name}"?`,"Подтверждение",{confirmButtonText:"Отвязать",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await V.detachParticipant(g.params.id,o.id,e.id),u.success("Участник отвязан"),await D(),await G(o.id)}catch{u.error("Ошибка отвязки участника")}}).catch(()=>{})};return Ce(async()=>{await D(),p.value&&(w.name=p.value.name,w.description=p.value.description||"")}),(o,e)=>{const i=r("el-button"),O=r("el-descriptions-item"),ge=r("el-descriptions"),Q=r("el-card"),I=r("el-icon"),ee=r("el-empty"),we=r("el-tag"),ke=r("el-divider"),W=r("el-table-column"),Ve=r("el-table"),$=r("el-input"),C=r("el-form-item"),T=r("el-form"),M=r("el-dialog"),be=r("el-option"),De=r("el-select"),ae=$e("loading");return d(),_(he,null,{default:a(()=>[te((d(),x("div",Ue,[p.value?(d(),_(Q,{key:0,class:"detail-card"},{header:a(()=>[f("div",Ee,[f("h2",null,c(p.value.name),1),f("div",Ae,[l(i,{onClick:e[0]||(e[0]=t=>y(Y).push("/organizations"))},{default:a(()=>[...e[18]||(e[18]=[n(" Назад ",-1)])]),_:1}),l(i,{type:"primary",onClick:e[1]||(e[1]=t=>P.value=!0)},{default:a(()=>[...e[19]||(e[19]=[n(" Редактировать ",-1)])]),_:1})])])]),default:a(()=>[l(ge,{column:y(F)?1:2,border:""},{default:a(()=>[l(O,{label:"Название"},{default:a(()=>[n(c(p.value.name),1)]),_:1}),l(O,{label:"Описание"},{default:a(()=>[n(c(p.value.description||"Не указано"),1)]),_:1}),l(O,{label:"Дата создания"},{default:a(()=>[n(c(y(Pe)(p.value.created_at)),1)]),_:1}),l(O,{label:"Кол-во отделов"},{default:a(()=>[n(c(p.value.departments?.length||0),1)]),_:1})]),_:1},8,["column"])]),_:1})):h("",!0),p.value?(d(),_(Q,{key:1,class:"section-card"},{header:a(()=>[f("div",Ne,[e[21]||(e[21]=f("h3",null,"Отделы",-1)),l(i,{type:"primary",onClick:e[2]||(e[2]=t=>B.value=!0)},{default:a(()=>[l(I,null,{default:a(()=>[l(y(ne))]),_:1}),e[20]||(e[20]=n(" Добавить отдел ",-1))]),_:1})])]),default:a(()=>[p.value.departments?.length?(d(),x("div",Oe,[(d(!0),x(le,null,oe(p.value.departments,t=>(d(),_(Q,{key:t.id,class:"dept-card",shadow:"hover"},{header:a(()=>[f("div",Te,[f("div",Me,[f("span",Le,c(t.name),1),l(we,{size:"small"},{default:a(()=>[n(c(t.participants_count)+" уч. ",1)]),_:2},1024)]),f("div",qe,[l(i,{size:"small",onClick:N=>ce(t.id)},{default:a(()=>[n(c(z.value[t.id]?"Свернуть":"Участники"),1)]),_:2},1032,["onClick"]),l(i,{size:"small",type:"primary",plain:"",onClick:N=>fe(t)},{default:a(()=>[l(I,null,{default:a(()=>[l(y(ne))]),_:1}),e[22]||(e[22]=n(" Добавить ",-1))]),_:1},8,["onClick"]),l(i,{size:"small",onClick:N=>ue(t)},{default:a(()=>[...e[23]||(e[23]=[n(" Изменить ",-1)])]),_:1},8,["onClick"]),l(i,{size:"small",type:"danger",plain:"",onClick:N=>me(t)},{default:a(()=>[...e[24]||(e[24]=[n(" Удалить ",-1)])]),_:1},8,["onClick"])])])]),default:a(()=>[t.description?(d(),x("div",He,c(t.description),1)):h("",!0),z.value[t.id]?te((d(),x("div",Je,[t.description?(d(),_(ke,{key:0})):h("",!0),e[26]||(e[26]=f("div",{class:"dept-participants-header"},[f("span",null,"Участники отдела")],-1)),q.value[t.id]?.length?(d(),_(Ve,{key:2,data:q.value[t.id],size:"small",stripe:""},{default:a(()=>[l(W,{prop:"full_name",label:"ФИО"}),l(W,{prop:"external_id",label:"Внешний ID",width:"150"}),l(W,{label:"",width:"120",align:"center"},{default:a(({row:N})=>[l(i,{type:"warning",size:"small",plain:"",onClick:Ge=>ye(t,N)},{default:a(()=>[...e[25]||(e[25]=[n(" Отвязать ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])):(d(),_(ee,{key:1,description:"Нет участников","image-size":60}))])),[[ae,H.value[t.id]]]):h("",!0)]),_:2},1024))),128))])):(d(),_(ee,{key:0,description:"Нет отделов","image-size":80}))]),_:1})):h("",!0),l(M,{modelValue:P.value,"onUpdate:modelValue":e[6]||(e[6]=t=>P.value=t),title:"Редактировать организацию",width:y(F)?"95%":"500px"},{footer:a(()=>[l(i,{onClick:e[5]||(e[5]=t=>P.value=!1)},{default:a(()=>[...e[27]||(e[27]=[n(" Отмена ",-1)])]),_:1}),l(i,{type:"primary",loading:m.value,onClick:re},{default:a(()=>[...e[28]||(e[28]=[n(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(T,{ref_key:"editFormRef",ref:J,model:w,rules:se,"label-position":"top"},{default:a(()=>[l(C,{label:"Название",prop:"name"},{default:a(()=>[l($,{modelValue:w.name,"onUpdate:modelValue":e[3]||(e[3]=t=>w.name=t)},null,8,["modelValue"])]),_:1}),l(C,{label:"Описание",prop:"description"},{default:a(()=>[l($,{modelValue:w.description,"onUpdate:modelValue":e[4]||(e[4]=t=>w.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(M,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=t=>B.value=t),title:"Добавить отдел",width:y(F)?"95%":"500px"},{footer:a(()=>[l(i,{onClick:e[9]||(e[9]=t=>B.value=!1)},{default:a(()=>[...e[29]||(e[29]=[n(" Отмена ",-1)])]),_:1}),l(i,{type:"primary",loading:m.value,onClick:de},{default:a(()=>[...e[30]||(e[30]=[n(" Создать ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(T,{ref_key:"deptFormRef",ref:K,model:k,rules:Z,"label-position":"top"},{default:a(()=>[l(C,{label:"Название",prop:"name"},{default:a(()=>[l($,{modelValue:k.name,"onUpdate:modelValue":e[7]||(e[7]=t=>k.name=t),placeholder:"Введите название отдела"},null,8,["modelValue"])]),_:1}),l(C,{label:"Описание",prop:"description"},{default:a(()=>[l($,{modelValue:k.description,"onUpdate:modelValue":e[8]||(e[8]=t=>k.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(M,{modelValue:R.value,"onUpdate:modelValue":e[14]||(e[14]=t=>R.value=t),title:"Редактировать отдел",width:y(F)?"95%":"500px"},{footer:a(()=>[l(i,{onClick:e[13]||(e[13]=t=>R.value=!1)},{default:a(()=>[...e[31]||(e[31]=[n(" Отмена ",-1)])]),_:1}),l(i,{type:"primary",loading:m.value,onClick:pe},{default:a(()=>[...e[32]||(e[32]=[n(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(T,{ref_key:"editDeptFormRef",ref:S,model:v,rules:Z,"label-position":"top"},{default:a(()=>[l(C,{label:"Название",prop:"name"},{default:a(()=>[l($,{modelValue:v.name,"onUpdate:modelValue":e[11]||(e[11]=t=>v.name=t)},null,8,["modelValue"])]),_:1}),l(C,{label:"Описание",prop:"description"},{default:a(()=>[l($,{modelValue:v.description,"onUpdate:modelValue":e[12]||(e[12]=t=>v.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(M,{modelValue:U.value,"onUpdate:modelValue":e[17]||(e[17]=t=>U.value=t),title:"Добавить участника в отдел",width:y(F)?"95%":"500px"},{footer:a(()=>[l(i,{onClick:e[16]||(e[16]=t=>U.value=!1)},{default:a(()=>[...e[33]||(e[33]=[n(" Отмена ",-1)])]),_:1}),l(i,{type:"primary",loading:m.value,disabled:!b.value.length,onClick:_e},{default:a(()=>[n(" Привязать ("+c(b.value.length)+") ",1)]),_:1},8,["loading","disabled"])]),default:a(()=>[l(T,{"label-position":"top"},{default:a(()=>[l(C,{label:"Поиск участника"},{default:a(()=>[l(De,{modelValue:b.value,"onUpdate:modelValue":e[15]||(e[15]=t=>b.value=t),multiple:"",filterable:"",remote:"","reserve-keyword":"",placeholder:"Введите имя для поиска","remote-method":ve,loading:j.value,style:{width:"100%"}},{default:a(()=>[(d(!0),x(le,null,oe(A.value,t=>(d(),_(be,{key:t.id,label:t.full_name,value:t.id},{default:a(()=>[f("span",null,c(t.full_name),1),t.external_id?(d(),x("span",Ke,c(t.external_id),1)):h("",!0)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue","width"])])),[[ae,L.value]])]),_:1})}}},aa=Re(Se,[["__scopeId","data-v-09a96d6a"]]);export{aa as default};
