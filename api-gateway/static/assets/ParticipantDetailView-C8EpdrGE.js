import{N as J,m as g,O as K,p as Z,r as m,c as D,o as l,d as t,x as A,P as pt,w as e,u as R,Q as mt,K as ft,z as _t,B as b,F as W,H as he,v as y,f as _,C as Q,a as p,E as I,q as Ue,e as Oe,R as Pe,I as ke,J as pe,S as vt,T as Me,k as xe,U as Ae,g as Ve,V as yt,W as Ne,X as Ie,h as Te,Y as be,Z as Le,M as gt,_ as wt,$ as bt,n as Fe,a0 as ht,t as kt,a1 as Ct,G as Rt}from"./index-BAxuc_kQ.js";import{A as Dt}from"./AppLayout-DgK7SO6Z.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as $t,m as ce,g as Et,p as St}from"./metricNames-CxSwrDBo.js";import{p as ze,u as Mt}from"./participants-B6fzNVbn.js";const _e={async upload(i,C){const r=new FormData;return r.append("file",C),(await J.post(`/participants/${i}/reports`,r,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(i){return await J.get(`/reports/${i}/download`,{responseType:"blob"})},async getById(i){return(await J.get(`/reports/${i}`)).data},async delete(i){return(await J.delete(`/reports/${i}`)).data},async extract(i){return(await J.post(`/reports/${i}/extract`)).data},async getMetrics(i){return(await J.get(`/reports/${i}/metrics`)).data},async getList(i){return(await J.get(`/participants/${i}/reports`)).data}},we={async calculate(i,C){return(await J.post(`/scoring/participants/${i}/calculate`,null,{params:{activity_code:C}})).data},async getHistory(i,C=10){return(await J.get(`/scoring/participants/${i}/scores`,{params:{limit:C}})).data},async getById(i){return(await J.get(`/scoring-results/${i}`)).data},async generateRecommendations(i){return(await J.post(`/reports/${i}/recommendations`)).data},async getFinalReport(i,C,r="json"){const $={params:{activity_code:C,format:r}};r==="html"&&($.responseType="text");const T=await J.get(`/participants/${i}/final-report`,$);return T.data},async downloadFinalReportPdf(i,C){return await J.get(`/participants/${i}/final-report`,{params:{activity_code:C,format:"pdf"},responseType:"blob"})}};function ve(i,C=1){if(i==null||i==="")return"";const r=typeof i=="string"?parseFloat(i):i;return isNaN(r)?"":r.toLocaleString("ru-RU",{minimumFractionDigits:C,maximumFractionDigits:C})}function se(i){if(i==null||i==="")return null;const r=String(i).trim().replace(",","."),$=parseFloat(r);return isNaN($)?null:$}function xt(i){return se(i)}function de(i,C=1){return ve(i,C)}const At={key:0,class:"error-message"},Vt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(i,{emit:C}){const r=i,$=C,T=g(null),M=g(""),F=g(!1),E=g(!1),S=g(""),w=K(()=>se(M.value)),V=K(()=>{const o=w.value;return o===null||o<=r.min}),q=K(()=>{const o=w.value;return o===null||o>=r.max}),X=o=>{if(o==null||o===""){M.value="";return}F.value?M.value=String(o).replace(".",","):M.value=ve(o,r.precision)},j=o=>{if(o==null||o==="")return E.value=!1,S.value="",!0;const s=se(o);return s===null?(E.value=!0,S.value="Некорректное число",!1):s<r.min?(E.value=!0,S.value=`Значение должно быть не меньше ${ve(r.min,r.precision)}`,!1):s>r.max?(E.value=!0,S.value=`Значение должно быть не больше ${ve(r.max,r.precision)}`,!1):(E.value=!1,S.value="",!0)},h=o=>{const s=o.replace(/[^\d,.-]/g,"");let k=!1;const c=s.split("").filter(v=>v===","||v==="."?k?!1:(k=!0,!0):!0).join("").replace(".",",");M.value=c;const u=se(c);u!==null?$("update:modelValue",u):(c===""||c==="-")&&$("update:modelValue",null)},x=()=>{F.value=!1;const o=se(M.value);if(j(M.value)){if(o!==null){const s=Math.round(o*Math.pow(10,r.precision))/Math.pow(10,r.precision),k=Math.max(r.min,Math.min(r.max,s));$("update:modelValue",k),X(k),$("change",k)}}else if(o!==null&&(o<r.min||o>r.max)){const s=Math.max(r.min,Math.min(r.max,o));$("update:modelValue",s),X(s),$("change",s),E.value=!1,S.value=""}$("blur")},G=()=>{F.value=!0,w.value!==null&&(M.value=String(w.value).replace(".",","))},H=()=>{const o=w.value||0,s=Math.min(r.max,o+r.step),k=Math.round(s*Math.pow(10,r.precision))/Math.pow(10,r.precision);$("update:modelValue",k),$("change",k),X(k)},U=()=>{const o=w.value||0,s=Math.max(r.min,o-r.step),k=Math.round(s*Math.pow(10,r.precision))/Math.pow(10,r.precision);$("update:modelValue",k),$("change",k),X(k)};return Z(()=>r.modelValue,o=>{X(o)},{immediate:!0}),X(r.modelValue),(o,s)=>{const k=m("el-button"),c=m("el-button-group"),u=m("el-input");return l(),D(W,null,[t(u,{ref_key:"inputRef",ref:T,modelValue:M.value,"onUpdate:modelValue":s[0]||(s[0]=v=>M.value=v),placeholder:i.placeholder,disabled:i.disabled,class:_t({"is-invalid":E.value}),onInput:h,onBlur:x,onFocus:G},pt({_:2},[i.showControls?{name:"append",fn:e(()=>[t(c,null,{default:e(()=>[t(k,{icon:R(mt),disabled:i.disabled||V.value,onClick:U},null,8,["icon","disabled"]),t(k,{icon:R(ft),disabled:i.disabled||q.value,onClick:H},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),E.value?(l(),D("div",At,b(S.value),1)):A("",!0)],64)}}},Nt=me(Vt,[["__scopeId","data-v-74ef628d"]]),It={class:"card-header"},Tt={key:1},Lt={key:0,class:"metric-description"},Ft={key:2,class:"metrics-info"},Ut={class:"info-row"},Ot={key:0,class:"info-row"},Pt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(i,{emit:C}){const r=i,$=C,T=g(!1),M=g(!1),F=g(!1),E=g(null),S=g([]),w=g([]),V=g({metrics:{}}),q=g({}),X=K(()=>!w.value||w.value.length===0?[]:[...new Set(w.value.map(c=>c.source))]),j=K(()=>!w.value||w.value.length===0?null:new Date),h=async()=>{try{const c=await ce.listMetricDefs(!0);S.value=c.items||[]}catch(c){console.error("Failed to load metric definitions:",c),E.value="Не удалось загрузить определения метрик"}},x=async()=>{T.value=!0,E.value=null;try{const c=await ce.listExtractedMetrics(r.reportId);w.value=c.items||[],V.value.metrics={},w.value.forEach(u=>{V.value.metrics[u.metric_def_id]=se(u.value)}),q.value=JSON.parse(JSON.stringify(V.value.metrics))}catch(c){console.error("Failed to load metrics:",c),E.value="Не удалось загрузить метрики"}finally{T.value=!1}},G=()=>{F.value=!0,q.value=JSON.parse(JSON.stringify(V.value.metrics))},H=()=>{V.value.metrics=JSON.parse(JSON.stringify(q.value)),F.value=!1,E.value=null},U=async()=>{M.value=!0,E.value=null;try{const c=[];for(const[u,v]of Object.entries(V.value.metrics))if(v!=null&&v!==""){const z=xt(v);z!==null&&c.push({metric_def_id:u,value:z,source:"MANUAL",notes:null})}if(c.length===0){I.warning("Не введено ни одного значения метрики"),M.value=!1;return}await ce.bulkCreateExtractedMetrics(r.reportId,c),I.success(`Успешно сохранено ${c.length} метрик`),F.value=!1,await x(),$("metrics-updated")}catch(c){console.error("Failed to save metrics:",c);let u="Не удалось сохранить метрики";c.response?.data?.detail&&(typeof c.response.data.detail=="string"?u=c.response.data.detail:Array.isArray(c.response.data.detail)&&(u=c.response.data.detail.map(v=>v.msg||v.message).join(", "))),E.value=u,I.error(u)}finally{M.value=!1}},o=c=>{switch(c){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},s=c=>{switch(c){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return c}},k=c=>new Date(c).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return he(async()=>{await h(),await x()}),Z(()=>r.reportId,async c=>{c&&await x()}),(c,u)=>{const v=m("el-button"),z=m("el-alert"),ee=m("el-form-item"),B=m("el-col"),te=m("el-row"),le=m("el-form"),oe=m("el-divider"),re=m("el-tag"),ae=m("el-card");return l(),y(ae,{class:"metrics-editor"},{header:e(()=>[p("div",It,[u[4]||(u[4]=p("span",null,"Ручной ввод метрик",-1)),F.value?(l(),D("div",Tt,[t(v,{size:"small",onClick:H},{default:e(()=>[...u[2]||(u[2]=[_(" Отмена ",-1)])]),_:1}),t(v,{type:"primary",size:"small",loading:M.value,onClick:U},{default:e(()=>[...u[3]||(u[3]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])])):(l(),y(v,{key:0,type:"primary",size:"small",onClick:G},{default:e(()=>[...u[1]||(u[1]=[_(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[E.value?(l(),y(z,{key:0,type:"error",title:E.value,closable:"",style:{"margin-bottom":"16px"},onClose:u[0]||(u[0]=N=>E.value=null)},null,8,["title"])):A("",!0),!w.value||w.value.length===0?(l(),y(z,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...u[5]||(u[5]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):A("",!0),t(le,{ref:"formRef",model:V.value,"label-position":"top",disabled:!F.value},{default:e(()=>[t(te,{gutter:20},{default:e(()=>[(l(!0),D(W,null,Q(S.value,N=>(l(),y(B,{key:N.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ee,{label:R($t)(N),prop:`metrics.${N.id}`},{default:e(()=>[t(Nt,{modelValue:V.value.metrics[N.id],"onUpdate:modelValue":d=>V.value.metrics[N.id]=d,min:N.min_value||1,max:N.max_value||10,precision:1,step:.1,disabled:!F.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),N.description?(l(),D("div",Lt,b(N.description),1)):A("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),w.value&&w.value.length>0?(l(),D("div",Ft,[t(oe),p("div",Ut,[u[6]||(u[6]=p("span",{class:"info-label"},"Источник данных:",-1)),(l(!0),D(W,null,Q(X.value,N=>(l(),y(re,{key:N,type:o(N),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(b(s(N)),1)]),_:2},1032,["type"]))),128))]),j.value?(l(),D("div",Ot,[u[7]||(u[7]=p("span",{class:"info-label"},"Последнее обновление:",-1)),p("span",null,b(k(j.value)),1)])):A("",!0)])):A("",!0)]),_:1})}}},zt=me(Pt,[["__scopeId","data-v-1e3d866a"]]),Bt={class:"report-list"},qt={class:"report-list__controls"},Xt={class:"controls-left"},Gt={class:"controls-right"},jt={class:"filename"},Jt={class:"status-cell"},Ht={key:1,class:"report-list__cards"},Wt={class:"report-card__header"},Kt={class:"report-card__status"},Qt={class:"report-card__body"},Yt={class:"report-card__field"},Zt={class:"field-value"},ea={class:"report-card__field"},ta={class:"field-value"},aa={class:"report-card__actions"},na={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(i,{emit:C}){const r=i,$=C,T=Ue(),M=Oe(),F=g(window.innerWidth<=768),E=()=>{F.value=window.innerWidth<=768};he(()=>{window.addEventListener("resize",E),T.query.status&&(S.value=T.query.status),T.query.sort&&(w.value=T.query.sort)}),Pe(()=>{window.removeEventListener("resize",E)});const S=g(""),w=g("desc"),V=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];Z([S,w],([o,s])=>{const k={...T.query};o?k.status=o:delete k.status,s?k.sort=s:delete k.sort,M.replace({query:k})});const q=()=>{},X=()=>{w.value=w.value==="desc"?"asc":"desc"},j=K(()=>{let o=[...r.reports];return S.value&&(o=o.filter(s=>s.status===S.value)),o.sort((s,k)=>{const c=new Date(s.uploaded_at),u=new Date(k.uploaded_at);return w.value==="desc"?u-c:c-u}),o}),h=K(()=>S.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),x=o=>{if(!o)return"—";const s=new Date(o);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},G=o=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[o]||o,H=o=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[o]||"info",U=async({action:o,report:s})=>{switch(o){case"view":$("view",s.id);break;case"edit":$("edit",s.id);break;case"extract":$("extract",s.id);break;case"download":$("download",s.id);break;case"delete":try{await gt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),$("delete",s.id)}catch{}break}};return(o,s)=>{const k=m("el-option"),c=m("el-select"),u=m("el-icon"),v=m("el-button"),z=m("el-table-column"),ee=m("el-tag"),B=m("el-dropdown-item"),te=m("el-dropdown-menu"),le=m("el-dropdown"),oe=m("el-table"),re=m("el-card"),ae=m("el-empty"),N=ke("loading");return l(),D("div",Bt,[p("div",qt,[p("div",Xt,[t(c,{modelValue:S.value,"onUpdate:modelValue":s[0]||(s[0]=d=>S.value=d),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:q},{default:e(()=>[t(k,{label:"Все статусы",value:""}),(l(),D(W,null,Q(V,d=>t(k,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),p("div",Gt,[t(v,{type:w.value==="desc"?"primary":"default",size:"small",onClick:X},{default:e(()=>[t(u,null,{default:e(()=>[t(R(vt))]),_:1}),_(" "+b(w.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),F.value?pe((l(),D("div",Ht,[(l(!0),D(W,null,Q(j.value,d=>(l(),y(re,{key:d.id,class:"report-card",shadow:"hover"},{header:e(()=>[p("div",Wt,[p("div",Kt,[d.status==="PROCESSING"?(l(),y(u,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(R(Me))]),_:1})):d.status==="EXTRACTED"?(l(),y(u,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(R(xe))]),_:1})):d.status==="FAILED"?(l(),y(u,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(R(Ae))]),_:1})):(l(),y(u,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(R(Ve))]),_:1})),t(ee,{type:H(d.status),size:"small"},{default:e(()=>[_(b(G(d.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[p("div",aa,[d.status==="EXTRACTED"?(l(),y(v,{key:0,type:"success",size:"small",onClick:Y=>U({action:"edit",report:d})},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Ne))]),_:1}),s[10]||(s[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):A("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(l(),y(v,{key:1,type:"info",size:"small",onClick:Y=>U({action:"view",report:d})},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Ie))]),_:1}),s[11]||(s[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):A("",!0),t(v,{type:"primary",size:"small",onClick:Y=>U({action:"extract",report:d})},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Te))]),_:1}),_(" "+b(d.status==="FAILED"?"Повторить":d.status==="PROCESSING"?"Перезапустить":d.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(v,{size:"small",onClick:Y=>U({action:"download",report:d})},{default:e(()=>[t(u,null,{default:e(()=>[t(R(be))]),_:1}),s[12]||(s[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(v,{type:"danger",size:"small",onClick:Y=>U({action:"delete",report:d})},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Le))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[p("div",Qt,[p("div",Yt,[s[8]||(s[8]=p("span",{class:"field-label"},"Файл:",-1)),p("span",Zt,b(d.file_ref?.filename||"Без названия"),1)]),p("div",ea,[s[9]||(s[9]=p("span",{class:"field-label"},"Дата загрузки:",-1)),p("span",ta,b(x(d.uploaded_at)),1)])])]),_:2},1024))),128)),!j.value.length&&!i.loading?(l(),y(ae,{key:0,description:h.value,"image-size":120},{default:e(()=>[S.value?A("",!0):(l(),y(v,{key:0,type:"primary",onClick:s[1]||(s[1]=d=>o.$emit("upload"))},{default:e(()=>[...s[13]||(s[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])),[[N,i.loading]]):pe((l(),y(oe,{key:0,data:j.value,class:"report-list__table",stripe:"","empty-text":h.value},{default:e(()=>[t(z,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:d})=>[p("span",jt,b(d.file_ref?.filename||"Без названия"),1)]),_:1}),t(z,{prop:"status",label:"Статус",width:"200"},{default:e(({row:d})=>[p("div",Jt,[d.status==="PROCESSING"?(l(),y(u,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(R(Me))]),_:1})):d.status==="EXTRACTED"?(l(),y(u,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(R(xe))]),_:1})):d.status==="FAILED"?(l(),y(u,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(R(Ae))]),_:1})):(l(),y(u,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(R(Ve))]),_:1})),t(ee,{type:H(d.status),size:"default"},{default:e(()=>[_(b(G(d.status)),1)]),_:2},1032,["type"])])]),_:1}),t(z,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:d})=>[_(b(x(d.uploaded_at)),1)]),_:1}),t(z,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:d})=>[t(le,{trigger:"click",onCommand:U},{dropdown:e(()=>[t(te,null,{default:e(()=>[d.status==="EXTRACTED"?(l(),y(B,{key:0,command:{action:"edit",report:d}},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Ne))]),_:1}),s[4]||(s[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):A("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(l(),y(B,{key:1,command:{action:"view",report:d}},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Ie))]),_:1}),s[5]||(s[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):A("",!0),t(B,{command:{action:"extract",report:d}},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Te))]),_:1}),_(" "+b(d.status==="FAILED"?"Повторить извлечение":d.status==="PROCESSING"?"Перезапустить извлечение":d.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(B,{divided:"",command:{action:"download",report:d}},{default:e(()=>[t(u,null,{default:e(()=>[t(R(be))]),_:1}),s[6]||(s[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(B,{command:{action:"delete",report:d},class:"dropdown-item--danger"},{default:e(()=>[t(u,null,{default:e(()=>[t(R(Le))]),_:1}),s[7]||(s[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(v,{type:"primary",size:"small"},{default:e(()=>[s[3]||(s[3]=_(" Действия ",-1)),t(u,{class:"el-icon--right"},{default:e(()=>[t(R(yt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[N,i.loading]]),!j.value.length&&!i.loading&&!F.value?(l(),y(ae,{key:2,description:h.value,"image-size":120},{default:e(()=>[S.value?A("",!0):(l(),y(v,{key:0,type:"primary",onClick:s[2]||(s[2]=d=>o.$emit("upload"))},{default:e(()=>[...s[14]||(s[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])}}},sa=me(na,[["__scopeId","data-v-c9651b50"]]),la={class:"metrics-drawer"},oa={class:"drawer-actions"},ra={key:1},ia={key:1},ua={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:C}){const r=i,$=C,T=g(!1),M=g([]),F=g([]),E=K(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),S=h=>{$("update:modelValue",h)},w=async()=>{try{const h=await ce.listMetricDefs(!0);F.value=h.items||[]}catch(h){console.error("Error loading metric definitions:",h)}},V=async()=>{T.value=!0;try{const h=await ze.getMetrics(r.participantId);M.value=h.metrics||[]}catch(h){console.error("Error loading participant metrics:",h),I.error("Ошибка загрузки метрик участника")}finally{T.value=!1}},q=h=>{if(!h)return"—";const x=F.value.find(H=>H.code===h);return Et(x,h,{warn:()=>{}})},X=h=>h>=.8?"var(--el-color-success)":h>=.6?"var(--el-color-warning)":"var(--el-color-danger)",j=h=>{if(!h)return"—";const x=new Date(h);return Number.isNaN(x.getTime())?"—":x.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return Z(()=>r.participantId,async h=>{h&&r.modelValue&&(await w(),await V())}),Z(()=>r.modelValue,async h=>{h&&r.participantId&&(await w(),await V())}),(h,x)=>{const G=m("el-icon"),H=m("el-button"),U=m("el-table-column"),o=m("el-tag"),s=m("el-table"),k=m("el-empty"),c=m("el-drawer"),u=ke("loading");return l(),y(c,{"model-value":i.modelValue,title:`Метрики участника: ${i.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":S},{default:e(()=>[pe((l(),D("div",la,[p("div",oa,[t(H,{type:"primary",size:"small",onClick:V},{default:e(()=>[t(G,null,{default:e(()=>[t(R(wt))]),_:1}),x[0]||(x[0]=_(" Обновить ",-1))]),_:1})]),t(s,{data:M.value,stripe:"","empty-text":E.value},{default:e(()=>[t(U,{prop:"metric_code",label:"Код метрики",width:"200"}),t(U,{label:"Название метрики","min-width":"250"},{default:e(({row:v})=>[_(b(q(v.metric_code)),1)]),_:1}),t(U,{prop:"value",label:"Значение",width:"120"},{default:e(({row:v})=>[t(o,{type:"success"},{default:e(()=>[_(b(R(de)(v.value)),1)]),_:2},1024)]),_:1}),t(U,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:v})=>[v.confidence!==null?(l(),D("span",{key:0,style:bt({color:X(v.confidence)})},b((v.confidence*100).toFixed(0))+"% ",5)):(l(),D("span",ra,"—"))]),_:1}),t(U,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:v})=>[_(b(j(v.updated_at)),1)]),_:1}),t(U,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:v})=>[v.last_source_report_id?(l(),y(o,{key:0,size:"small"},{default:e(()=>[...x[1]||(x[1]=[_(" Из отчёта ",-1)])]),_:1})):(l(),D("span",ia,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!M.value.length&&!T.value?(l(),y(k,{key:0,description:E.value},null,8,["description"])):A("",!0)])),[[u,T.value]])]),_:1},8,["model-value","title"])}}},da=me(ua,[["__scopeId","data-v-93720633"]]),ca={class:"participant-detail"},pa={class:"card-header"},ma={class:"header-actions"},fa={class:"section-header"},_a={class:"scoring-result"},va={class:"score-value"},ya={class:"score-number"},ga={class:"score-details"},wa={class:"score-section"},ba={key:0},ha={class:"score-section"},ka={key:0},Ca={class:"score-section"},Ra={key:0},Da={key:0,class:"recommendation-skill-focus"},$a={key:1,class:"recommendation-advice"},Ea={key:2,class:"recommendation-formats"},Sa={class:"formats-list"},Ma={key:0,class:"final-report-actions"},xa={class:"activity-code-hint"},Aa={__name:"ParticipantDetailView",setup(i){const C=Oe(),r=Ue(),$=Mt(),T=g(!1),M=g(!1),F=g(!1);g(!1);const E=g(!1),S=g(!1),w=K(()=>$.currentParticipant),V=g([]),q=g([]),X=g([]),j=g([]);g([]);const h=g(null),x=g(null),G=g(null),H=K(()=>V.value.some(a=>a.status==="PROCESSING")),U=K(()=>q.value.some(a=>a.recommendations_status==="pending")),o=g(!1),s=g(!1),k=g(!1),c=g(!1),u=g(null),v=g([]),z=Fe({file:null}),ee={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},B=Fe({activityCode:""}),te=a=>{if(!a)return"—";const n=new Date(a);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},le=a=>a>=80?"success":a>=60?"":"warning",oe=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,re=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",ae=async()=>{T.value=!0;try{await $.getParticipant(r.params.id)}catch{I.error("Участник не найден"),C.push("/participants")}finally{T.value=!1}},N=async({silent:a=!1}={})=>{a||(M.value=!0);try{const n=await ze.getReports(r.params.id);V.value=n.items||[]}catch(n){console.error("Error loading reports:",n),I.error("Ошибка загрузки списка отчётов")}finally{a||(M.value=!1)}},d=a=>{if(!a)return a;const n=Array.isArray(a.recommendations)?a.recommendations:[];let L=a.recommendations_status||a.recommendationsStatus||null;L||(L=n.length>0?"ready":"pending");const O=Number(a.score_pct),ne=Number.isNaN(O)?a.score_pct:O;return{...a,score_pct:ne,recommendations:n,recommendations_status:L,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Y=async()=>{try{const a=await we.getHistory(r.params.id),n=Array.isArray(a.items)?a.items:[];q.value=n.map(d)}catch(a){console.error("Error loading scoring results:",a)}},Be=async()=>{F.value=!0;try{const a=await St.list();X.value=a||[]}catch{I.error("Ошибка загрузки профессиональных областей")}finally{F.value=!1}},qe=async()=>{try{const a=await ce.listMetricDefs(!0);j.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},Xe=a=>{z.file=a.raw,v.value=[a]},Ge=async()=>{u.value&&await u.value.validate(async a=>{if(a){if(!z.file){I.error("Выберите файл");return}E.value=!0;try{await _e.upload(r.params.id,z.file),I.success("Отчёт загружен успешно"),o.value=!1,z.file=null,v.value=[],await N()}catch{I.error("Ошибка загрузки отчёта")}finally{E.value=!1}}})},je=async a=>{try{const n=await _e.download(a),L=window.URL.createObjectURL(new Blob([n.data])),O=document.createElement("a");O.href=L,O.setAttribute("download",`report_${a}.docx`),document.body.appendChild(O),O.click(),O.remove(),window.URL.revokeObjectURL(L),I.success("Отчёт скачан")}catch{I.error("Ошибка скачивания отчёта")}},Je=async a=>{try{await _e.extract(a),I.success("Извлечение метрик запущено"),await N()}catch{I.error("Ошибка запуска извлечения метрик")}},He=()=>{x.value||(x.value=setInterval(async()=>{try{await N({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Ce=()=>{x.value&&(clearInterval(x.value),x.value=null)},We=()=>{G.value||(G.value=setInterval(async()=>{try{await Y()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Re=()=>{G.value&&(clearInterval(G.value),G.value=null)};Z(H,a=>{a?He():Ce()}),Z(U,a=>{a?We():Re()});const De=async a=>{h.value=a,await Rt(),k.value=!0},Ke=async()=>{I.success("Метрики обновлены")},Qe=async a=>{try{await _e.delete(a),I.success("Отчёт удалён"),await N()}catch{I.error("Ошибка удаления отчёта")}},Ye=async()=>{if(!B.activityCode){I.warning("Выберите профессиональную область");return}S.value=!0;try{const a=await we.calculate(r.params.id,B.activityCode),n=d({id:a.scoring_result_id,participant_id:r.params.id,prof_activity_code:a.prof_activity_code||B.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});q.value.unshift(n),I.success("Расчёт пригодности выполнен"),s.value=!1,B.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const n=a.response?.data?.detail||"Ошибка расчёта пригодности";I.error(n)}finally{S.value=!1}},Ze=async a=>{if(!a.prof_activity_code){I.warning("Код профессиональной деятельности не найден");return}try{const n=await we.downloadFinalReportPdf(r.params.id,a.prof_activity_code),L=window.URL.createObjectURL(new Blob([n.data])),O=document.createElement("a");O.href=L,O.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(O),O.click(),O.remove(),window.URL.revokeObjectURL(L),I.success("Отчёт PDF скачан")}catch(n){const L=n.response?.data?.detail||"Ошибка загрузки PDF отчёта";I.error(L)}},et=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,tt=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return he(async()=>{await ae(),await N(),await Y(),await Be(),await qe()}),Pe(()=>{Ce(),Re()}),(a,n)=>{const L=m("el-button"),O=m("el-icon"),ne=m("el-descriptions-item"),at=m("el-descriptions"),fe=m("el-card"),nt=m("el-progress"),ye=m("el-empty"),st=m("el-tag"),ie=m("el-alert"),lt=m("el-timeline-item"),ot=m("el-timeline"),rt=m("el-upload"),$e=m("el-form-item"),Ee=m("el-form"),ge=m("el-dialog"),it=m("el-option"),ut=m("el-select"),Se=ke("loading");return l(),y(Dt,null,{default:e(()=>[pe((l(),D("div",ca,[w.value?(l(),y(fe,{key:0,class:"detail-card"},{header:e(()=>[p("div",pa,[p("h2",null,b(w.value.full_name),1),p("div",ma,[t(L,{onClick:n[0]||(n[0]=f=>R(C).back())},{default:e(()=>[...n[12]||(n[12]=[_(" Назад ",-1)])]),_:1}),t(L,{type:"info",onClick:n[1]||(n[1]=f=>c.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(R(ht))]),_:1}),n[13]||(n[13]=_(" Метрики ",-1))]),_:1}),t(L,{type:"primary",onClick:n[2]||(n[2]=f=>s.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(R(kt))]),_:1}),n[14]||(n[14]=_(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(at,{column:2,border:""},{default:e(()=>[t(ne,{label:"ФИО"},{default:e(()=>[_(b(w.value.full_name),1)]),_:1}),t(ne,{label:"Дата рождения"},{default:e(()=>[_(b(w.value.birth_date||"Не указана"),1)]),_:1}),t(ne,{label:"Внешний ID"},{default:e(()=>[_(b(w.value.external_id||"Не указан"),1)]),_:1}),t(ne,{label:"Дата создания"},{default:e(()=>[_(b(te(w.value.created_at)),1)]),_:1})]),_:1})]),_:1})):A("",!0),t(fe,{class:"section-card"},{header:e(()=>[p("div",fa,[n[16]||(n[16]=p("h3",null,"Отчёты",-1)),t(L,{type:"primary",onClick:n[3]||(n[3]=f=>o.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(R(Ct))]),_:1}),n[15]||(n[15]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(sa,{reports:V.value,loading:M.value,onView:De,onEdit:De,onExtract:Je,onDownload:je,onDelete:Qe,onUpload:n[4]||(n[4]=f=>o.value=!0)},null,8,["reports","loading"])]),_:1}),q.value.length>0?(l(),y(fe,{key:1,class:"section-card"},{header:e(()=>[...n[17]||(n[17]=[p("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(ot,null,{default:e(()=>[(l(!0),D(W,null,Q(q.value,f=>(l(),y(lt,{key:f.id,timestamp:te(f.created_at),placement:"top"},{default:e(()=>[t(fe,null,{default:e(()=>[p("h4",null,b(f.prof_activity_name),1),p("div",_a,[p("div",va,[p("span",ya,b(f.score_pct)+"%",1),t(nt,{percentage:f.score_pct,status:le(f.score_pct)},null,8,["percentage","status"])]),p("div",ga,[p("div",wa,[n[18]||(n[18]=p("h5",null,"Сильные стороны:",-1)),f.strengths&&f.strengths.length?(l(),D("ul",ba,[(l(!0),D(W,null,Q(f.strengths,(P,ue)=>(l(),D("li",{key:ue},[p("strong",null,b(P.metric_name),1),_(" — "+b(R(de)(P.value))+" (вес "+b(R(de)(P.weight,2))+") ",1)]))),128))])):(l(),y(ye,{key:1,description:"Нет данных","image-size":60}))]),p("div",ha,[n[19]||(n[19]=p("h5",null,"Зоны развития:",-1)),f.dev_areas&&f.dev_areas.length?(l(),D("ul",ka,[(l(!0),D(W,null,Q(f.dev_areas,(P,ue)=>(l(),D("li",{key:ue},[p("strong",null,b(P.metric_name),1),_(" — "+b(R(de)(P.value))+" (вес "+b(R(de)(P.weight,2))+") ",1)]))),128))])):(l(),y(ye,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ca,[p("h5",null,[n[20]||(n[20]=_(" Рекомендации: ",-1)),f.recommendations_status?(l(),y(st,{key:0,type:re(f.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[_(b(oe(f.recommendations_status)),1)]),_:2},1032,["type"])):A("",!0)]),et(f)?(l(),D("ul",Ra,[(l(!0),D(W,null,Q(f.recommendations,(P,ue)=>(l(),D("li",{key:ue,class:"recommendation-item"},[p("strong",null,b(P.title),1),P.skill_focus?(l(),D("div",Da,[n[21]||(n[21]=p("strong",null,"Навык:",-1)),_(" "+b(P.skill_focus),1)])):A("",!0),P.development_advice?(l(),D("div",$a,b(P.development_advice),1)):A("",!0),P.recommended_formats&&P.recommended_formats.length>0?(l(),D("div",Ea,[n[22]||(n[22]=p("strong",null,"Рекомендуемые форматы:",-1)),p("ul",Sa,[(l(!0),D(W,null,Q(P.recommended_formats,(dt,ct)=>(l(),D("li",{key:ct},b(dt),1))),128))])])):A("",!0)]))),128))])):f.recommendations_status==="pending"?(l(),y(ie,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):f.recommendations_status==="error"?(l(),y(ie,{key:2,title:tt(f),type:"error",closable:!1,"show-icon":""},null,8,["title"])):f.recommendations_status==="disabled"?(l(),y(ie,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(l(),y(ye,{key:4,description:"Нет данных","image-size":60}))])]),f.prof_activity_code?(l(),D("div",Ma,[t(L,{type:"primary",size:"small",onClick:P=>Ze(f)},{default:e(()=>[t(O,null,{default:e(()=>[t(R(be))]),_:1}),n[23]||(n[23]=_(" Скачать PDF ",-1))]),_:1},8,["onClick"])])):A("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):A("",!0),t(ge,{modelValue:o.value,"onUpdate:modelValue":n[6]||(n[6]=f=>o.value=f),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(L,{onClick:n[5]||(n[5]=f=>o.value=!1)},{default:e(()=>[...n[26]||(n[26]=[_(" Отмена ",-1)])]),_:1}),t(L,{type:"primary",loading:E.value,onClick:Ge},{default:e(()=>[...n[27]||(n[27]=[_(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Ee,{ref_key:"uploadFormRef",ref:u,model:z,rules:ee,"label-position":"top"},{default:e(()=>[t($e,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(rt,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Xe,"file-list":v.value},{tip:e(()=>[...n[25]||(n[25]=[p("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(L,{type:"primary"},{default:e(()=>[...n[24]||(n[24]=[_(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ge,{modelValue:s.value,"onUpdate:modelValue":n[9]||(n[9]=f=>s.value=f),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(L,{onClick:n[8]||(n[8]=f=>s.value=!1)},{default:e(()=>[...n[28]||(n[28]=[_(" Отмена ",-1)])]),_:1}),t(L,{type:"primary",loading:S.value,disabled:!B.activityCode||V.value.length===0,onClick:Ye},{default:e(()=>[...n[29]||(n[29]=[_(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Ee,{model:B,"label-position":"top"},{default:e(()=>[t($e,{label:"Профессиональная область",required:""},{default:e(()=>[pe((l(),y(ut,{modelValue:B.activityCode,"onUpdate:modelValue":n[7]||(n[7]=f=>B.activityCode=f),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(l(!0),D(W,null,Q(X.value,f=>(l(),y(it,{key:f.code,label:f.name,value:f.code},{default:e(()=>[p("span",null,b(f.name),1),p("span",xa,b(f.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Se,F.value]])]),_:1}),t(ie,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),V.value.length===0?(l(),y(ie,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):A("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ge,{modelValue:k.value,"onUpdate:modelValue":n[10]||(n[10]=f=>k.value=f),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[h.value?(l(),y(zt,{key:0,"report-id":h.value,onMetricsUpdated:Ke},null,8,["report-id"])):A("",!0)]),_:1},8,["modelValue"]),t(da,{modelValue:c.value,"onUpdate:modelValue":n[11]||(n[11]=f=>c.value=f),"participant-id":w.value?.id,"participant-name":w.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Se,T.value]])]),_:1})}}},Fa=me(Aa,[["__scopeId","data-v-e2cf0b31"]]);export{Fa as default};
