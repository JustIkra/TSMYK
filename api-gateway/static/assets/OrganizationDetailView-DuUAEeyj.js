import{m as r,n as S,H as Ne,v as w,w as l,q as Oe,E as u,d as qe,r as o,I as Se,o as d,J as ne,c as x,x as F,f as a,u as y,e as i,B as f,a as v,F as ue,C as pe,K as me,M as Ie,N as ce}from"./index-vlzas5d2.js";import{A as Le}from"./AppLayout-BR_nyyzg.js";import{p as fe}from"./participants-Cc2hziXM.js";import{o as D}from"./organizations--aXjPTxf.js";import{a as He}from"./dateFormat-Bky3s5gS.js";import{u as Je}from"./useResponsive-u-GBMYwZ.js";import{_ as Ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Qe={class:"org-detail"},je={class:"card-header"},Ge={class:"header-actions"},We={class:"section-header"},Xe={key:1,class:"departments-list"},Ze={class:"dept-header"},ea={class:"dept-title"},aa={class:"dept-name"},ta={class:"dept-actions"},la={key:0,class:"dept-description"},na={key:1,class:"dept-participants"},ia={class:"participant-search-list"},oa={key:0,class:"participant-ext-id"},ra={__name:"OrganizationDetailView",setup(sa){const I=qe(),b=Oe(),{isMobile:R}=Je(),L=r(!1),p=r(!1),m=r(null),$=r({}),H=r({}),J=r({}),B=r(!1),K=r(null),h=S({name:"",description:""}),ve={name:[{required:!0,message:"Введите название",trigger:"blur"}]},A=r(!1),Q=r(null),C=S({name:"",description:""}),ie={name:[{required:!0,message:"Введите название отдела",trigger:"blur"}]},E=r(!1),j=r(null),_=S({id:null,name:"",description:""}),M=r(!1),G=r("existing"),g=r(null),U=r([]),T=r([]),Y=r(!1),W=r("");let oe=null;const X=r(null),c=S({full_name:"",birth_date:"",external_id:""}),_e={full_name:[{required:!0,message:"Введите ФИО",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},z=async()=>{L.value=!0;try{const n=await D.getById(b.params.id);m.value=n}catch{u.error("Организация не найдена"),I.push("/organizations")}finally{L.value=!1}},ye=async()=>{K.value&&await K.value.validate(async n=>{if(n){p.value=!0;try{await D.update(b.params.id,h),u.success("Организация обновлена"),B.value=!1,await z()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления")}finally{p.value=!1}}})},ge=async()=>{Q.value&&await Q.value.validate(async n=>{if(n){p.value=!0;try{await D.createDepartment(b.params.id,C),u.success("Отдел создан"),A.value=!1,C.name="",C.description="",await z()}catch(e){u.error(e.response?.data?.detail||"Ошибка создания отдела")}finally{p.value=!1}}})},we=n=>{_.id=n.id,_.name=n.name,_.description=n.description||"",E.value=!0},be=async()=>{j.value&&await j.value.validate(async n=>{if(n){p.value=!0;try{await D.updateDepartment(b.params.id,_.id,{name:_.name,description:_.description}),u.success("Отдел обновлён"),E.value=!1,await z()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления отдела")}finally{p.value=!1}}})},Ve=n=>{ce.confirm(`Удалить отдел "${n.name}"? Участники будут отвязаны, но не удалены.`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await D.deleteDepartment(b.params.id,n.id),u.success("Отдел удалён"),await z()}catch{u.error("Ошибка удаления отдела")}}).catch(()=>{})},ke=async n=>{if($.value[n]){$.value[n]=!1;return}$.value[n]=!0,await N(n)},N=async n=>{J.value[n]=!0;try{const e=await D.listDepartmentParticipants(b.params.id,n);H.value[n]=e}catch{u.error("Ошибка загрузки участников отдела")}finally{J.value[n]=!1}},xe=async n=>{g.value=n,U.value=[],T.value=[],W.value="",G.value="existing",c.full_name="",c.birth_date="",c.external_id="",M.value=!0,await re("")},re=async n=>{Y.value=!0;try{const e={size:50};n&&n.length>=2&&(e.query=n);const s=await fe.search(e);T.value=s.items||[]}catch{T.value=[]}finally{Y.value=!1}},De=n=>{clearTimeout(oe),oe=setTimeout(()=>{re(n)},300)},he=async()=>{if(!(!U.value.length||!g.value)){p.value=!0;try{await D.attachParticipants(b.params.id,g.value.id,U.value),u.success("Участники привязаны"),M.value=!1,await z(),$.value[g.value.id]&&await N(g.value.id)}catch(n){u.error(n.response?.data?.detail||"Ошибка привязки участников")}finally{p.value=!1}}},Ce=async()=>{!X.value||!g.value||await X.value.validate(async n=>{if(n){p.value=!0;try{const e=await fe.create({full_name:c.full_name,birth_date:c.birth_date||null,external_id:c.external_id||null});await D.attachParticipants(b.params.id,g.value.id,[e.id]),u.success(`Участник "${e.full_name}" создан и привязан`),M.value=!1,await z(),$.value[g.value.id]&&await N(g.value.id)}catch(e){u.error(e.response?.data?.detail||"Ошибка создания участника")}finally{p.value=!1}}})},ze=(n,e)=>{ce.confirm(`Отвязать "${e.full_name}" от отдела "${n.name}"?`,"Подтверждение",{confirmButtonText:"Отвязать",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await D.detachParticipant(b.params.id,n.id,e.id),u.success("Участник отвязан"),await z(),await N(n.id)}catch{u.error("Ошибка отвязки участника")}}).catch(()=>{})};return Ne(async()=>{await z(),m.value&&(h.name=m.value.name,h.description=m.value.description||"")}),(n,e)=>{const s=o("el-button"),O=o("el-descriptions-item"),Pe=o("el-descriptions"),Z=o("el-card"),se=o("el-icon"),ee=o("el-empty"),$e=o("el-tag"),Ue=o("el-divider"),Fe=o("el-link"),ae=o("el-table-column"),Re=o("el-table"),V=o("el-input"),k=o("el-form-item"),q=o("el-form"),te=o("el-dialog"),Be=o("el-checkbox"),Ae=o("el-checkbox-group"),de=o("el-tab-pane"),Ee=o("el-date-picker"),Me=o("el-tabs"),Te=o("el-drawer"),le=Se("loading");return d(),w(Le,null,{default:l(()=>[ne((d(),x("div",Qe,[m.value?(d(),w(Z,{key:0,class:"detail-card"},{header:l(()=>[v("div",je,[v("h2",null,f(m.value.name),1),v("div",Ge,[a(s,{onClick:e[0]||(e[0]=t=>y(I).push("/organizations"))},{default:l(()=>[...e[22]||(e[22]=[i(" Назад ",-1)])]),_:1}),a(s,{type:"primary",onClick:e[1]||(e[1]=t=>B.value=!0)},{default:l(()=>[...e[23]||(e[23]=[i(" Редактировать ",-1)])]),_:1})])])]),default:l(()=>[a(Pe,{column:y(R)?1:2,border:""},{default:l(()=>[a(O,{label:"Название"},{default:l(()=>[i(f(m.value.name),1)]),_:1}),a(O,{label:"Описание"},{default:l(()=>[i(f(m.value.description||"Не указано"),1)]),_:1}),a(O,{label:"Дата создания"},{default:l(()=>[i(f(y(He)(m.value.created_at)),1)]),_:1}),a(O,{label:"Кол-во отделов"},{default:l(()=>[i(f(m.value.departments?.length||0),1)]),_:1})]),_:1},8,["column"])]),_:1})):F("",!0),m.value?(d(),w(Z,{key:1,class:"section-card"},{header:l(()=>[v("div",We,[e[25]||(e[25]=v("h3",null,"Отделы",-1)),a(s,{type:"primary",onClick:e[2]||(e[2]=t=>A.value=!0)},{default:l(()=>[a(se,null,{default:l(()=>[a(y(me))]),_:1}),e[24]||(e[24]=i(" Добавить отдел ",-1))]),_:1})])]),default:l(()=>[m.value.departments?.length?(d(),x("div",Xe,[(d(!0),x(ue,null,pe(m.value.departments,t=>(d(),w(Z,{key:t.id,class:"dept-card",shadow:"hover"},{header:l(()=>[v("div",Ze,[v("div",ea,[v("span",aa,f(t.name),1),a($e,{size:"small"},{default:l(()=>[i(f(t.participants_count)+" уч. ",1)]),_:2},1024)]),v("div",ta,[a(s,{size:"small",onClick:P=>ke(t.id)},{default:l(()=>[i(f($.value[t.id]?"Свернуть":"Участники"),1)]),_:2},1032,["onClick"]),a(s,{size:"small",type:"primary",plain:"",onClick:P=>xe(t)},{default:l(()=>[a(se,null,{default:l(()=>[a(y(me))]),_:1}),e[26]||(e[26]=i(" Добавить ",-1))]),_:1},8,["onClick"]),a(s,{size:"small",onClick:P=>we(t)},{default:l(()=>[...e[27]||(e[27]=[i(" Изменить ",-1)])]),_:1},8,["onClick"]),a(s,{size:"small",type:"danger",plain:"",onClick:P=>Ve(t)},{default:l(()=>[...e[28]||(e[28]=[i(" Удалить ",-1)])]),_:1},8,["onClick"])])])]),default:l(()=>[t.description?(d(),x("div",la,f(t.description),1)):F("",!0),$.value[t.id]?ne((d(),x("div",na,[t.description?(d(),w(Ue,{key:0})):F("",!0),e[30]||(e[30]=v("div",{class:"dept-participants-header"},[v("span",null,"Участники отдела")],-1)),H.value[t.id]?.length?(d(),w(Re,{key:2,data:H.value[t.id],size:"small",stripe:""},{default:l(()=>[a(ae,{label:"ФИО"},{default:l(({row:P})=>[a(Fe,{type:"primary",underline:!1,onClick:Ye=>y(I).push(`/participants/${P.id}`)},{default:l(()=>[i(f(P.full_name),1)]),_:2},1032,["onClick"])]),_:1}),a(ae,{prop:"external_id",label:"Внешний ID",width:"150"}),a(ae,{label:"",width:"120",align:"center"},{default:l(({row:P})=>[a(s,{type:"warning",size:"small",plain:"",onClick:Ye=>ze(t,P)},{default:l(()=>[...e[29]||(e[29]=[i(" Отвязать ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])):(d(),w(ee,{key:1,description:"Нет участников","image-size":60}))])),[[le,J.value[t.id]]]):F("",!0)]),_:2},1024))),128))])):(d(),w(ee,{key:0,description:"Нет отделов","image-size":80}))]),_:1})):F("",!0),a(te,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=t=>B.value=t),title:"Редактировать организацию",width:y(R)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[5]||(e[5]=t=>B.value=!1)},{default:l(()=>[...e[31]||(e[31]=[i(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:ye},{default:l(()=>[...e[32]||(e[32]=[i(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(q,{ref_key:"editFormRef",ref:K,model:h,rules:ve,"label-position":"top"},{default:l(()=>[a(k,{label:"Название",prop:"name"},{default:l(()=>[a(V,{modelValue:h.name,"onUpdate:modelValue":e[3]||(e[3]=t=>h.name=t)},null,8,["modelValue"])]),_:1}),a(k,{label:"Описание",prop:"description"},{default:l(()=>[a(V,{modelValue:h.description,"onUpdate:modelValue":e[4]||(e[4]=t=>h.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(te,{modelValue:A.value,"onUpdate:modelValue":e[10]||(e[10]=t=>A.value=t),title:"Добавить отдел",width:y(R)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[9]||(e[9]=t=>A.value=!1)},{default:l(()=>[...e[33]||(e[33]=[i(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:ge},{default:l(()=>[...e[34]||(e[34]=[i(" Создать ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(q,{ref_key:"deptFormRef",ref:Q,model:C,rules:ie,"label-position":"top"},{default:l(()=>[a(k,{label:"Название",prop:"name"},{default:l(()=>[a(V,{modelValue:C.name,"onUpdate:modelValue":e[7]||(e[7]=t=>C.name=t),placeholder:"Введите название отдела"},null,8,["modelValue"])]),_:1}),a(k,{label:"Описание",prop:"description"},{default:l(()=>[a(V,{modelValue:C.description,"onUpdate:modelValue":e[8]||(e[8]=t=>C.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(te,{modelValue:E.value,"onUpdate:modelValue":e[14]||(e[14]=t=>E.value=t),title:"Редактировать отдел",width:y(R)?"95%":"500px"},{footer:l(()=>[a(s,{onClick:e[13]||(e[13]=t=>E.value=!1)},{default:l(()=>[...e[35]||(e[35]=[i(" Отмена ",-1)])]),_:1}),a(s,{type:"primary",loading:p.value,onClick:be},{default:l(()=>[...e[36]||(e[36]=[i(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(q,{ref_key:"editDeptFormRef",ref:j,model:_,rules:ie,"label-position":"top"},{default:l(()=>[a(k,{label:"Название",prop:"name"},{default:l(()=>[a(V,{modelValue:_.name,"onUpdate:modelValue":e[11]||(e[11]=t=>_.name=t)},null,8,["modelValue"])]),_:1}),a(k,{label:"Описание",prop:"description"},{default:l(()=>[a(V,{modelValue:_.description,"onUpdate:modelValue":e[12]||(e[12]=t=>_.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),a(Te,{modelValue:M.value,"onUpdate:modelValue":e[21]||(e[21]=t=>M.value=t),title:"Добавить участника — "+(g.value?.name||""),size:y(R)?"100%":"480px",direction:"rtl","destroy-on-close":""},{default:l(()=>[a(Me,{modelValue:G.value,"onUpdate:modelValue":e[20]||(e[20]=t=>G.value=t)},{default:l(()=>[a(de,{label:"Найти существующего",name:"existing"},{default:l(()=>[a(V,{modelValue:W.value,"onUpdate:modelValue":e[15]||(e[15]=t=>W.value=t),placeholder:"Поиск по имени...",clearable:"","prefix-icon":y(Ie),style:{"margin-bottom":"var(--spacing-md)"},onInput:De},null,8,["modelValue","prefix-icon"]),ne((d(),x("div",ia,[!Y.value&&!T.value.length?(d(),w(ee,{key:0,description:"Участники не найдены","image-size":60})):(d(),w(Ae,{key:1,modelValue:U.value,"onUpdate:modelValue":e[16]||(e[16]=t=>U.value=t)},{default:l(()=>[(d(!0),x(ue,null,pe(T.value,t=>(d(),x("div",{key:t.id,class:"participant-search-item"},[a(Be,{value:t.id},{default:l(()=>[v("span",null,f(t.full_name),1),t.external_id?(d(),x("span",oa,f(t.external_id),1)):F("",!0)]),_:2},1032,["value"])]))),128))]),_:1},8,["modelValue"]))])),[[le,Y.value]]),a(s,{type:"primary",loading:p.value,disabled:!U.value.length,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:he},{default:l(()=>[i(" Привязать ("+f(U.value.length)+") ",1)]),_:1},8,["loading","disabled"])]),_:1}),a(de,{label:"Создать нового",name:"create"},{default:l(()=>[a(q,{ref_key:"newParticipantFormRef",ref:X,model:c,rules:_e,"label-position":"top"},{default:l(()=>[a(k,{label:"ФИО",prop:"full_name"},{default:l(()=>[a(V,{modelValue:c.full_name,"onUpdate:modelValue":e[17]||(e[17]=t=>c.full_name=t),placeholder:"Введите полное имя"},null,8,["modelValue"])]),_:1}),a(k,{label:"Дата рождения",prop:"birth_date"},{default:l(()=>[a(Ee,{modelValue:c.birth_date,"onUpdate:modelValue":e[18]||(e[18]=t=>c.birth_date=t),type:"date",placeholder:"Выберите дату",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(k,{label:"Внешний ID",prop:"external_id"},{default:l(()=>[a(V,{modelValue:c.external_id,"onUpdate:modelValue":e[19]||(e[19]=t=>c.external_id=t),placeholder:"Внешний идентификатор (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),a(s,{type:"primary",loading:p.value,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:Ce},{default:l(()=>[...e[37]||(e[37]=[i(" Создать и привязать ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title","size"])])),[[le,L.value]])]),_:1})}}},_a=Ke(ra,[["__scopeId","data-v-acfd6424"]]);export{_a as default};
