import{N as J,m as w,O as Z,p as _e,r as _,c as h,o as s,d as t,x,P as bt,w as e,u as b,Q as ht,K as kt,z as Rt,B as g,F as W,H as Se,v,f,C as Y,a as m,E as D,q as Xe,e as je,R as qe,I as Je,J as fe,S as Ct,T as Ve,k as Te,U as Ie,g as Oe,V as Et,W as Ue,X as Fe,h as ze,Y as Ee,Z as Pe,M as St,n as Be,t as Mt,_ as Dt,$ as $t,a0 as xt,a1 as At,G as Nt}from"./index-B5SOunuZ.js";import{A as Lt}from"./AppLayout-DYB8i-PD.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as Vt,m as we,p as Tt,g as It}from"./metricNames-C3msJp2y.js";import{u as Ot,p as Ge}from"./participants-CjZ8xhWa.js";const ye={async upload(d,k){const r=new FormData;return r.append("file",k),(await J.post(`/participants/${d}/reports`,r,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(d){return await J.get(`/reports/${d}/download`,{responseType:"blob"})},async getById(d){return(await J.get(`/reports/${d}`)).data},async delete(d){return(await J.delete(`/reports/${d}`)).data},async extract(d){return(await J.post(`/reports/${d}/extract`)).data},async getMetrics(d){return(await J.get(`/reports/${d}/metrics`)).data},async getList(d){return(await J.get(`/participants/${d}/reports`)).data}},ge={async calculate(d,k){return(await J.post(`/scoring/participants/${d}/calculate`,null,{params:{activity_code:k}})).data},async getHistory(d,k=10){return(await J.get(`/scoring/participants/${d}/scores`,{params:{limit:k}})).data},async getById(d){return(await J.get(`/scoring-results/${d}`)).data},async generateRecommendations(d){return(await J.post(`/reports/${d}/recommendations`)).data},async getFinalReport(d,k,r="json"){const E={params:{activity_code:k,format:r}};r==="html"&&(E.responseType="text");const O=await J.get(`/participants/${d}/final-report`,E);return O.data}};function be(d,k=1){if(d==null||d==="")return"";const r=typeof d=="string"?parseFloat(d):d;return isNaN(r)?"":r.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function oe(d){if(d==null||d==="")return null;const r=String(d).trim().replace(",","."),E=parseFloat(r);return isNaN(E)?null:E}function Ut(d){return oe(d)}function me(d,k=1){return be(d,k)}const Ft={key:0,class:"error-message"},zt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(d,{emit:k}){const r=d,E=k,O=w(null),N=w(""),T=w(!1),M=w(!1),$=w(""),R=Z(()=>oe(N.value)),L=Z(()=>{const i=R.value;return i===null||i<=r.min}),B=Z(()=>{const i=R.value;return i===null||i>=r.max}),U=i=>{if(i==null||i===""){N.value="";return}T.value?N.value=String(i).replace(".",","):N.value=be(i,r.precision)},G=i=>{if(i==null||i==="")return M.value=!1,$.value="",!0;const o=oe(i);return o===null?(M.value=!0,$.value="Некорректное число",!1):o<r.min?(M.value=!0,$.value=`Значение должно быть не меньше ${be(r.min,r.precision)}`,!1):o>r.max?(M.value=!0,$.value=`Значение должно быть не больше ${be(r.max,r.precision)}`,!1):(M.value=!1,$.value="",!0)},X=i=>{const o=i.replace(/[^\d,.-]/g,"");let y=!1;const p=o.split("").filter(C=>C===","||C==="."?y?!1:(y=!0,!0):!0).join("").replace(".",",");N.value=p;const l=oe(p);l!==null?E("update:modelValue",l):(p===""||p==="-")&&E("update:modelValue",null)},H=()=>{T.value=!1;const i=oe(N.value);if(G(N.value)){if(i!==null){const o=Math.round(i*Math.pow(10,r.precision))/Math.pow(10,r.precision),y=Math.max(r.min,Math.min(r.max,o));E("update:modelValue",y),U(y),E("change",y)}}else if(i!==null&&(i<r.min||i>r.max)){const o=Math.max(r.min,Math.min(r.max,i));E("update:modelValue",o),U(o),E("change",o),M.value=!1,$.value=""}E("blur")},K=()=>{T.value=!0,R.value!==null&&(N.value=String(R.value).replace(".",","))},j=()=>{const i=R.value||0,o=Math.min(r.max,i+r.step),y=Math.round(o*Math.pow(10,r.precision))/Math.pow(10,r.precision);E("update:modelValue",y),E("change",y),U(y)},F=()=>{const i=R.value||0,o=Math.max(r.min,i-r.step),y=Math.round(o*Math.pow(10,r.precision))/Math.pow(10,r.precision);E("update:modelValue",y),E("change",y),U(y)};return _e(()=>r.modelValue,i=>{U(i)},{immediate:!0}),U(r.modelValue),(i,o)=>{const y=_("el-button"),p=_("el-button-group"),l=_("el-input");return s(),h(W,null,[t(l,{ref_key:"inputRef",ref:O,modelValue:N.value,"onUpdate:modelValue":o[0]||(o[0]=C=>N.value=C),placeholder:d.placeholder,disabled:d.disabled,class:Rt({"is-invalid":M.value}),onInput:X,onBlur:H,onFocus:K},bt({_:2},[d.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(y,{icon:b(ht),disabled:d.disabled||L.value,onClick:F},null,8,["icon","disabled"]),t(y,{icon:b(kt),disabled:d.disabled||B.value,onClick:j},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),M.value?(s(),h("div",Ft,g($.value),1)):x("",!0)],64)}}},Pt=he(zt,[["__scopeId","data-v-74ef628d"]]),Bt={class:"card-header"},Gt={key:1},Xt={key:0,class:"metric-description"},jt={key:2,class:"metrics-info"},qt={class:"info-row"},Jt={key:0,class:"info-row"},Ht={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(d,{emit:k}){const r=d,E=k,O=w(!1),N=w(!1),T=w(!1),M=w(null),$=w([]),R=w([]),L=w({metrics:{}}),B=w({}),U=Z(()=>!R.value||R.value.length===0?[]:[...new Set(R.value.map(p=>p.source))]),G=Z(()=>!R.value||R.value.length===0?null:new Date),X=async()=>{try{const p=await we.listMetricDefs(!0);$.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),M.value="Не удалось загрузить определения метрик"}},H=async()=>{O.value=!0,M.value=null;try{const p=await we.listExtractedMetrics(r.reportId);R.value=p.items||[],L.value.metrics={},R.value.forEach(l=>{L.value.metrics[l.metric_def_id]=oe(l.value)}),B.value=JSON.parse(JSON.stringify(L.value.metrics))}catch(p){console.error("Failed to load metrics:",p),M.value="Не удалось загрузить метрики"}finally{O.value=!1}},K=()=>{T.value=!0,B.value=JSON.parse(JSON.stringify(L.value.metrics))},j=()=>{L.value.metrics=JSON.parse(JSON.stringify(B.value)),T.value=!1,M.value=null},F=async()=>{N.value=!0,M.value=null;try{const p=[];for(const[l,C]of Object.entries(L.value.metrics))if(C!=null&&C!==""){const P=Ut(C);P!==null&&p.push({metric_def_id:l,value:P,source:"MANUAL",notes:null})}if(p.length===0){D.warning("Не введено ни одного значения метрики"),N.value=!1;return}await we.bulkCreateExtractedMetrics(r.reportId,p),D.success(`Успешно сохранено ${p.length} метрик`),T.value=!1,await H(),E("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let l="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?l=p.response.data.detail:Array.isArray(p.response.data.detail)&&(l=p.response.data.detail.map(C=>C.msg||C.message).join(", "))),M.value=l,D.error(l)}finally{N.value=!1}},i=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},o=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},y=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Se(async()=>{await X(),await H()}),_e(()=>r.reportId,async p=>{p&&await H()}),(p,l)=>{const C=_("el-button"),P=_("el-alert"),Q=_("el-form-item"),ee=_("el-col"),q=_("el-row"),te=_("el-form"),le=_("el-divider"),re=_("el-tag"),ae=_("el-card");return s(),v(ae,{class:"metrics-editor"},{header:e(()=>[m("div",Bt,[l[4]||(l[4]=m("span",null,"Ручной ввод метрик",-1)),T.value?(s(),h("div",Gt,[t(C,{size:"small",onClick:j},{default:e(()=>[...l[2]||(l[2]=[f(" Отмена ",-1)])]),_:1}),t(C,{type:"primary",size:"small",loading:N.value,onClick:F},{default:e(()=>[...l[3]||(l[3]=[f(" Сохранить ",-1)])]),_:1},8,["loading"])])):(s(),v(C,{key:0,type:"primary",size:"small",onClick:K},{default:e(()=>[...l[1]||(l[1]=[f(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[M.value?(s(),v(P,{key:0,type:"error",title:M.value,closable:"",style:{"margin-bottom":"16px"},onClose:l[0]||(l[0]=V=>M.value=null)},null,8,["title"])):x("",!0),!R.value||R.value.length===0?(s(),v(P,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...l[5]||(l[5]=[f(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):x("",!0),t(te,{ref:"formRef",model:L.value,"label-position":"top",disabled:!T.value},{default:e(()=>[t(q,{gutter:20},{default:e(()=>[(s(!0),h(W,null,Y($.value,V=>(s(),v(ee,{key:V.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(Q,{label:b(Vt)(V),prop:`metrics.${V.id}`},{default:e(()=>[t(Pt,{modelValue:L.value.metrics[V.id],"onUpdate:modelValue":c=>L.value.metrics[V.id]=c,min:V.min_value||1,max:V.max_value||10,precision:1,step:.1,disabled:!T.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),V.description?(s(),h("div",Xt,g(V.description),1)):x("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),R.value&&R.value.length>0?(s(),h("div",jt,[t(le),m("div",qt,[l[6]||(l[6]=m("span",{class:"info-label"},"Источник данных:",-1)),(s(!0),h(W,null,Y(U.value,V=>(s(),v(re,{key:V,type:i(V),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[f(g(o(V)),1)]),_:2},1032,["type"]))),128))]),G.value?(s(),h("div",Jt,[l[7]||(l[7]=m("span",{class:"info-label"},"Последнее обновление:",-1)),m("span",null,g(y(G.value)),1)])):x("",!0)])):x("",!0)]),_:1})}}},Wt=he(Ht,[["__scopeId","data-v-1e3d866a"]]),Kt={class:"report-list"},Qt={class:"report-list__controls"},Yt={class:"controls-left"},Zt={class:"controls-right"},ea={class:"filename"},ta={class:"status-cell"},aa={key:1,class:"report-list__cards"},na={class:"report-card__header"},sa={class:"report-card__status"},oa={class:"report-card__body"},la={class:"report-card__field"},ra={class:"field-value"},ia={class:"report-card__field"},ua={class:"field-value"},da={class:"report-card__actions"},ca={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(d,{emit:k}){const r=d,E=k,O=Xe(),N=je(),T=w(window.innerWidth<=768),M=()=>{T.value=window.innerWidth<=768};Se(()=>{window.addEventListener("resize",M),O.query.status&&($.value=O.query.status),O.query.sort&&(R.value=O.query.sort)}),qe(()=>{window.removeEventListener("resize",M)});const $=w(""),R=w("desc"),L=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];_e([$,R],([i,o])=>{const y={...O.query};i?y.status=i:delete y.status,o?y.sort=o:delete y.sort,N.replace({query:y})});const B=()=>{},U=()=>{R.value=R.value==="desc"?"asc":"desc"},G=Z(()=>{let i=[...r.reports];return $.value&&(i=i.filter(o=>o.status===$.value)),i.sort((o,y)=>{const p=new Date(o.uploaded_at),l=new Date(y.uploaded_at);return R.value==="desc"?l-p:p-l}),i}),X=Z(()=>$.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),H=i=>{if(!i)return"—";const o=new Date(i);return Number.isNaN(o.getTime())?"—":o.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},K=i=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[i]||i,j=i=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[i]||"info",F=async({action:i,report:o})=>{switch(i){case"view":E("view",o.id);break;case"edit":E("edit",o.id);break;case"extract":E("extract",o.id);break;case"download":E("download",o.id);break;case"delete":try{await St.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",o.id)}catch{}break}};return(i,o)=>{const y=_("el-option"),p=_("el-select"),l=_("el-icon"),C=_("el-button"),P=_("el-table-column"),Q=_("el-tag"),ee=_("el-dropdown-item"),q=_("el-dropdown-menu"),te=_("el-dropdown"),le=_("el-table"),re=_("el-card"),ae=_("el-empty"),V=Je("loading");return s(),h("div",Kt,[m("div",Qt,[m("div",Yt,[t(p,{modelValue:$.value,"onUpdate:modelValue":o[0]||(o[0]=c=>$.value=c),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(y,{label:"Все статусы",value:""}),(s(),h(W,null,Y(L,c=>t(y,{key:c.value,label:c.label,value:c.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",Zt,[t(C,{type:R.value==="desc"?"primary":"default",size:"small",onClick:U},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Ct))]),_:1}),f(" "+g(R.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),T.value?fe((s(),h("div",aa,[(s(!0),h(W,null,Y(G.value,c=>(s(),v(re,{key:c.id,class:"report-card",shadow:"hover"},{header:e(()=>[m("div",na,[m("div",sa,[c.status==="PROCESSING"?(s(),v(l,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(b(Ve))]),_:1})):c.status==="EXTRACTED"?(s(),v(l,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(b(Te))]),_:1})):c.status==="FAILED"?(s(),v(l,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(b(Ie))]),_:1})):(s(),v(l,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(b(Oe))]),_:1})),t(Q,{type:j(c.status),size:"small"},{default:e(()=>[f(g(K(c.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[m("div",da,[c.status==="EXTRACTED"?(s(),v(C,{key:0,type:"success",size:"small",onClick:ne=>F({action:"edit",report:c})},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Ue))]),_:1}),o[10]||(o[10]=f(" Редактировать ",-1))]),_:1},8,["onClick"])):x("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(s(),v(C,{key:1,type:"info",size:"small",onClick:ne=>F({action:"view",report:c})},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Fe))]),_:1}),o[11]||(o[11]=f(" Просмотр ",-1))]),_:1},8,["onClick"])):x("",!0),t(C,{type:"primary",size:"small",onClick:ne=>F({action:"extract",report:c})},{default:e(()=>[t(l,null,{default:e(()=>[t(b(ze))]),_:1}),f(" "+g(c.status==="FAILED"?"Повторить":c.status==="PROCESSING"?"Перезапустить":c.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(C,{size:"small",onClick:ne=>F({action:"download",report:c})},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Ee))]),_:1}),o[12]||(o[12]=f(" Скачать ",-1))]),_:1},8,["onClick"]),t(C,{type:"danger",size:"small",onClick:ne=>F({action:"delete",report:c})},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Pe))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[m("div",oa,[m("div",la,[o[8]||(o[8]=m("span",{class:"field-label"},"Файл:",-1)),m("span",ra,g(c.file_ref?.filename||"Без названия"),1)]),m("div",ia,[o[9]||(o[9]=m("span",{class:"field-label"},"Дата загрузки:",-1)),m("span",ua,g(H(c.uploaded_at)),1)])])]),_:2},1024))),128)),!G.value.length&&!d.loading?(s(),v(ae,{key:0,description:X.value,"image-size":120},{default:e(()=>[$.value?x("",!0):(s(),v(C,{key:0,type:"primary",onClick:o[1]||(o[1]=c=>i.$emit("upload"))},{default:e(()=>[...o[13]||(o[13]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):x("",!0)])),[[V,d.loading]]):fe((s(),v(le,{key:0,data:G.value,class:"report-list__table",stripe:"","empty-text":X.value},{default:e(()=>[t(P,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:c})=>[m("span",ea,g(c.file_ref?.filename||"Без названия"),1)]),_:1}),t(P,{prop:"status",label:"Статус",width:"200"},{default:e(({row:c})=>[m("div",ta,[c.status==="PROCESSING"?(s(),v(l,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(b(Ve))]),_:1})):c.status==="EXTRACTED"?(s(),v(l,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(b(Te))]),_:1})):c.status==="FAILED"?(s(),v(l,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(b(Ie))]),_:1})):(s(),v(l,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(b(Oe))]),_:1})),t(Q,{type:j(c.status),size:"default"},{default:e(()=>[f(g(K(c.status)),1)]),_:2},1032,["type"])])]),_:1}),t(P,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:c})=>[f(g(H(c.uploaded_at)),1)]),_:1}),t(P,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:c})=>[t(te,{trigger:"click",onCommand:F},{dropdown:e(()=>[t(q,null,{default:e(()=>[c.status==="EXTRACTED"?(s(),v(ee,{key:0,command:{action:"edit",report:c}},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Ue))]),_:1}),o[4]||(o[4]=f(" Редактировать метрики ",-1))]),_:1},8,["command"])):x("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(s(),v(ee,{key:1,command:{action:"view",report:c}},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Fe))]),_:1}),o[5]||(o[5]=f(" Просмотр метрик ",-1))]),_:1},8,["command"])):x("",!0),t(ee,{command:{action:"extract",report:c}},{default:e(()=>[t(l,null,{default:e(()=>[t(b(ze))]),_:1}),f(" "+g(c.status==="FAILED"?"Повторить извлечение":c.status==="PROCESSING"?"Перезапустить извлечение":c.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(ee,{divided:"",command:{action:"download",report:c}},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Ee))]),_:1}),o[6]||(o[6]=f(" Скачать ",-1))]),_:1},8,["command"]),t(ee,{command:{action:"delete",report:c},class:"dropdown-item--danger"},{default:e(()=>[t(l,null,{default:e(()=>[t(b(Pe))]),_:1}),o[7]||(o[7]=f(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(C,{type:"primary",size:"small"},{default:e(()=>[o[3]||(o[3]=f(" Действия ",-1)),t(l,{class:"el-icon--right"},{default:e(()=>[t(b(Et))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[V,d.loading]]),!G.value.length&&!d.loading&&!T.value?(s(),v(ae,{key:2,description:X.value,"image-size":120},{default:e(()=>[$.value?x("",!0):(s(),v(C,{key:0,type:"primary",onClick:o[2]||(o[2]=c=>i.$emit("upload"))},{default:e(()=>[...o[14]||(o[14]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):x("",!0)])}}},pa=he(ca,[["__scopeId","data-v-c9651b50"]]),ma={class:"participant-detail"},fa={class:"card-header"},_a={class:"header-actions"},va={class:"section-header"},ya={class:"section-header"},ga={key:1},wa={key:1},ba={class:"scoring-result"},ha={class:"score-value"},ka={class:"score-number"},Ra={class:"score-details"},Ca={class:"score-section"},Ea={key:0},Sa={class:"score-section"},Ma={key:0},Da={class:"score-section"},$a={key:0},xa={key:0,class:"recommendation-skill-focus"},Aa={key:1,class:"recommendation-advice"},Na={key:2,class:"recommendation-formats"},La={class:"formats-list"},Va={key:0,class:"final-report-actions"},Ta={class:"activity-code-hint"},Ia={__name:"ParticipantDetailView",setup(d){const k=je(),r=Xe(),E=Ot(),O=w(!1),N=w(!1),T=w(!1),M=w(!1),$=w(!1),R=w(!1),L=Z(()=>E.currentParticipant),B=w([]),U=w([]),G=w([]),X=w([]),H=w([]);w([]);const K=w(null),j=w(null),F=w(null),i=Z(()=>B.value.some(a=>a.status==="PROCESSING")),o=Z(()=>U.value.some(a=>a.recommendations_status==="pending")),y=w(!1),p=w(!1),l=w(!1),C=w(null),P=w([]),Q=Be({file:null}),ee={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},q=Be({activityCode:""}),te=a=>{if(!a)return"—";const n=new Date(a);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},le=a=>a>=80?"success":a>=60?"":"warning",re=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,ae=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",V=a=>a>=.8?"var(--color-success)":a>=.6?"var(--color-warning)":"var(--color-danger)",c=new Set,ne=a=>{if(!a)return"—";const n=H.value.find(A=>A.code===a),S=c.has(a)?{warn:()=>{}}:{warn:A=>{c.add(a),console.warn(A)}};return It(n,a,S)},He=async()=>{O.value=!0;try{await E.getParticipant(r.params.id)}catch{D.error("Участник не найден"),k.push("/participants")}finally{O.value=!1}},ie=async({silent:a=!1}={})=>{a||(N.value=!0);try{const n=await Ge.getReports(r.params.id);B.value=n.items||[]}catch(n){console.error("Error loading reports:",n),D.error("Ошибка загрузки списка отчётов")}finally{a||(N.value=!1)}},Me=a=>{if(!a)return a;const n=Array.isArray(a.recommendations)?a.recommendations:[];let S=a.recommendations_status||a.recommendationsStatus||null;S||(S=n.length>0?"ready":"pending");const A=Number(a.score_pct),z=Number.isNaN(A)?a.score_pct:A;return{...a,score_pct:z,recommendations:n,recommendations_status:S,recommendations_error:a.recommendations_error||a.recommendationsError||null}},De=async()=>{try{const a=await ge.getHistory(r.params.id),n=Array.isArray(a.items)?a.items:[];U.value=n.map(Me)}catch(a){console.error("Error loading scoring results:",a)}},We=async()=>{T.value=!0;try{const a=await Tt.list();G.value=a||[]}catch{D.error("Ошибка загрузки профессиональных областей")}finally{T.value=!1}},Ke=async()=>{try{const a=await we.listMetricDefs(!0);H.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},ue=async({silent:a=!1}={})=>{a||(M.value=!0);try{const n=await Ge.getMetrics(r.params.id);console.log("[DEBUG] loadParticipantMetrics response:",n),console.log("[DEBUG] response.metrics length:",n.metrics?.length||0),X.value=n.metrics||[],console.log("[DEBUG] participantMetrics.value length:",X.value.length)}catch(n){console.error("Error loading participant metrics:",n),D.error("Ошибка загрузки метрик участника")}finally{a||(M.value=!1)}},Qe=a=>{Q.file=a.raw,P.value=[a]},Ye=async()=>{C.value&&await C.value.validate(async a=>{if(a){if(!Q.file){D.error("Выберите файл");return}$.value=!0;try{await ye.upload(r.params.id,Q.file),D.success("Отчёт загружен успешно"),y.value=!1,Q.file=null,P.value=[],await ie(),await ue()}catch{D.error("Ошибка загрузки отчёта")}finally{$.value=!1}}})},Ze=async a=>{try{const n=await ye.download(a),S=window.URL.createObjectURL(new Blob([n.data])),A=document.createElement("a");A.href=S,A.setAttribute("download",`report_${a}.docx`),document.body.appendChild(A),A.click(),A.remove(),window.URL.revokeObjectURL(S),D.success("Отчёт скачан")}catch{D.error("Ошибка скачивания отчёта")}},et=async a=>{try{await ye.extract(a),D.success("Извлечение метрик запущено"),await ie()}catch{D.error("Ошибка запуска извлечения метрик")}},tt=()=>{j.value||(j.value=setInterval(async()=>{try{await ie({silent:!0}),await ue({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},$e=()=>{j.value&&(clearInterval(j.value),j.value=null)},at=()=>{F.value||(F.value=setInterval(async()=>{try{await De()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},xe=()=>{F.value&&(clearInterval(F.value),F.value=null)};_e(i,a=>{a?tt():$e()}),_e(o,a=>{a?at():xe()});const Ae=async a=>{K.value=a,await Nt(),l.value=!0},nt=async()=>{D.success("Метрики обновлены"),await ue()},st=async a=>{try{await ye.delete(a),D.success("Отчёт удалён"),await ie()}catch{D.error("Ошибка удаления отчёта")}},ot=async()=>{if(!q.activityCode){D.warning("Выберите профессиональную область");return}R.value=!0;try{const a=await ge.calculate(r.params.id,q.activityCode),n=Me({id:a.scoring_result_id,participant_id:r.params.id,prof_activity_code:a.prof_activity_code||q.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});U.value.unshift(n),D.success("Расчёт пригодности выполнен"),p.value=!1,q.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const n=a.response?.data?.detail||"Ошибка расчёта пригодности";D.error(n)}finally{R.value=!1}},lt=async a=>{if(!a.prof_activity_code){D.warning("Код профессиональной деятельности не найден");return}try{const n=await ge.getFinalReport(r.params.id,a.prof_activity_code,"json"),S=JSON.stringify(n,null,2),A=new Blob([S],{type:"application/json"}),z=window.URL.createObjectURL(A);window.open(z,"_blank"),window.URL.revokeObjectURL(z),D.success("Отчёт JSON открыт в новой вкладке")}catch(n){console.error("Error viewing final report JSON:",n);const S=n.response?.data?.detail||"Ошибка загрузки финального отчёта";D.error(S)}},rt=async a=>{if(!a.prof_activity_code){D.warning("Код профессиональной деятельности не найден");return}try{const n=await ge.getFinalReport(r.params.id,a.prof_activity_code,"html"),S=new Blob([n],{type:"text/html"}),A=window.URL.createObjectURL(S),z=document.createElement("a");z.href=A,z.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(z),z.click(),z.remove(),window.URL.revokeObjectURL(A),D.success("Отчёт HTML скачан")}catch(n){console.error("Error downloading final report HTML:",n);const S=n.response?.data?.detail||"Ошибка загрузки финального отчёта";D.error(S)}},it=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,ut=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Se(async()=>{await He(),await ie(),await De(),await We(),await Ke(),await ue()}),qe(()=>{$e(),xe()}),(a,n)=>{const S=_("el-button"),A=_("el-icon"),z=_("el-descriptions-item"),dt=_("el-descriptions"),de=_("el-card"),se=_("el-table-column"),ke=_("el-tag"),ct=_("el-table"),ve=_("el-empty"),pt=_("el-progress"),ce=_("el-alert"),mt=_("el-timeline-item"),ft=_("el-timeline"),_t=_("el-upload"),Ne=_("el-form-item"),Le=_("el-form"),Re=_("el-dialog"),vt=_("el-option"),yt=_("el-select"),Ce=Je("loading");return s(),v(Lt,null,{default:e(()=>[fe((s(),h("div",ma,[L.value?(s(),v(de,{key:0,class:"detail-card"},{header:e(()=>[m("div",fa,[m("h2",null,g(L.value.full_name),1),m("div",_a,[t(S,{onClick:n[0]||(n[0]=u=>b(k).back())},{default:e(()=>[...n[10]||(n[10]=[f(" Назад ",-1)])]),_:1}),t(S,{type:"primary",onClick:n[1]||(n[1]=u=>p.value=!0)},{default:e(()=>[t(A,null,{default:e(()=>[t(b(Mt))]),_:1}),n[11]||(n[11]=f(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(dt,{column:2,border:""},{default:e(()=>[t(z,{label:"ФИО"},{default:e(()=>[f(g(L.value.full_name),1)]),_:1}),t(z,{label:"Дата рождения"},{default:e(()=>[f(g(L.value.birth_date||"Не указана"),1)]),_:1}),t(z,{label:"Внешний ID"},{default:e(()=>[f(g(L.value.external_id||"Не указан"),1)]),_:1}),t(z,{label:"Дата создания"},{default:e(()=>[f(g(te(L.value.created_at)),1)]),_:1})]),_:1})]),_:1})):x("",!0),t(de,{class:"section-card"},{header:e(()=>[m("div",va,[n[13]||(n[13]=m("h3",null,"Отчёты",-1)),t(S,{type:"primary",onClick:n[2]||(n[2]=u=>y.value=!0)},{default:e(()=>[t(A,null,{default:e(()=>[t(b(Dt))]),_:1}),n[12]||(n[12]=f(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(pa,{reports:B.value,loading:N.value,onView:Ae,onEdit:Ae,onExtract:et,onDownload:Ze,onDelete:st,onUpload:n[3]||(n[3]=u=>y.value=!0)},null,8,["reports","loading"])]),_:1}),t(de,{class:"section-card"},{header:e(()=>[m("div",ya,[n[15]||(n[15]=m("h3",null,"Актуальные метрики участника",-1)),t(S,{type:"primary",size:"small",onClick:ue},{default:e(()=>[t(A,null,{default:e(()=>[t(b(xt))]),_:1}),n[14]||(n[14]=f(" Обновить ",-1))]),_:1})])]),default:e(()=>[fe((s(),v(ct,{data:X.value,stripe:""},{default:e(()=>[t(se,{prop:"metric_code",label:"Код метрики",width:"200"}),t(se,{label:"Название метрики","min-width":"250"},{default:e(({row:u})=>[f(g(ne(u.metric_code)),1)]),_:1}),t(se,{prop:"value",label:"Значение",width:"120"},{default:e(({row:u})=>[t(ke,{type:"success"},{default:e(()=>[f(g(b(me)(u.value)),1)]),_:2},1024)]),_:1}),t(se,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:u})=>[u.confidence!==null?(s(),h("span",{key:0,style:$t({color:V(u.confidence)})},g((u.confidence*100).toFixed(0))+"% ",5)):(s(),h("span",ga,"—"))]),_:1}),t(se,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:u})=>[f(g(te(u.updated_at)),1)]),_:1}),t(se,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:u})=>[u.last_source_report_id?(s(),v(ke,{key:0,size:"small"},{default:e(()=>[...n[16]||(n[16]=[f(" Из отчёта ",-1)])]),_:1})):(s(),h("span",wa,"—"))]),_:1})]),_:1},8,["data"])),[[Ce,M.value]]),!X.value.length&&!M.value?(s(),v(ve,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):x("",!0)]),_:1}),U.value.length>0?(s(),v(de,{key:1,class:"section-card"},{header:e(()=>[...n[17]||(n[17]=[m("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(ft,null,{default:e(()=>[(s(!0),h(W,null,Y(U.value,u=>(s(),v(mt,{key:u.id,timestamp:te(u.created_at),placement:"top"},{default:e(()=>[t(de,null,{default:e(()=>[m("h4",null,g(u.prof_activity_name),1),m("div",ba,[m("div",ha,[m("span",ka,g(u.score_pct)+"%",1),t(pt,{percentage:u.score_pct,status:le(u.score_pct)},null,8,["percentage","status"])]),m("div",Ra,[m("div",Ca,[n[18]||(n[18]=m("h5",null,"Сильные стороны:",-1)),u.strengths&&u.strengths.length?(s(),h("ul",Ea,[(s(!0),h(W,null,Y(u.strengths,(I,pe)=>(s(),h("li",{key:pe},[m("strong",null,g(I.metric_name),1),f(" — "+g(b(me)(I.value))+" (вес "+g(b(me)(I.weight,2))+") ",1)]))),128))])):(s(),v(ve,{key:1,description:"Нет данных","image-size":60}))]),m("div",Sa,[n[19]||(n[19]=m("h5",null,"Зоны развития:",-1)),u.dev_areas&&u.dev_areas.length?(s(),h("ul",Ma,[(s(!0),h(W,null,Y(u.dev_areas,(I,pe)=>(s(),h("li",{key:pe},[m("strong",null,g(I.metric_name),1),f(" — "+g(b(me)(I.value))+" (вес "+g(b(me)(I.weight,2))+") ",1)]))),128))])):(s(),v(ve,{key:1,description:"Нет данных","image-size":60}))]),m("div",Da,[m("h5",null,[n[20]||(n[20]=f(" Рекомендации: ",-1)),u.recommendations_status?(s(),v(ke,{key:0,type:ae(u.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[f(g(re(u.recommendations_status)),1)]),_:2},1032,["type"])):x("",!0)]),it(u)?(s(),h("ul",$a,[(s(!0),h(W,null,Y(u.recommendations,(I,pe)=>(s(),h("li",{key:pe,class:"recommendation-item"},[m("strong",null,g(I.title),1),I.skill_focus?(s(),h("div",xa,[n[21]||(n[21]=m("strong",null,"Навык:",-1)),f(" "+g(I.skill_focus),1)])):x("",!0),I.development_advice?(s(),h("div",Aa,g(I.development_advice),1)):x("",!0),I.recommended_formats&&I.recommended_formats.length>0?(s(),h("div",Na,[n[22]||(n[22]=m("strong",null,"Рекомендуемые форматы:",-1)),m("ul",La,[(s(!0),h(W,null,Y(I.recommended_formats,(gt,wt)=>(s(),h("li",{key:wt},g(gt),1))),128))])])):x("",!0)]))),128))])):u.recommendations_status==="pending"?(s(),v(ce,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):u.recommendations_status==="error"?(s(),v(ce,{key:2,title:ut(u),type:"error",closable:!1,"show-icon":""},null,8,["title"])):u.recommendations_status==="disabled"?(s(),v(ce,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(s(),v(ve,{key:4,description:"Нет данных","image-size":60}))])]),u.prof_activity_code?(s(),h("div",Va,[t(S,{type:"info",size:"small",onClick:I=>lt(u)},{default:e(()=>[t(A,null,{default:e(()=>[t(b(At))]),_:1}),n[23]||(n[23]=f(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t(S,{type:"primary",size:"small",onClick:I=>rt(u)},{default:e(()=>[t(A,null,{default:e(()=>[t(b(Ee))]),_:1}),n[24]||(n[24]=f(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):x("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):x("",!0),t(Re,{modelValue:y.value,"onUpdate:modelValue":n[5]||(n[5]=u=>y.value=u),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(S,{onClick:n[4]||(n[4]=u=>y.value=!1)},{default:e(()=>[...n[27]||(n[27]=[f(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",loading:$.value,onClick:Ye},{default:e(()=>[...n[28]||(n[28]=[f(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Le,{ref_key:"uploadFormRef",ref:C,model:Q,rules:ee,"label-position":"top"},{default:e(()=>[t(Ne,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(_t,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Qe,"file-list":P.value},{tip:e(()=>[...n[26]||(n[26]=[m("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(S,{type:"primary"},{default:e(()=>[...n[25]||(n[25]=[f(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Re,{modelValue:p.value,"onUpdate:modelValue":n[8]||(n[8]=u=>p.value=u),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(S,{onClick:n[7]||(n[7]=u=>p.value=!1)},{default:e(()=>[...n[29]||(n[29]=[f(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",loading:R.value,disabled:!q.activityCode||B.value.length===0,onClick:ot},{default:e(()=>[...n[30]||(n[30]=[f(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Le,{model:q,"label-position":"top"},{default:e(()=>[t(Ne,{label:"Профессиональная область",required:""},{default:e(()=>[fe((s(),v(yt,{modelValue:q.activityCode,"onUpdate:modelValue":n[6]||(n[6]=u=>q.activityCode=u),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(s(!0),h(W,null,Y(G.value,u=>(s(),v(vt,{key:u.code,label:u.name,value:u.code},{default:e(()=>[m("span",null,g(u.name),1),m("span",Ta,g(u.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Ce,T.value]])]),_:1}),t(ce,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),B.value.length===0?(s(),v(ce,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):x("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Re,{modelValue:l.value,"onUpdate:modelValue":n[9]||(n[9]=u=>l.value=u),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[K.value?(s(),v(Wt,{key:0,"report-id":K.value,onMetricsUpdated:nt},null,8,["report-id"])):x("",!0)]),_:1},8,["modelValue"])])),[[Ce,O.value]])]),_:1})}}},Ba=he(Ia,[["__scopeId","data-v-5c41a84c"]]);export{Ba as default};
